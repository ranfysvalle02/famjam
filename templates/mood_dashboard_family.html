{% extends "base.html" %}

{% block title %}Family Mood Overview - FAMJAM{% endblock %}

{% block content %}
<div class="space-y-8">
  <div class="text-center">
    <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100">Family Mood Overview</h1>
    <p class="text-lg text-gray-600 dark:text-gray-300 mt-2 leading-relaxed"> {# Added leading #}
        A look at the whole family's emotional well-being over the last 30 days.
    </p>
     <p class="mt-4 text-sm">
         <a href="{{ url_for('mood_dashboard_personal') }}" class="font-medium text-blue-600 dark:text-blue-400 hover:underline">
             &larr; Back to My Mood Tracker
         </a>
     </p>
  </div>

  {# Charts Grid #}
  <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
    {# Daily Average Chart #}
    <div class="lg:col-span-3 bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-xl hover-lift">
      <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-gray-100">Family Daily Average Mood</h3> {# Simplified title #}
      <div class="h-80 relative"> {# Added relative #}
        <canvas id="familyDailyAverageChart"></canvas>
      </div>
    </div>
    {# Distribution Chart #}
    <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-xl hover-lift">
      <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-gray-100">Overall Mood Distribution</h3> {# Simplified title #}
      <div class="h-80 flex items-center justify-center relative"> {# Added relative #}
        <canvas id="familyDistributionChart"></canvas>
      </div>
    </div>
  </div>
   {# Add note about privacy if desired #}
   <p class="text-center text-xs text-gray-500 dark:text-gray-400 mt-4">
       Note: Individual mood notes are kept private and are not shown in this family overview.
   </p>

</div>
{% endblock %}


{% block scripts %}
{# Page-specific JavaScript for Family Mood Charts #}
<script>
document.addEventListener('DOMContentLoaded', () => {
    let familyDailyChart, familyDistChart; // Chart instance variables
    // Ensure mood_config is passed for mapping scores/labels if needed by tooltips/axes
    const MOOD_CONFIG = {{ mood_config.moods | tojson | safe }};

    const familyDailyChartCanvas = document.getElementById('familyDailyAverageChart');
    const familyDistChartCanvas = document.getElementById('familyDistributionChart');

    if (familyDailyChartCanvas && familyDistChartCanvas) {
        const fetchFamilyData = async () => {
            const dailyCtx = familyDailyChartCanvas.getContext('2d');
            const distCtx = familyDistChartCanvas.getContext('2d');

            try {
                const response = await fetch('/api/mood/family'); // Ensure this endpoint exists
                if (!response.ok) throw new Error('Failed to fetch family mood data');
                const data = await response.json();

                 if (!data || !data.daily_average || !data.distribution) {
                     throw new Error("Family mood data is missing or malformed.");
                 }

                // Destroy previous instances if they exist
                if (familyDailyChart) familyDailyChart.destroy();
                if (familyDistChart) familyDistChart.destroy();

                 const chartTextColor = document.documentElement.classList.contains('dark') ? '#cbd5e1' : '#4b5563';
                 const chartGridColor = document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';

                // --- Daily Average Line Chart ---
                familyDailyChart = new Chart(dailyCtx, {
                    type: 'line',
                    data: {
                        labels: data.daily_average.labels, // Dates
                        datasets: [{
                            label: 'Family Average Daily Mood', // Score 0-4
                            data: data.daily_average.data,
                            borderColor: '#3b82f6', // Blue color
                            backgroundColor: 'rgba(59, 130, 246, 0.1)', // Light blue fill
                            tension: 0.3,
                            fill: true,
                            pointBackgroundColor: '#2563eb',
                            pointBorderColor: '#ffffff',
                            pointHoverBackgroundColor: '#ffffff',
                            pointHoverBorderColor: '#1d4ed8',
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 4, // Assuming mood score 0-4
                                ticks: {
                                      stepSize: 1,
                                      // Optional: Map score back to emoji/label
                                      callback: function(value) {
                                           const moodEntry = MOOD_CONFIG.find(m => m.score === value);
                                           return moodEntry ? `${moodEntry.emoji}` : value; // Show only emoji on axis
                                      },
                                      color: chartTextColor
                                },
                                grid: { color: chartGridColor }
                            },
                             x: {
                                  ticks: { color: chartTextColor },
                                  grid: { display: false }
                             }
                        },
                         plugins: {
                             legend: { display: false },
                             tooltip: {
                                 backgroundColor: document.documentElement.classList.contains('dark') ? '#374151' : '#ffffff',
                                 titleColor: document.documentElement.classList.contains('dark') ? '#f3f4f6' : '#1f2937',
                                 bodyColor: document.documentElement.classList.contains('dark') ? '#d1d5db' : '#4b5563',
                                 borderColor: document.documentElement.classList.contains('dark') ? '#4b5563' : '#e5e7eb',
                                 borderWidth: 1,
                                 padding: 10,
                                 cornerRadius: 4,
                                 // Custom tooltip
                                 callbacks: {
                                      label: function(context) {
                                           let label = 'Avg Mood: ';
                                           if (context.parsed.y !== null) {
                                                const score = context.parsed.y;
                                                const moodEntry = MOOD_CONFIG.find(m => m.score === Math.round(score)); // Find closest score entry
                                                label += moodEntry ? `${moodEntry.emoji} (${score.toFixed(1)})` : score.toFixed(1);
                                           }
                                           return label;
                                      }
                                 }
                             }
                         },
                         interaction: { intersect: false, mode: 'index' }
                    }
                });

                // --- Distribution Doughnut Chart ---
                familyDistChart = new Chart(distCtx, {
                    type: 'doughnut',
                    data: {
                        labels: data.distribution.labels, // Mood descriptions (e.g., "Happy", "Okay")
                        datasets: [{
                            label: 'Mood Distribution',
                            data: data.distribution.data, // Counts for each mood
                            backgroundColor: data.distribution.colors, // Colors passed from backend
                            borderColor: document.documentElement.classList.contains('dark') ? '#4b5568' : '#ffffff', // Add border
                            borderWidth: 2,
                            hoverOffset: 8 // Pop out segment on hover
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                             legend: {
                                  position: 'bottom', // Move legend below
                                  labels: {
                                       color: chartTextColor,
                                       padding: 15 // Add padding to legend items
                                  }
                             },
                             tooltip: {
                                 backgroundColor: document.documentElement.classList.contains('dark') ? '#374151' : '#ffffff',
                                 titleColor: document.documentElement.classList.contains('dark') ? '#f3f4f6' : '#1f2937',
                                 bodyColor: document.documentElement.classList.contains('dark') ? '#d1d5db' : '#4b5563',
                                 borderColor: document.documentElement.classList.contains('dark') ? '#4b5563' : '#e5e7eb',
                                 borderWidth: 1,
                                 padding: 10,
                                 cornerRadius: 4,
                                  callbacks: {
                                       label: function(context) {
                                            let label = context.label || '';
                                            if (label) { label += ': '; }
                                            if (context.parsed !== null) {
                                                 // Calculate percentage
                                                 const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                                 const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) + '%' : '0%';
                                                 label += `${context.parsed} (${percentage})`;
                                            }
                                            return label;
                                       }
                                  }
                             }
                        }
                    }
                });

            } catch (error) {
                console.error("Error fetching or rendering family mood charts:", error);
                if (familyDailyChartCanvas && familyDailyChartCanvas.parentElement) {
                     familyDailyChartCanvas.parentElement.innerHTML = '<p class="text-center text-red-500 dark:text-red-400 py-10">Could not load daily average chart.</p>';
                }
                 if (familyDistChartCanvas && familyDistChartCanvas.parentElement) {
                     familyDistChartCanvas.parentElement.innerHTML = '<p class="text-center text-red-500 dark:text-red-400 py-10">Could not load distribution chart.</p>';
                }
            }
        };

        // Initial fetch and render
        fetchFamilyData();

        // Optional: Refetch data if dark mode changes, as chart colors might adapt
        const darkModeToggle = document.getElementById("darkModeToggle");
         if (darkModeToggle) {
             darkModeToggle.addEventListener("click", () => {
                 // Delay refetch slightly to allow theme update
                 setTimeout(fetchFamilyData, 150);
             });
         }
    } else {
         console.error("Required chart canvas elements not found.");
    }
});
</script>
{% endblock %}