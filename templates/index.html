<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FAMJAM by OBLIVIO - Family Chore & Habit Management</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Bitcount+Single+Ink:wght@100..900&display=swap" rel="stylesheet"/>
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              '50':  '#eff6ff','100': '#dbeafe','200': '#bfdbfe','300': '#93c5fd','400': '#60a5fa',
              '500': '#3b82f6','600': '#2563eb','700': '#1d4ed8','800': '#1e40af','900': '#1e3a8a'
            },
            secondary: {
              '50':  '#fdf2f8','100': '#fce7f3','200': '#fbcfe8','300': '#f9a8d4','400': '#f472b6',
              '500': '#ec4899','600': '#db2777','700': '#be185d','800': '#9d174d','900': '#831843'
            }
          }
        }
      }
    }
  </script>
  
  <style>
    /* Animated gradient background */
    @keyframes gradientFlow {
      0%   { background-position: 0% 50%; }
      50%  { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    body {
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      transition: background-color 0.3s, color 0.3s;
    }
    #body {
      background: linear-gradient(-45deg, #f0f9ff, #fdf2f8, #f5f5f5, #ecfdf5, #fff5e6, #fce2e9);
      background-size: 800% 800%;
      animation: gradientFlow 20s cubic-bezier(0.4, 0, 0.2, 1) infinite;
    }
    .dark #body {
      background: linear-gradient(45deg, #1f2937, #2d3748, #4a5568, #2d3748, #1f2937);
      background-size: 800% 800%;
      animation: gradientFlow 20s cubic-bezier(0.4, 0, 0.2, 1) infinite;
    }
    .gradient-text {
      background: linear-gradient(to right, #4f46e5, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 1px 1px rgba(0,0,0,.25);
    }
    .dark .gradient-text {
      text-shadow: 0 1px 1px rgba(255,255,255,.2);
    }
    .font-brand {
      font-family: "Bitcount Single Ink", system-ui;
      font-weight: 800;
      font-style: normal;
    }
    /* Logo pulse/flow animation */
    @keyframes logoFlow {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    #logo-animated {
      animation: logoFlow 3s infinite;
    }
    /* FullCalendar buttons */
    .fc .fc-button-primary {
      background-color: #2563eb; border-color: #2563eb; transition: background-color 0.2s;
    }
    .fc .fc-button-primary:hover {
      background-color: #1d4ed8; border-color: #1d4ed8;
    }
    .fc .fc-daygrid-day.fc-day-today {
      background-color: rgba(59, 130, 246, 0.08);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.5s ease-in-out forwards;
    }
    @keyframes scaleUp {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .modal-content {
      animation: scaleUp 0.3s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
    }
    /* custom scrollbars */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    .dark .custom-scrollbar::-webkit-scrollbar-track {
      background: #2d3748;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 10px;
    }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #4a5568;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #718096;
    }
    .hover-lift:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    #particle-container {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      overflow: hidden;
      z-index: -1;
    }
    .particle {
      position: absolute;
      border-radius: 50%;
      animation: floatUp 25s linear infinite;
    }
    @keyframes floatUp {
      0% { transform: translateY(0); }
      100% { transform: translateY(-200vh); }
    }
    .mood-grid-cell {
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .mood-grid-cell.selected {
      transform: scale(1.1);
      box-shadow: 0 0 0 3px #3b82f6;
      z-index: 10;
    }
    .prose-styles h1, .prose-styles h2, .prose-styles p, .prose-styles ul, .prose-styles strong {
      color: inherit;
    }
    @keyframes fabFlow {
      0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); }
      70% { box-shadow: 0 0 0 12px rgba(37, 99, 235, 0); }
      100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
    }
    .fab-flow {
      animation: fabFlow 2s infinite;
    }
    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .side-modal.is-open .modal-content-item {
      animation: slideInUp 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
    }
    .side-modal [data-modal-overlay] {
      opacity: 0;
      transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .side-modal.is-open [data-modal-overlay] {
      opacity: 1;
    }
    .side-modal [data-modal-panel] {
      transition: transform 0.6s cubic-bezier(0.68, -0.6, 0.32, 1.6);
    }
    .side-modal.is-open [data-modal-panel] {
      transform: translateX(0) !important;
    }

  tr.fc-list-event:hover {
    background-color: transparent !important; /* Removes any background color change */
  }
  /* Add this new, correct rule in its place */
  .fc .fc-list-event:hover td {
    background-color: transparent !important;
    cursor: pointer;
  }

  .fc-scrollgrid-sync-inner{
    color: black !important;
  }
  .fc-list-day{
    color: black !important;
  }
  html.dark .fc-daygrid-day-number{
    color: white !important;
  }
  </style>
</head>

<body class="text-gray-800 antialiased relative transition-colors duration-300 dark:text-gray-200" id="body">
  <div id="particle-container"></div>
  
  <nav class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md shadow-sm sticky top-0 z-50 transition-colors duration-300">
    <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center space-x-8">
          <a href="{{ url_for('index') }}" class="flex items-center space-x-2 text-3xl font-brand">
            <svg id="logo-animated" class="w-8 h-8" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
              <style>
    @keyframes rotate_outer {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @keyframes rotate_inner {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(-360deg); }
    }
    @keyframes dash_flow {
      0% { stroke-dashoffset: 1000; }
      100% { stroke-dashoffset: 0; }
    }
    @keyframes color_shift {
      0% { stop-color: #818cf8; }
      33% { stop-color: #60a5fa; }
      66% { stop-color: #34d399; }
      100% { stop-color: #818cf8; }
    }
    @keyframes color_shift2 {
      0% { stop-color: #f472b6; }
      33% { stop-color: #c084fc; }
      66% { stop-color: #fb923c; }
      100% { stop-color: #f472b6; }
    }
    .logo-group-outer {
      animation: rotate_outer 12s linear infinite;
      transform-origin: center;
    }
    .logo-group-inner {
      animation: rotate_inner 10s linear infinite;
      transform-origin: center;
    }
    .logo-path {
      stroke-dasharray: 500;
      animation: dash_flow 8s ease-in-out infinite alternate;
    }
    #stop1 {
      animation: color_shift 6s linear infinite;
    }
    #stop2 {
      animation: color_shift2 6s linear infinite;
    }

.event-strikethrough {
  text-decoration: line-through;
  opacity: 0.7;
}
              </style>
              <defs>
                <linearGradient id="fluidGradient" gradientTransform="rotate(45)">
                  <stop id="stop1" offset="0%" />
                  <stop id="stop2" offset="100%" />
                </linearGradient>
                <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                  <feGaussianBlur stdDeviation="2.5" result="coloredBlur" />
                  <feMerge>
                    <feMergeNode in="coloredBlur" />
                    <feMergeNode in="SourceGraphic" />
                  </feMerge>
                </filter>
              </defs>
              <circle cx="32" cy="32" r="30" fill="url(#fluidGradient)" fill-opacity="0.1" />
              <g filter="url(#glow)" opacity="0.9">
                <g class="logo-group-outer">
                  <path class="logo-path"
                  d="M 52 24 C 40 12, 24 12, 12 24 C 0 36, 0 40, 12 52 C 24 64, 40 64, 52 52 C 64 40, 64 36, 52 24 Z"
                  fill="none" stroke="url(#fluidGradient)" stroke-width="3.5" stroke-linecap="round" />
                </g>
                <g class="logo-group-inner">
                  <path class="logo-path"
                  d="M 24 12 C 36 0, 40 0, 52 12 C 64 24, 64 40, 52 52 C 40 64, 24 64, 12 52 C 0 40, 0 24, 12 12"
                  fill="none" stroke="url(#fluidGradient)" stroke-width="2" stroke-linecap="round" style="animation-delay: -4s;" />
                </g>
              </g>
            </svg>
            <span class="gradient-text">FAMJAM</span>
          </a>
        </div>
      
        <div class="hidden sm:flex items-center space-x-2">
          {% if current_user.is_authenticated %}
            <div class="flex items-center space-x-1 bg-gray-100 dark:bg-gray-700 rounded-full p-1">
              <a href="{{ url_for('family_dashboard') }}"
                 class="px-3 py-1 text-sm font-medium rounded-full transition-colors
                 {% if 'family_dashboard' in request.endpoint %} bg-white dark:bg-gray-600 text-gray-800 dark:text-gray-100 shadow-sm
                 {% else %} text-gray-600 dark:text-gray-200 hover:text-gray-900 dark:hover:text-white {% endif %}">
              Family Hub
            </a>
              <a href="{{ url_for('personal_dashboard') }}"
                 class="px-3 py-1 text-sm font-medium rounded-full transition-colors
                 {% if request.endpoint=='personal_dashboard' %} bg-white dark:bg-gray-600 text-gray-800 dark:text-gray-100 shadow-sm
                 {% else %} text-gray-600 dark:text-gray-200 hover:text-gray-900 dark:hover:text-white {% endif %}">
                {% if current_user.role == 'parent' %}Manage Tasks{% else %}My Day{% endif %}
            </a>
              <a href="{{ url_for('calendar_focus') }}"
                 class="px-3 py-1 text-sm font-medium rounded-full transition-colors
                 {% if request.endpoint=='calendar_focus' %} bg-white dark:bg-gray-600 text-gray-800 dark:text-gray-100 shadow-sm
                 {% else %} text-gray-600 dark:text-gray-200 hover:text-gray-900 dark:hover:text-white {% endif %}">
              Calendar
            </a>
              <a href="{{ url_for('mood_dashboard_personal') }}"
                 class="px-3 py-1 text-sm font-medium rounded-full transition-colors
                 {% if 'mood_dashboard' in request.endpoint %} bg-white dark:bg-gray-600 text-gray-800 dark:text-gray-100 shadow-sm
                 {% else %} text-gray-600 dark:text-gray-200 hover:text-gray-900 dark:hover:text-white {% endif %}">
              Mood Tracker
            </a>
            </div>
            <div class="flex items-center space-x-4 ml-4">
              <a href="{{ url_for('logout') }}"
                 class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-full hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition shadow-sm">
              Log Out
            </a>
            </div>
          {% else %}
            <a href="{{ url_for('login') }}"
               class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition">
            Log In
          </a>
            <a href="{{ url_for('register_parent') }}"
               class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-full hover:bg-blue-700 transition shadow-sm">
            Register
          </a>
          {% endif %}
        </div>
      
        <div class="flex items-center space-x-3">
          <button id="darkModeToggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition flex items-center space-x-2">
            <svg id="themeIconSun" class="hidden w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 3v2M12 19v2M8.22 8.22l1.42 1.42M14.36 14.36l1.42 1.42M3 12h2M19 12h2M8.22 15.78l1.42-1.42M14.36 9.64l1.42-1.42M12 7a5 5 0 010 10 5 5 0 010-10z"/>
            </svg>
            <svg id="themeIconMoon" class="hidden w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
              d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
            </svg>
            <span id="themeIconText" class="text-gray-600 dark:text-gray-300 text-sm font-semibold"></span>
          </button>
          <button id="mobile-menu-button" class="p-2 rounded-md text-gray-600 dark:text-gray-300 sm:hidden">
            <svg class="h-6 w-6" stroke="currentColor" fill="none" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <div id="mobileMenu" class="side-modal fixed inset-0 z-[70] hidden">
    <div data-modal-overlay onclick="closeModal('mobileMenu')" class="absolute inset-0 bg-gray-900/60 dark:bg-black/80"></div>
    <div data-modal-panel data-side="left"
         class="absolute top-0 left-0 h-full w-full max-w-xs bg-white dark:bg-gray-800 shadow-2xl transform -translate-x-full panel-transition">
      <div class="p-6">
        <div class="flex items-center justify-between mb-8">
          <svg id="logo-animated" class="w-8 h-8" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
            <style>
  @keyframes rotate_outer {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  @keyframes rotate_inner {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(-360deg); }
  }
  @keyframes dash_flow {
    0% { stroke-dashoffset: 1000; }
    100% { stroke-dashoffset: 0; }
  }
  @keyframes color_shift {
    0% { stop-color: #818cf8; }
    33% { stop-color: #60a5fa; }
    66% { stop-color: #34d399; }
    100% { stop-color: #818cf8; }
  }
  @keyframes color_shift2 {
    0% { stop-color: #f472b6; }
    33% { stop-color: #c084fc; }
    66% { stop-color: #fb923c; }
    100% { stop-color: #f472b6; }
  }
  .logo-group-outer {
    animation: rotate_outer 12s linear infinite;
    transform-origin: center;
  }
  .logo-group-inner {
    animation: rotate_inner 10s linear infinite;
    transform-origin: center;
  }
  .logo-path {
    stroke-dasharray: 500;
    animation: dash_flow 8s ease-in-out infinite alternate;
  }
  #stop1 {
    animation: color_shift 6s linear infinite;
  }
  #stop2 {
    animation: color_shift2 6s linear infinite;
  }

            </style>
            <defs>
              <linearGradient id="fluidGradient" gradientTransform="rotate(45)">
                <stop id="stop1" offset="0%" />
                <stop id="stop2" offset="100%" />
              </linearGradient>
              <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur stdDeviation="2.5" result="coloredBlur" />
                <feMerge>
                  <feMergeNode in="coloredBlur" />
                  <feMergeNode in="SourceGraphic" />
                </feMerge>
              </filter>
            </defs>
            <circle cx="32" cy="32" r="30" fill="url(#fluidGradient)" fill-opacity="0.1" />
            <g filter="url(#glow)" opacity="0.9">
              <g class="logo-group-outer">
                <path class="logo-path"
                d="M 52 24 C 40 12, 24 12, 12 24 C 0 36, 0 40, 12 52 C 24 64, 40 64, 52 52 C 64 40, 64 36, 52 24 Z"
                fill="none" stroke="url(#fluidGradient)" stroke-width="3.5" stroke-linecap="round" />
              </g>
              <g class="logo-group-inner">
                <path class="logo-path"
                d="M 24 12 C 36 0, 40 0, 52 12 C 64 24, 64 40, 52 52 C 40 64, 24 64, 12 52 C 0 40, 0 24, 12 12"
                fill="none" stroke="url(#fluidGradient)" stroke-width="2" stroke-linecap="round" style="animation-delay: -4s;" />
              </g>
            </g>
          </svg>
          <span class="text-2xl font-brand gradient-text">FAMJAM</span>
          <button onclick="closeModal('mobileMenu')" class="p-2 rounded-full text-gray-400 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <div class="space-y-2">
          {% if current_user.is_authenticated %}
            <a href="{{ url_for('family_dashboard') }}" onclick="closeModal('mobileMenu') }}"
               class="block px-3 py-3 rounded-md text-lg font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
             Family Hub
            </a>
            <a href="{{ url_for('personal_dashboard') }}" onclick="closeModal('mobileMenu') }}"
               class="block px-3 py-3 rounded-md text-lg font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
              {% if current_user.role == 'parent' %}Manage Tasks{% else %}My Day{% endif %}
            </a>
            <a href="{{ url_for('calendar_focus') }}" onclick="closeModal('mobileMenu') }}"
               class="block px-3 py-3 rounded-md text-lg font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
              Calendar
            </a>
            <a href="{{ url_for('mood_dashboard_personal') }}" onclick="closeModal('mobileMenu') }}"
               class="block px-3 py-3 rounded-md text-lg font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
              Mood Tracker
            </a>
            <a href="{{ url_for('logout') }}" onclick="closeModal('mobileMenu') }}"
               class="block px-3 py-3 rounded-md text-lg font-medium text-blue-600 hover:bg-gray-100 dark:hover:bg-gray-700">
              Log Out
            </a>
          {% else %}
            <a href="{{ url_for('login') }}" onclick="closeModal('mobileMenu') }}"
               class="block px-3 py-3 rounded-md text-lg font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
              Log In
            </a>
            <a href="{{ url_for('register_parent') }}" onclick="closeModal('mobileMenu') }}"
               class="block px-3 py-3 rounded-md text-lg font-medium text-white bg-blue-600 hover:bg-blue-700">
              Register
            </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  
  <main class="max-w-screen-xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="p-4 mb-6 text-sm rounded-lg shadow-md
          {% if category == 'error' %}
            bg-red-100 text-red-800 border border-red-200 dark:bg-red-200 dark:text-red-900
          {% else %}
            bg-green-100 text-green-800 border border-green-200 dark:bg-green-200 dark:text-green-900
          {% endif %}"
          role="alert">
          <span class="font-medium">{{ message }}</span>
        </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    
    <div class="fade-in">
      {% if page == 'login' %}
      <div class="flex items-center justify-center min-h-[calc(100vh-250px)]">
        <div class="w-full max-w-md p-8 space-y-6 bg-white dark:bg-gray-800 rounded-2xl shadow-xl hover-lift">
          <div class="text-center">
            <h1 class="text-4xl font-extrabold gradient-text font-brand">Welcome Back</h1>
            <p class="mt-2 text-gray-600 dark:text-gray-200">Log in to manage your family's tasks.</p>
          </div>
          <form method="POST" action="{{ url_for('login') }}" class="space-y-6">
            <div>
              <label for="email_or_username" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Email or Username</label>
              <input type="text" name="email_or_username" id="email_or_username" required
                       class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 dark:text-gray-100
                             border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm
                             focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition"/>
            </div>
            <div>
              <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Password</label>
              <input type="password" name="password" id="password" required
                       class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 dark:text-gray-100
                             border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm
                             focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition"/>
            </div>
            <button type="submit"
                    class="w-full py-3 px-4 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700
                           focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500
                           transition-transform transform hover:scale-105 shadow-lg">
            Log In
          </button>
          </form>
          <p class="text-center text-sm text-gray-600 dark:text-gray-200 mt-2">
          Don't have an account?
          <a href="{{ url_for('register_parent') }}" class="font-medium text-blue-600 dark:text-blue-400 hover:text-blue-500 dark:hover:text-blue-300">
            Register as a Parent
          </a>
        </p>
        </div>
      </div>
      
      {% elif page == 'register_parent' %}
      <div class="flex items-center justify-center min-h-[calc(100vh-250px)]">
        <div class="w-full max-w-md p-8 space-y-6 bg-white dark:bg-gray-800 rounded-2xl shadow-xl hover-lift">
          <div class="text-center">
            <h1 class="text-4xl font-extrabold gradient-text font-brand">Create Your Family Hub</h1>
            <p class="mt-2 text-gray-600 dark:text-gray-200">Start by creating a parent account.</p>
          </div>
          <form method="POST" action="{{ url_for('register_parent') }}" class="space-y-6">
            <div>
              <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Your Name / Username</label>
              <div class="relative mt-1">
                <input type="text" name="username" id="username" required
                           class="block w-full px-4 py-3 pr-24 bg-gray-50 dark:bg-gray-700 dark:text-gray-100
                                  border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm
                                  focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition"/>
                <button type="button" id="suggest-username-btn"
                        class="absolute inset-y-0 right-0 flex items-center px-3 text-sm font-semibold text-blue-600
                               hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
                Suggest
              </button>
              </div>
              <div id="username-suggestions" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Email Address</label>
              <input type="email" name="email" id="email" required
                       class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 dark:text-gray-100
                             border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm
                             focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition"/>
            </div>
            <div>
              <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Password</label>
              <input type="password" name="password" id="password" required
                       class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 dark:text-gray-100
                             border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm
                             focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition"/>
            </div>
            <button type="submit"
                    class="w-full py-3 px-4 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700
                           focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500
                           transition-transform transform hover:scale-105 shadow-lg">
            Create Account
          </button>
          </form>
          <p class="text-center text-sm text-gray-600 dark:text-gray-200 mt-2">
          Already have an account?
          <a href="{{ url_for('login') }}" class="font-medium text-blue-600 dark:text-blue-400 hover:text-blue-500 dark:hover:text-blue-300">
            Log In
          </a>
        </p>
        </div>
      </div>
      
      {% elif page == 'join_family' %}
      <div class="flex items-center justify-center min-h-[calc(100vh-250px)]">
        <div class="w-full max-w-md p-8 sm:p-12 space-y-6 bg-white dark:bg-gray-800 rounded-2xl shadow-xl text-center hover-lift">
          <div class="mx-auto bg-blue-100 dark:bg-blue-900 h-16 w-16 rounded-full flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600 dark:text-blue-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.085a2 2 0 00-1.736.97l-1.908 4.293M7 20l-1.5-1.5a2 2 0 010-2.828l3-3a2 2 0 012.828 0l1.5 1.5M7 20h2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <h1 class="text-3xl font-extrabold gradient-text font-brand">You're Invited!</h1>
          <p class="text-gray-600 dark:text-gray-300 text-lg">
            You have been invited to join the family hub for<br/>
            <strong class="text-xl text-gray-800 dark:text-gray-100">{{ parent_name }}</strong>.
          </p>
          <a href="{{ url_for('register_child', invite_code=invite_code) }}"
             class="inline-block w-full py-3 px-4 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700
                   focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 shadow-lg">
          Accept & Create Account
        </a>
        </div>
      </div>
      
      {% elif page == 'register_child' %}
      <div class="flex items-center justify-center min-h-[calc(100vh-250px)]">
        <div class="w-full max-w-md p-8 space-y-6 bg-white dark:bg-gray-800 rounded-2xl shadow-xl hover-lift">
          <div class="text-center">
            <h1 class="text-4xl font-extrabold gradient-text font-brand">Join Your Family!</h1>
            <p class="mt-2 text-gray-600 dark:text-gray-200">Create a username and password to get started.</p>
          </div>
          <form method="POST" action="{{ url_for('register_child', invite_code=invite_code) }}" class="space-y-6">
            <div>
              <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Username</label>
              <div class="relative mt-1">
                <input type="text" name="username" id="username" required
                           class="block w-full px-4 py-3 pr-24 bg-gray-50 dark:bg-gray-700 dark:text-gray-100
                                  border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm
                                  focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition"/>
                <button type="button" id="suggest-username-btn"
                        class="absolute inset-y-0 right-0 flex items-center px-3 text-sm font-semibold text-blue-600
                               hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
                Suggest
              </button>
              </div>
              <div id="username-suggestions" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
            <div>
              <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Password</label>
              <input type="password" name="password" id="password" required
                       class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 dark:text-gray-100
                             border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm
                             focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition"/>
            </div>
            <button type="submit"
                    class="w-full py-3 px-4 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700
                           focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500
                           transition-transform transform hover:scale-105 shadow-lg">
            Join Family
          </button>
          </form>
        </div>
      </div>
      
      {% elif page == 'invite' %}
      <div class="bg-white dark:bg-gray-800 p-8 sm:p-12 rounded-2xl shadow-xl text-center max-w-lg mx-auto hover-lift">
        <div class="mx-auto bg-blue-100 dark:bg-blue-900 h-16 w-16 rounded-full flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600 dark:text-blue-300"
               fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857
                       M7 20l-1.5-1.5a2 2 0 010-2.828l3-3a2 2 0 012.828 0l1.5 1.5M7 20h2"/>
          </svg>
        </div>
        <h2 class="text-3xl font-extrabold mt-4 text-gray-900 dark:text-gray-100">Invite Your Family</h2>
        <p class="text-gray-600 dark:text-gray-300 mt-2 mb-8">
          Share this magic link or QR code so your child can join your family hub.
        </p>
        <div class="mb-8">
          <label class="text-sm font-medium text-gray-700 dark:text-gray-200">Your Magic Invite Link</label>
          <div class="relative mt-2">
            <input readonly type="text" id="invite-url-input" value="{{ invite_url }}"
                   class="block w-full p-4 pr-12 bg-gray-100 dark:bg-gray-700 rounded-lg border-0
                         focus:ring-2 focus:ring-blue-500 font-mono text-sm text-gray-700 dark:text-gray-200 break-all">
            <button id="copy-button" class="absolute inset-y-0 right-0 flex items-center pr-3" title="Copy link">
              <svg id="copy-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600 dark:text-gray-200"
                   viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8
                         a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8
                         a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
              </svg>
              <svg id="check-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600 dark:text-green-300 hidden"
                   viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
              </svg>
            </button>
          </div>
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700 dark:text-gray-200">Or Scan with a Phone Camera</label>
          <img src="{{ url_for('qr_code') }}" alt="Invite QR Code"
               class="mx-auto border-4 dark:border-gray-600 mt-2 p-2 rounded-lg bg-white dark:bg-gray-300"/>
        </div>
      </div>
      
      {% elif page == 'dashboard_parent' %}
      <div class="space-y-8">

            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl">
                <h3 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100">FamJam Plan Management</h3>
                <p class="text-gray-600 dark:text-gray-300 mb-6">View, edit, or delete tasks from your active plan, or generate a brand new AI-powered plan for the upcoming quarter.</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <a href="{{ url_for('manage_plan') }}" class="flex-1 text-center px-6 py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                        Manage Active Plan
                    </a>
                    <button onclick="openFamJamModal()" class="flex-1 px-6 py-3 font-semibold text-white bg-secondary-500 rounded-lg hover:bg-secondary-600 transition shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                        Generate New AI Plan
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-xl space-y-6">
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100">Assign a New Task</h2>
                    <form method="POST" action="{{ url_for('create_event') }}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Task Name</label>
                                <input type="text" name="name" placeholder="e.g. Clean your room" class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 dark:text-gray-100 border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500" required />
                            </div>
                            <div>
                                <label for="type" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Type</label>
                                <select name="type" class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 dark:text-gray-100 border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                    <option value="chore">Chore</option>
                                    <option value="habit">Habit</option>
                                </select>
                            </div>
                            <div>
                                <label for="points" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Points Value</label>
                                <input type="number" name="points" min="1" placeholder="e.g. 50" class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 dark:text-gray-100 border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500" required />
                            </div>
                            <div>
                                <label for="assigned_to" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Assign To</label>
                                <select name="assigned_to" class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 dark:text-gray-100 border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                                    <option value="">Select a child...</option>
                                    <option value="__ALL__">All Children</option>
                                    <option value="__ROUND_ROBIN__">Round Robin</option>
                                    {% for member in family_members if member.role == 'child' %}
                                    <option value="{{ member._id }}">{{ member.username }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label for="recurrence" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Recurrence</label>
                                <select name="recurrence" class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 dark:text-gray-100 border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                    <option value="none">Does not repeat</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label for="due_date" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Start/Due Date</label>
                                <input type="date" name="due_date" class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 dark:text-gray-100 border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500" required />
                            </div>
                        </div>
                        <button type="submit" class="w-full md:w-auto mt-8 py-3 px-8 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 shadow-lg">
                            Add Task
                        </button>
                    </form>
                </div>

                <div class="lg:col-span-1 space-y-8">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl space-y-4">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100">This Week's Stats</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <span class="font-medium text-gray-600 dark:text-gray-300">Total Points Assigned</span>
                                <span class="font-bold text-lg text-blue-600 dark:text-blue-400">{{ weekly_stats.total_points_assigned }} pts</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <span class="font-medium text-gray-600 dark:text-gray-300">Tasks Pending Approval</span>
                                <span class="font-bold text-lg text-yellow-600 dark:text-yellow-400">{{ pending_events|length }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100">Pending Task Approvals</h3>
                            {% if pending_events %}
                            <button id="approve-all-btn" class="px-3 py-1 text-xs font-semibold text-white bg-green-600 rounded-full hover:bg-green-700 transition">
                                Approve All
                            </button>
                            {% endif %}
                        </div>
                        <div id="pending-approvals-container">
                            {% if pending_events %}
                            <div class="space-y-4 max-h-60 overflow-y-auto custom-scrollbar pr-2">
                                {% for event in pending_events %}
                                <div data-event-id="{{ event._id }}" class="pending-event-item flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg hover:shadow-md transition-shadow">
                                    <div>
                                        <p class="font-semibold text-gray-800 dark:text-gray-100">{{ event.name }}</p>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">
                                            by <span class="font-medium">{{ member_map.get(event.assigned_to|string, 'Unknown') }}</span>
                                            <span class="font-bold text-green-600 dark:text-green-400">{{ event.points }} pts</span>
                                        </p>
                                    </div>
                                    <a href="{{ url_for('approve_event', event_id=event._id) }}" class="p-2 text-white bg-green-500 rounded-full hover:bg-green-600 transition-transform transform hover:scale-110" title="Approve this task">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                        </svg>
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="text-center py-8 text-gray-500 dark:text-gray-400">No tasks are pending approval.</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl">
                        <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-gray-100">Pending Reward Requests</h3>
                        <div class="space-y-4 max-h-60 overflow-y-auto custom-scrollbar pr-2">
                            {% if pending_rewards %}
                                {% for req in pending_rewards %}
                                    <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                                        <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                                            <div>
                                                <p class="font-semibold text-gray-800 dark:text-gray-100">{{ req.reward_name }}</p>
                                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                                    Requested by <span class="font-medium">{{ req.username }}</span>
                                                    <span class="font-bold text-yellow-600 dark:text-yellow-400">{{ req.cost }} pts</span>
                                                </p>
                                            </div>
                                            <form action="{{ url_for('resolve_reward_request', request_id=req._id) }}" method="POST" class="flex items-center gap-2 mt-3 sm:mt-0">
                                                <button type="submit" name="action" value="approve" class="px-3 py-1 text-xs font-semibold text-white bg-green-500 rounded-full hover:bg-green-600 transition">Approve</button>
                                                <button type="submit" name="action" value="deny" class="px-3 py-1 text-xs font-semibold text-gray-700 bg-gray-200 rounded-full hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500 transition">Deny</button>
                                            </form>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-center py-8 text-gray-500 dark:text-gray-300">No reward requests are pending.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl">
                <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Manage Reward Store</h3>
                    <button id="suggest-rewards-btn" class="flex-shrink-0 w-full md:w-auto flex items-center justify-center gap-2 px-5 py-2.5 text-sm font-semibold text-white bg-secondary-500 rounded-lg hover:bg-secondary-600 transition shadow">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.538.921l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.783.57-1.838-.197-1.538-.921l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                        Get Reward Ideas with AI
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1">
                        <form action="{{ url_for('add_store_reward') }}" method="POST" class="space-y-4 p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                            <h4 class="font-semibold">Add a New Reward</h4>
                                <div>
                                    <label for="reward-name" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Reward Name</label>
                                    <input type="text" name="name" id="reward-name" required class="mt-1 block w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600">
                                </div>
                                <div>
                                    <label for="reward-cost" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Point Cost</label>
                                    <input type="number" name="cost" id="reward-cost" min="1" required class="mt-1 block w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600">
                                </div>
                                <button type="submit" class="w-full py-2.5 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 transition">Add to Store</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2">
                        <h4 class="font-semibold mb-4">Available Rewards</h4>
                            <div class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar pr-2">
                                {% for reward in available_rewards %}
                                    <div class="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg flex justify-between items-center">
                                        <div>
                                            <p class="font-semibold text-gray-800 dark:text-gray-100">{{ reward.name }}</p>
                                            <p class="text-sm text-secondary-600 dark:text-secondary-400 font-bold">{{ reward.cost }} pts</p>
                                        </div>
                                        <a href="{{ url_for('delete_store_reward', reward_id=reward._id) }}" onclick="return confirm('Are you sure you want to delete this reward from the store?')" class="p-2 text-red-500 bg-red-100 dark:bg-red-900/50 rounded-full hover:bg-red-200 dark:hover:bg-red-800 transition" title="Delete Reward">
                                            <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                        </a>
                                    </div>
                                {% else %}
                                    <p class="text-center py-8 text-gray-500 dark:text-gray-300">Your reward store is empty. Add a reward to get started!</p>
                                {% endfor %}
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="child-day-modal" class="fixed inset-0 z-[80] flex items-center justify-center bg-black bg-opacity-60 hidden p-4">
            <div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-2xl mx-auto flex flex-col" style="max-height: 90vh;">
                <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                    <h3 id="child-day-modal-title" class="text-2xl font-bold text-gray-900 dark:text-gray-100">Child's Day View</h3>
                    <button onclick="closeModal('child-day-modal')" class="p-2 rounded-full text-gray-400 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div id="child-day-modal-content" class="p-6 overflow-y-auto custom-scrollbar">
                    </div>
            </div>
        </div>
      
      {% elif page == 'dashboard_child' %}
      <div class="space-y-8">

          <div class="relative bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl shadow-xl p-8 text-white overflow-hidden">
              <div class="relative z-10">
                  <h1 class="text-4xl font-bold">Welcome, {{ current_user.username }}!</h1>
                  <p class="mt-2 text-lg text-blue-200">Here's what's on your plate for today.</p>
              </div>
              <div class="absolute top-0 right-0 z-10 p-6 text-right">
                  <p class="text-sm font-medium text-blue-200">My Points</p>
                  <p class="text-5xl font-extrabold tracking-tight">{{ current_user.points }}</p>
              </div>
              <div class="absolute -bottom-12 -right-12 w-48 h-48 bg-white/10 rounded-full"></div>
              <div class="absolute -bottom-4 -left-16 w-32 h-32 bg-white/10 rounded-full"></div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

              <div class="lg:col-span-2 space-y-8">
                  
                  {% set total_tasks = todays_events|length %}
                  {% set completed_tasks = todays_events|selectattr('status', 'in', ['completed', 'approved'])|list|length %}
                  {% if total_tasks > 0 %}
                      {% set progress_percent = (completed_tasks / total_tasks * 100)|round|int %}
                  {% else %}
                      {% set progress_percent = 100 %}
                  {% endif %}
                  <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl">
                      <h3 class="font-bold text-xl text-gray-900 dark:text-gray-100">Today's Progress</h3>
                      <div class="flex items-center gap-4 mt-3">
                          <div class="w-full bg-gray-200 rounded-full h-4 dark:bg-gray-700">
                              <div class="bg-green-500 h-4 rounded-full transition-all duration-500" style="width: {{ progress_percent }}%"></div>
                          </div>
                          <span class="font-semibold text-gray-700 dark:text-gray-200">{{ completed_tasks }}/{{ total_tasks }}</span>
                      </div>
                  </div>

                  <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl">
                      <h2 class="text-2xl font-bold mb-4 flex items-center gap-3 text-gray-900 dark:text-gray-100">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                          Today's Focus
                      </h2>
                      <div class="space-y-4">
                          {% if todays_events %}
                              {% for event in todays_events %}
                                  {% if event.type == 'chore' %}
                                  <div class="p-4 bg-gray-50 dark:bg-gray-700/50 border-l-4 rounded-r-lg flex flex-col sm:flex-row justify-between items-start sm:items-center" style="border-color: {{ event.color }};">
                                      <div class="flex items-start gap-4 flex-1">
                                          <div class="text-purple-500 mt-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg></div>
                                          <div class="flex-1">
                                              <h4 class="font-bold text-lg text-gray-800 dark:text-gray-100">{{ event.name }}</h4>
                                              <p class="text-sm text-gray-600 dark:text-gray-300 mt-1 pr-4">{{ event.description }}</p>
                                              <div class="mt-3 text-sm font-bold text-purple-600 dark:text-purple-300 bg-purple-100 dark:bg-purple-900 px-2 py-0.5 rounded-full inline-block">+{{ event.points }} pts</div>
                                          </div>
                                      </div>
                                      <div class="mt-4 sm:mt-0 w-full sm:w-auto flex justify-end">
                                          {% if event.status == 'assigned' %}<a href="{{ url_for('complete_event', event_id=event._id) }}" class="w-full sm:w-auto flex justify-center items-center gap-2 px-5 py-2.5 text-sm font-semibold text-white bg-blue-500 rounded-lg hover:bg-blue-600 transition-transform transform hover:scale-105 shadow-md">Mark as Done</a>
                                          {% elif event.status == 'completed' %}<span class="flex items-center justify-center gap-2 w-full sm:w-auto px-5 py-2.5 text-sm font-semibold text-indigo-800 dark:text-indigo-300 bg-indigo-100 dark:bg-indigo-900 rounded-lg">Awaiting Approval</span>
                                          {% elif event.status == 'approved' %}<span class="flex items-center justify-center gap-2 w-full sm:w-auto px-5 py-2.5 text-sm font-semibold text-green-800 dark:text-green-300 bg-green-100 dark:bg-green-900 rounded-lg">Approved!</span>
                                          {% endif %}
                                      </div>
                                  </div>
                                  {% elif event.type == 'habit' %}
                                  <div class="p-4 bg-gray-50 dark:bg-gray-700/50 border-l-4 rounded-r-lg flex flex-col sm:flex-row justify-between items-start sm:items-center" style="border-color: {{ event.color }};">
                                      <div class="flex items-start gap-4 flex-1">
                                          <div class="text-pink-500 mt-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg></div>
                                          <div class="flex-1">
                                              <h4 class="font-bold text-lg text-gray-800 dark:text-gray-100">{{ event.name }}</h4>
                                              <p class="text-sm text-gray-600 dark:text-gray-300 mt-1 pr-4">{{ event.description }}</p>
                                              <div class="flex items-center gap-4 mt-3 text-sm">
                                                  <span class="font-bold text-green-600 dark:text-green-300 bg-green-100 dark:bg-green-900 px-2 py-0.5 rounded-full">+{{ event.points }} pts</span>
                                                  <span class="font-semibold text-orange-600 dark:text-orange-300 bg-orange-100 dark:bg-orange-900 px-2 py-0.5 rounded-full flex items-center gap-1">
                                                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.934l-6.75 12.25a1 1 0 001.64.905l1.852 -1.069a1 1 0 011.23.372l3.22 4.705a1 1 0 001.64-.905l-1.852 -1.069a1 1 0 01-.001-1.422l6.75 -12.25a1 1 0 00-.385-1.45z" clip-rule="evenodd"/></svg>
                                                      Streak: {{ event.streak|default(0) }}
                                                  </span>
                                              </div>
                                          </div>
                                      </div>
                                      <div class="mt-4 sm:mt-0 w-full sm:w-auto flex justify-end">
                                          {% if event.can_checkin %}<a href="{{ url_for('checkin_habit', event_id=event._id) }}" class="w-full sm:w-auto flex justify-center items-center gap-2 px-5 py-2.5 text-sm font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600 transition-transform transform hover:scale-105 shadow-md">Check-in Today</a>
                                          {% else %}<span class="w-full sm:w-auto flex justify-center items-center gap-2 px-5 py-2.5 text-sm font-semibold text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 rounded-lg cursor-default">Done for Today!</span>
                                          {% endif %}
                                      </div>
                                  </div>
                                  {% endif %}
                              {% endfor %}
                          {% else %}
                              <p class="text-center py-8 text-gray-500 dark:text-gray-300">Nothing scheduled for today. Great job!</p>
                          {% endif %}
                      </div>
                  </div>
              </div>

              <div class="lg:col-span-1 space-y-8">
                  <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl">
                      <h2 class="text-xl font-bold mb-4 flex items-center gap-3 text-gray-900 dark:text-gray-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 9.586V6z" clip-rule="evenodd" /></svg>
                        Overdue
                      </h2>
                      <div class="space-y-3 max-h-48 overflow-y-auto custom-scrollbar pr-2">
                        {% if overdue_events %}
                          {% for event in overdue_events %}
                          <div class="p-3 bg-red-50 dark:bg-red-900/20 rounded-lg flex justify-between items-center">
                              <div>
                                  <p class="font-semibold text-gray-800 dark:text-gray-100">{{ event.name }}</p>
                                  <p class="text-sm text-gray-500 dark:text-gray-400">Due: {{ event.due_date.astimezone(TIMEZONE).strftime('%b %d') }}</p>
                              </div>
                              <a href="{{ url_for('complete_event', event_id=event._id) }}" class="px-3 py-1.5 text-sm font-semibold text-white bg-blue-500 rounded-lg hover:bg-blue-600 transition">Done</a>
                          </div>
                          {% endfor %}
                        {% else %}
                          <p class="text-center py-4 text-gray-500 dark:text-gray-300">No overdue chores!</p>
                        {% endif %}
                      </div>
                  </div>
                  
                  <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl">
                        <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-gray-100">Reward Store</h3>
                        <div class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar pr-2">
                             {% for reward in available_rewards %}
                                <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-semibold text-gray-800 dark:text-gray-100">{{ reward.name }}</p>
                                            <p class="text-sm text-yellow-600 dark:text-yellow-400 font-bold">{{ reward.cost }} pts</p>
                                        </div>
                                        <form action="{{ url_for('request_reward') }}" method="POST">
                                            <input type="hidden" name="reward_id" value="{{ reward._id }}">
                                            <button type="submit" 
                                                    class="px-4 py-2 text-sm font-semibold text-white bg-secondary-500 rounded-lg hover:bg-secondary-600 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
                                                    {% if current_user.points < reward.cost %}disabled title="Not enough points"{% endif %}>
                                                Redeem
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            {% else %}
                                <p class="text-sm text-center py-4 text-gray-500 dark:text-gray-300">Your parents haven't added any rewards yet.</p>
                            {% endfor %}
                        </div>
                        <hr class="my-6 border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-bold mb-4 text-gray-900 dark:text-gray-100">My Reward History</h3>
                        <div class="space-y-3 max-h-60 overflow-y-auto custom-scrollbar pr-2">
                            {% for reward in rewards|sort(attribute='_id', reverse=true) %}
                            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div>
                                    <p class="text-sm font-semibold pr-2 text-gray-800 dark:text-gray-100">{{ reward.name }} ({{ reward.points_cost }} pts)</p>
                                    {% if reward.resolved_at_pretty %}<p class="text-xs text-gray-500 dark:text-gray-300">Resolved {{ reward.resolved_at_pretty }}</p>{% endif %}
                                </div>
                                <span class="flex-shrink-0 px-2.5 py-0.5 text-xs font-medium rounded-full {{ {'requested':'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300', 'approved':'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300', 'rejected':'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300'}[reward.status] }}">{{ reward.status|capitalize }}</span>
                            </div>
                            {% else %}
                                <p class="text-sm text-center py-4 text-gray-500 dark:text-gray-300">No reward history yet.</p>
                            {% endfor %}
                        </div>
                    </div>

                  <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl">
                      <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100">Family Challenges</h3>
                      <div class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar pr-2 mt-4">
                          {% if challenges %}
                              {% for c in challenges %}
                              <div class="p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg">
                                  <div class="flex justify-between items-start">
                                      <div>
                                          <p class="font-semibold text-gray-800 dark:text-gray-100">{{ c.title }}</p>
                                          <p class="text-sm text-yellow-600 dark:text-yellow-400 font-semibold">{{ c.points }} pts</p>
                                      </div>
                                      {% if c.status == 'open' %}<a href="{{ url_for('claim_challenge', challenge_id=c._id) }}" class="px-3 py-1 text-sm font-semibold bg-blue-500 text-white rounded-lg hover:bg-blue-600">Claim</a>
                                      {% elif c.status == 'in_progress' and c.claimed_by_id|string == current_user.id %}<a href="{{ url_for('complete_challenge', challenge_id=c._id) }}" class="px-3 py-1 text-sm font-semibold bg-green-500 text-white rounded-lg hover:bg-green-600">Complete</a>
                                      {% endif %}
                                  </div>
                                  <p class="text-sm text-gray-500 dark:text-gray-300 mt-2">{{ c.description }}</p>
                                  <p class="text-xs mt-2 text-gray-400 dark:text-gray-500">Status: {{ c.status|capitalize }} {% if c.claimer_username %}&middot; Claimed by {{ c.claimer_username }}{% endif %}</p>
                              </div>
                              {% endfor %}
                          {% else %}
                              <p class="text-center text-gray-500 dark:text-gray-300">No challenges found.</p>
                          {% endif %}
                      </div>
                  </div>
              </div>
          </div>
      </div>
      
      {% elif page == 'family_dashboard' %}
      <div class="space-y-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl hover-lift flex items-center space-x-4 transition-transform">
            <div class="bg-green-100 dark:bg-green-900 p-4 rounded-2xl">
              <svg class="w-8 h-8 text-green-600 dark:text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-300">Tasks Completed This Week</p>
              <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ stats.completed_this_week }}</p>
            </div>
          </div>
          <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl hover-lift flex items-center space-x-4 transition-transform">
            <div class="bg-yellow-100 dark:bg-yellow-900 p-4 rounded-2xl">
              <svg class="w-8 h-8 text-yellow-600 dark:text-yellow-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-300">Pending Approval</p>
              <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ stats.pending_approval }}</p>
            </div>
          </div>
          <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl hover-lift flex items-center space-x-4 transition-transform">
            <div class="bg-blue-100 dark:bg-blue-900 p-4 rounded-2xl">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600 dark:text-blue-300" viewBox="0 0 20 20" fill="currentColor">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.538.921l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.783.57-1.838-.197-1.538-.921l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-300">Total Points Awarded</p>
              <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ stats.total_points_awarded }}</p>
            </div>
          </div>
        </div>
      
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl hover-lift">
            <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-gray-100">Weekly Task Completion</h3>
            <div class="h-80">
              <canvas id="weeklyCompletionChart"></canvas>
            </div>
          </div>
          <div class="lg:col-span-1 bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl hover-lift">
            <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-gray-100">Family Leaderboard</h3>
            <div class="space-y-4">
              {% for member in family_members|selectattr("role", "equalto", "child")|sort(attribute='points', reverse=true) %}
              <div class="flex items-center justify-between p-3 rounded-lg
                  {% if loop.index == 1 %} bg-yellow-100 dark:bg-yellow-900 {% else %} bg-gray-50 dark:bg-gray-700 {% endif %}">
                <div class="flex items-center space-x-3">
                  <span class="text-lg font-bold w-6 text-center
                          {% if loop.index == 1 %} text-yellow-600 dark:text-yellow-300
                          {% else %} text-gray-400 dark:text-gray-500 {% endif %}">
                    {{ loop.index }}
                  </span>
                  <div class="w-8 h-8 rounded-full bg-blue-200 dark:bg-blue-900 flex items-center justify-center
                               font-bold text-blue-700 dark:text-blue-300">
                    {{ member.username[0]|upper }}
                  </div>
                  <span class="font-medium text-gray-800 dark:text-gray-100">{{ member.username }}</span>
                </div>
                <span class="font-bold text-blue-600 dark:text-blue-300">{{ member.points }} pts</span>
              </div>
              {% else %}
                <p class="text-center text-gray-500 dark:text-gray-300 py-6">Invite family members to start the leaderboard!</p>
              {% endfor %}
            </div>
          </div>
        </div>
      
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl hover-lift">
          <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-gray-100">Family Timers</h3>
          <p class="text-sm text-gray-500 dark:text-gray-300 mb-4">
            Everyone can create a timer to count down to a special day or event.
          </p>
          <form method="POST" action="{{ url_for('create_timer') }}" class="flex flex-col md:flex-row gap-2 mb-6">
            <input type="text" name="name" placeholder="Timer Name (e.g. 'Vacation Day')"
                   class="flex-grow px-3 py-2 bg-gray-50 dark:bg-gray-700 dark:text-gray-100
                          border border-gray-300 dark:border-gray-600 rounded-lg" required>
            <input type="date" name="end_date"
                   class="px-3 py-2 bg-gray-50 dark:bg-gray-700 dark:text-gray-100
                          border border-gray-300 dark:border-gray-600 rounded-lg" required>
            <button type="submit"
                    class="px-5 py-2.5 text-white bg-blue-600 hover:bg-blue-700 rounded-lg
                           transition font-semibold">
              Add Timer
            </button>
          </form>
          <div class="space-y-3 max-h-72 overflow-y-auto custom-scrollbar pr-2">
            {% if timers %}
              {% for timer in timers %}
              <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700
                           border border-gray-200 dark:border-gray-600 rounded-lg
                           hover:shadow-md transition-shadow">
                <div>
                  <p class="font-semibold text-gray-800 dark:text-gray-100">
                    {{ timer.name }}
                  </p>
                  <p class="text-sm text-gray-500 dark:text-gray-300">
                    Created by {{ timer.creator_name }} &bull; Ends on <strong>{{ timer.end_date }}</strong>
                  </p>
                </div>
                <div>
                  <span class="text-sm font-bold bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-200 px-3 py-1 rounded-full">
                    {{ timer.time_left }}
                  </span>
                </div>
              </div>
              {% endfor %}
            {% else %}
              <p class="text-center py-6 text-gray-500 dark:text-gray-300">
                No timers have been created yet.
              </p>
            {% endif %}
          </div>
        </div>
      
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl hover-lift">
          <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-gray-100">Recent Activity</h3>
          <div class="space-y-3 max-h-72 overflow-y-auto custom-scrollbar pr-2">
            {% for event in recent_events %}
            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
              <div class="flex items-center gap-3">
                <span class="text-green-500 dark:text-green-300">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
                       fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                          d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293
                             a1 1 0 00-1.414-1.414L9 10.586l-1.293-1.293
                             a1 1 0 00-1.414 1.414l2 2
                             a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                  </svg>
                </span>
                <p class="text-gray-800 dark:text-gray-100">
                  <span class="font-semibold">{{ event.assigned_to_username }}</span>
                  earned <span class="font-semibold text-green-700 dark:text-green-300">{{ event.points }} points</span>
                  for completing <span class="font-semibold">{{ event.name }}</span>.
                </p>
              </div>
              <p class="text-sm text-gray-500 dark:text-gray-300 whitespace-nowrap">
                {{ event.approved_at_pretty }}
              </p>
            </div>
            {% else %}
              <p class="text-center text-gray-500 dark:text-gray-300 py-6">No tasks have been approved yet.</p>
            {% endfor %}
          </div>
        </div>
      </div>
      
      {% elif page == 'calendar_focus' %}
        <div id="event-details-modal" class="fixed inset-0 z-[80] flex items-center justify-center bg-black bg-opacity-60 hidden p-4">
            <div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-lg mx-auto">
                <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
                    <h3 id="modal-title" class="text-2xl font-bold text-gray-900 dark:text-gray-100">Event Title</h3>
                    <button id="modal-close-btn" class="p-2 rounded-full text-gray-400 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <p id="modal-description" class="text-gray-700 dark:text-gray-300">Description goes here.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                        <div id="modal-assignee" class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg"></div>
                        <div id="modal-points" class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg"></div>
                        <div id="modal-status" class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg"></div>
                        <div id="modal-extra-info" class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg"></div>
                    </div>
                </div>
                <div id="modal-actions" class="p-6 pt-0 text-right space-x-2">
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-xl">
            <div class="md:flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold mb-4 md:mb-0 text-gray-900 dark:text-gray-100">Family Calendar</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:flex items-center gap-4">
                    <input type="text" id="filter-search" placeholder="Search by name..."
                           class="w-full md:w-auto px-3 py-2 bg-gray-50 dark:bg-gray-700 dark:text-gray-100
                                  border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"/>
                    <select id="filter-member"
                            class="w-full md:w-auto px-3 py-2 bg-gray-50 dark:bg-gray-700 dark:text-gray-100
                                   border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                        <option value="">All Members</option>
                        {% for member in family_members if member.role == 'child' %}
                        <option value="{{ member._id }}" {% if member._id == current_user.id %}selected{% endif %}>
                          {{ member.username }}
                        </option>
                        {% endfor %}
                    </select>
                    <select id="filter-type"
                            class="w-full md:w-auto px-3 py-2 bg-gray-50 dark:bg-gray-700 dark:text-gray-100
                                   border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                        <option value="">All Types</option>
                        <option value="chore">Chores</option>
                        <option value="habit">Habits</option>
                    </select>
                    <button id="apply-filters"
                            class="w-full sm:col-span-2 md:w-auto px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                        Apply Filters
                    </button>
                </div>
            </div>
            <div id="calendar" class="text-sm md:text-base"></div>
        </div>
      {% elif page == 'mood_dashboard_personal' %}
      <div class="space-y-8">
        <div class="text-center">
          <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100">Mood Tracker</h1>
          <p class="text-lg text-gray-600 dark:text-gray-300 mt-2">
            Hi, {{ current_user.username }}! Log how you're feeling throughout the day.
          </p>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-xl hover-lift">
          <div class="flex flex-col md:flex-row justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">
              Log Your Mood for
              <input type="date" id="mood-date" class="bg-gray-100 dark:bg-gray-700 rounded-lg p-2 ml-2">
            </h3>
            <a href="{{ url_for('mood_dashboard_family') }}"
               class="mt-4 md:mt-0 px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-full hover:bg-blue-700 transition">
              View Family Moods
            </a>
          </div>
          <div id="mood-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-xl hover-lift">
          <h3 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100">My Mood History (Last 30 Days)</h3>
          <div class="h-80">
            <canvas id="personalMoodChart"></canvas>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-xl hover-lift text-center">
          <h3 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100">Need some perspective?</h3>
          <p class="text-gray-600 dark:text-gray-300 mb-6 max-w-2xl mx-auto">
            Get supportive, AI-powered insights based on your mood history to better understand your emotional patterns.
          </p>
          <button id="consult-ai-btn"
                  class="px-6 py-3 font-semibold text-white bg-secondary-500 rounded-lg
                         hover:bg-secondary-600 transition-transform transform hover:scale-105 shadow-md">
            Consult AI for Insights
          </button>
        </div>
      </div>
      <div id="ai-modal"
           class="fixed inset-0 bg-gray-900 bg-opacity-60 dark:bg-black dark:bg-opacity-80 z-50 hidden flex items-center justify-center p-4">
        <div class="relative p-6 border w-full max-w-2xl shadow-2xl rounded-2xl bg-white dark:bg-gray-800 dark:text-gray-100 modal-content">
          <button onclick="closeModal('ai-modal')"
                  class="absolute top-4 right-4 text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-gray-200 text-3xl">&times;</button>
          <h3 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100">AI-Powered Insights</h3>
          <div id="ai-response-content" class="prose-styles max-h-96 overflow-y-auto custom-scrollbar pr-4 text-gray-700 dark:text-gray-200">
          </div>
        </div>
      </div>
      
      {% elif page == 'mood_dashboard_family' %}
      <div class="space-y-8">
        <div class="text-center">
          <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100">Family Mood Overview</h1>
          <p class="text-lg text-gray-600 dark:text-gray-300 mt-2">A look at the whole family's emotional well-being.</p>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
          <div class="lg:col-span-3 bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-xl hover-lift">
            <h3 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100">Family Daily Average Mood (Last 30 Days)</h3>
            <div class="h-80">
              <canvas id="familyDailyAverageChart"></canvas>
            </div>
          </div>
          <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-xl hover-lift">
            <h3 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100">Mood Distribution</h3>
            <div class="h-80 flex items-center justify-center">
              <canvas id="familyDistributionChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      {% elif page == 'create_another_parent' %}
      <div class="flex items-center justify-center min-h-[calc(100vh-250px)]">
        <div class="w-full max-w-md p-8 space-y-6 bg-white dark:bg-gray-800 rounded-2xl shadow-xl hover-lift">
          <div class="text-center">
            <h1 class="text-4xl font-extrabold gradient-text font-brand">Add a Co-Parent</h1>
            <p class="mt-2 text-gray-600 dark:text-gray-200">Create an account for another parent or guardian.</p>
          </div>
          <form method="POST" action="{{ url_for('create_another_parent') }}" class="space-y-6">
            <div>
              <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-200">New Parent's Username</label>
              <input type="text" name="username" id="username" required
                       class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 dark:text-gray-100
                             border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm
                             focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition"/>
            </div>
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-200">New Parent's Email</label>
              <input type="email" name="email" id="email" required
                       class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 dark:text-gray-100
                             border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm
                             focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition"/>
            </div>
            <div>
              <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Temporary Password</label>
              <input type="password" name="password" id="password" required minlength="8"
                       class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 dark:text-gray-100
                             border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm
                             focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition"/>
              <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">The new parent can change this after logging in. Min 8 characters.</p>
            </div>
            <button type="submit"
                    class="w-full py-3 px-4 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700
                           focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500
                           transition-transform transform hover:scale-105 shadow-lg">
              Create Parent Account
            </button>
          </form>
          <p class="text-center text-sm text-gray-600 dark:text-gray-200 mt-2">
            <a href="{{ url_for('family_dashboard') }}" class="font-medium text-blue-600 dark:text-blue-400 hover:text-blue-500 dark:hover:text-blue-300">
              &larr; Back to Dashboard
            </a>
          </p>
        </div>
      </div>
      {% elif page == 'manage_plan' %}
      
<div id="add-task-to-plan-modal" class="fixed inset-0 z-[80] flex items-center justify-center bg-black bg-opacity-60 hidden p-4">
   <div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-lg mx-auto">
    <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
      <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Add Task to Plan</h3>
      <button onclick="closeModal('add-task-to-plan-modal')" class="p-2 rounded-full text-gray-400 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <form method="POST" action="{{ url_for('add_task_to_plan', plan_id=plan._id) }}">
     <div class="p-6 space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Task Name</label>
        <input type="text" name="name" required class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Points</label>
        <input type="number" name="points" min="1" required class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Assign To</label>
        <select name="assigned_to" required class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600">
          {% for member in family_members if member.role == 'child' %}
          <option value="{{ member._id }}">{{ member.username }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Due Date</label>
        <input type="date" name="due_date" required class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600">
      </div>
     </div>
     <div class="p-6 pt-0 text-right">
       <button type="submit" class="px-6 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition">Add Task</button>
     </div>
    </form>
   </div>
  </div>

  <div id="edit-task-modal" class="fixed inset-0 z-[80] flex items-center justify-center bg-black bg-opacity-60 hidden p-4">
    <div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-lg mx-auto">
     <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
       <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Edit Task</h3>
       <button onclick="closeModal('edit-task-modal')" class="p-2 rounded-full text-gray-400 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
         <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
       </button>
     </div>
     <form id="edit-task-form" method="POST" action="">
      <div class="p-6 space-y-4">
       <div>
         <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Task Name</label>
         <input type="text" name="name" id="edit-task-name" required class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600">
       </div>
       <div>
         <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Description</label>
         <textarea name="description" id="edit-task-description" class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600"></textarea>
       </div>
       <div>
         <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Points</label>
         <input type="number" name="points" id="edit-task-points" min="1" required class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600">
       </div>
       <div>
         <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Assign To</label>
         <select name="assigned_to" id="edit-task-assigned-to" required class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600">
           {% for member in family_members if member.role == 'child' %}
           <option value="{{ member._id }}">{{ member.username }}</option>
           {% endfor %}
         </select>
       </div>
       <div>
         <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Due Date</label>
         <input type="date" name="due_date" id="edit-task-due-date" required class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600">
       </div>
      </div>
      <div class="p-6 pt-0 text-right">
        <button type="submit" class="px-6 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition">Save Changes</button>
      </div>
     </form>
    </div>
   </div>

  <div class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-xl space-y-6">
    <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4">
     <div>
      <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100">Manage FamJam Plan</h2>
      <form action="{{ url_for('edit_plan_name', plan_id=plan._id) }}" method="POST" class="mt-2 flex items-center gap-2">
       <input type="text" name="plan_name" value="{{ plan.plan_data.plan_name }}"
          class="flex-grow px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300
              dark:border-gray-600 rounded-lg shadow-sm focus:outline-none
              focus:ring-blue-500 focus:border-blue-500 font-semibold text-secondary-600 dark:text-secondary-400">
       <button type="submit"
           class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700
              transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
        Save
       </button>
      </form>
     </div>
     <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
      <button onclick="openModal('add-task-to-plan-modal')" class="w-full sm:w-auto px-4 py-2 text-sm font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 transition">
        + Add Single Task
      </button>
      <a href="{{ url_for('personal_dashboard') }}"
       class="w-full sm:w-auto text-center px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700
           rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 flex-shrink-0">
       &larr; Back to Dashboard
      </a>
     </div>
    </div>
        <div class="my-4 p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
      <form action="{{ url_for('manage_plan') }}" method="GET" class="flex flex-col sm:flex-row items-center gap-3">
        <label for="filter-date" class="font-medium text-sm text-gray-700 dark:text-gray-200">Filter by Due Date:</label>
        <input type="date" name="filter_date" id="filter-date" value="{{ request.args.get('filter_date', '') }}"
           class="px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm text-sm">
        <input type="hidden" name="sort_by" value="{{ request.args.get('sort_by', 'due_date') }}">
        <input type="hidden" name="order" value="{{ request.args.get('order', 'asc') }}">
        <button type="submit" class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Filter</button>
        <a href="{{ url_for('manage_plan') }}" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">Clear Filter</a>
      </form>
    </div>
        <div class="overflow-x-auto h-[60vh] overflow-y-auto custom-scrollbar pr-2">
     <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
      <thead class="bg-gray-50 dark:bg-gray-700">
       <tr>
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
         <a href="{{ url_for('manage_plan', sort_by='name', order='desc' if current_sort.by == 'name' and current_sort.order == 'asc' else 'asc') }}"
          class="hover:text-blue-500">
          Task Name
          {% if current_sort.by == 'name' %}{{ '' if current_sort.order == 'asc' else ''|safe }}{% endif %}
         </a>
        </th>
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
         <a href="{{ url_for('manage_plan', sort_by='assigned_to', order='desc' if current_sort.by == 'assigned_to' and current_sort.order == 'asc' else 'asc') }}"
          class="hover:text-blue-500">
          Assigned To
          {% if current_sort.by == 'assigned_to' %}{{ '' if current_sort.order == 'asc' else ''|safe }}{% endif %}
         </a>
        </th>
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
         <a href="{{ url_for('manage_plan', sort_by='due_date', order='desc' if current_sort.by == 'due_date' and current_sort.order == 'asc' else 'asc') }}"
          class="hover:text-blue-500">
          Due Date
          {% if current_sort.by == 'due_date' %}{{ '' if current_sort.order == 'asc' else ''|safe }}{% endif %}
         </a>
        </th>
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
         <a href="{{ url_for('manage_plan', sort_by='points', order='desc' if current_sort.by == 'points' and current_sort.order == 'asc' else 'asc') }}"
          class="hover:text-blue-500">
          Points
          {% if current_sort.by == 'points' %}{{ '' if current_sort.order == 'asc' else ''|safe }}{% endif %}
         </a>
        </th>
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
         <a href="{{ url_for('manage_plan', sort_by='status', order='desc' if current_sort.by == 'status' and current_sort.order == 'asc' else 'asc') }}"
          class="hover:text-blue-500">
          Status
          {% if current_sort.by == 'status' %}{{ '' if current_sort.order == 'asc' else ''|safe }}{% endif %}
         </a>
        </th>
        <th scope="col" class="relative px-6 py-3">
         <span class="sr-only">Actions</span>
        </th>
       </tr>
      </thead>
      <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
       {% for task in tasks %}
       <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">
         {{ task.name }}
         {% if task.source_type == 'manual' %}
         <span title="Manually Added to Plan"
            class="ml-2 text-xs font-semibold bg-blue-100 text-blue-800
               dark:bg-blue-900 dark:text-blue-200 px-2 py-0.5 rounded-full">
          Added
         </span>
         {% endif %}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
         {{ task.assigned_to_username }}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
         {{ task.due_date.astimezone(TIMEZONE).strftime('%a, %b %d') }}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
         {{ task.points }}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm">
         <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
         {% if task.status == 'approved' %}
          bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
         {% elif task.status == 'completed' %}
          bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200
         {% else %}
          bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200
         {% endif %}">
          {{ task.status|capitalize }}
         </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
         <button onclick="openEditTaskModal('{{ task.json_string | escape }}')"
             class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300">
          Edit
         </button>
         <a href="{{ url_for('delete_event', event_id=task._id) }}"
          onclick="return confirm('Are you sure you want to permanently delete this task?')"
          class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
          Delete
         </a>
        </td>
       </tr>
       {% else %}
       <tr>
        <td colspan="6" class="text-center py-10 text-gray-500 dark:text-gray-400">
         No tasks found for this plan.
        </td>
       </tr>
       {% endfor %}
      </tbody>
     </table>
    </div>
   </div>
    
      {% endif %}
    </div>
  </main>
  
  {% if current_user.is_authenticated and current_user.role == 'parent' %}
  <button onclick="openModal('manageFamilyModal')"
          class="fab-flow fixed bottom-8 right-8 z-[60] w-16 h-16 bg-blue-600 text-white rounded-full
                 flex items-center justify-center shadow-lg hover:bg-blue-700 transition
                 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          title="Manage Family">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
      <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3
             3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1
             a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11
             a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
    </svg>
  </button>
  {% endif %}
  
  {% if current_user.is_authenticated %}
  <button onclick="openModal('personalStuffModal')"
          class="fab-flow fixed bottom-8 left-8 z-[60] w-16 h-16 bg-pink-600 text-white rounded-full
          flex items-center justify-center shadow-lg hover:bg-pink-700 transition
          focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500"
          title="My Personal Space">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 11h-1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-3a1 1 0 00-1-1H9a1 1 0 00-1 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-6H3a1 1 0 01-.707-1.707l7-7z" clip-rule="evenodd" />
    </svg>
    {% if unread_messages_exist %}
    <span class="absolute top-0 right-0 block h-4 w-4 transform -translate-y-1/2 translate-x-1/2 rounded-full ring-2 ring-white dark:ring-pink-700 bg-red-500"></span>
    {% endif %}
  </button>
  
  <div id="personalStuffModal" class="side-modal fixed inset-0 z-[70] hidden">
    <div data-modal-overlay onclick="closeModal('personalStuffModal')"
      class="absolute inset-0 bg-gray-900/60 dark:bg-black/80"></div>
    <div data-modal-panel data-side="left"
      class="panel-transition absolute top-0 left-0 h-full w-full max-w-lg bg-white dark:bg-gray-800
           shadow-2xl transform -translate-x-full flex flex-col">
      <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
        <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">My Personal Space</h3>
        <button onclick="closeModal('personalStuffModal')"
            class="p-2 rounded-full text-gray-400 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="flex flex-col h-full">
        <div class="border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
          <nav class="-mb-px flex space-x-6 px-6" aria-label="Tabs">
            <button data-tab="messages-panel" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600 dark:text-blue-400">
              Messages
              <span id="modal-message-badge" class="ml-2 py-0.5 px-2 rounded-full text-xs font-medium bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-200 {% if not unread_messages_exist %}hidden{% endif %}">
                New
              </span>
            </button>
            <button data-tab="notes-panel" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200">
              My Notes
            </button>
            <button data-tab="todos-panel" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200">
              My To-Dos
            </button>
          </nav>
        </div>
        <div class="flex-grow overflow-y-auto custom-scrollbar">
          <div id="messages-panel" class="tab-panel p-6">
            <div class="mb-4">
              <button id="compose-message-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 transition shadow">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 00-1 1v5H4a1 1 0 100 2h5v5a1 1 0 102 0v-5h5a1 1 0 100-2h-5V4a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                Compose New Message
              </button>
            </div>
            <div id="compose-message-form-container" class="hidden p-4 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700/50 mb-4 transition-all duration-300">
              <form id="parent-compose-form" method="POST" action="{{ url_for('send_message') }}">
                <div class="mb-2">
                  <label for="recipient_id" class="block text-sm font-medium text-gray-700 dark:text-gray-200">To:</label>
                  <select name="recipient_id" id="recipient_id" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Select a family member...</option>
                    {% for member in family_members if member._id != current_user.id %}
                      <option value="{{ member._id }}">{{ member.username }} ({{ member.role|capitalize }})</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="mb-2">
                  <label for="message_content_compose" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Message:</label>
                  <textarea name="message_content" id="message_content_compose" required rows="3" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div class="flex justify-end gap-2">
                  <button type="button" id="cancel-compose-btn" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-600 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-500">Cancel</button>
                  <button type="submit" class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Send</button>
                </div>
              </form>
            </div>
  
            <div id="conversation-accordion-container" class="space-y-2">
              <div class="text-center text-gray-500 dark:text-gray-400 p-8">Loading conversations...</div>
            </div>
          </div>
          <div id="notes-panel" class="tab-panel p-6 hidden">
            <div class="space-y-4">
              <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100">My Personal Notes</h3>
              <form method="POST" action="{{ url_for('create_note') }}" class="space-y-2">
                <textarea name="note_content" rows="2" class="w-full p-2 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600" placeholder="Write a quick note..."></textarea>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Add Note</button>
              </form>
              <div class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar pr-2">
                {% if personal_notes %}
                  {% for note in personal_notes %}
                  <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg flex justify-between items-center">
                    <p class="text-gray-800 dark:text-gray-100 break-all">{{ note.content }}</p>
                    <a href="{{ url_for('delete_note', note_id=note._id) }}" class="ml-4 flex-shrink-0 text-red-500 hover:text-red-700 dark:hover:text-red-400 transition">Delete</a>
                  </div>
                  {% endfor %}
                {% else %}
                  <p class="text-center text-gray-500 dark:text-gray-300 py-4">No notes yet.</p>
                {% endif %}
              </div>
            </div>
          </div>
          <div id="todos-panel" class="tab-panel p-6 hidden">
            <div class="space-y-4">
              <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100">My Personal To-Do List</h3>
              <form method="POST" action="{{ url_for('create_todo') }}" class="flex gap-2">
                <input type="text" name="todo_title" class="flex-grow p-2 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600" placeholder="New to-do item...">
                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">Add</button>
              </form>
              <div class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar pr-2">
                {% if personal_todos %}
                  {% for todo in personal_todos %}
                  <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg flex justify-between items-center">
                    <label class="flex items-center text-gray-800 dark:text-gray-100">
                      <input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-3"
                             {% if todo.is_done %}checked{% endif %}
                             onchange="window.location='{{ url_for('toggle_todo', todo_id=todo._id) }}'">
                      <span class="{% if todo.is_done %}line-through text-gray-500{% endif %}">{{ todo.title }}</span>
                    </label>
                    <a href="{{ url_for('delete_todo', todo_id=todo._id) }}" class="ml-4 flex-shrink-0 text-red-500 hover:text-red-700 dark:hover:text-red-400 transition">Delete</a>
                  </div>
                  {% endfor %}
                {% else %}
                  <p class="text-center text-gray-500 dark:text-gray-300 py-4">No to-do items yet.</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  
  {% if current_user.is_authenticated and current_user.role == 'parent' %}
  <div id="manageFamilyModal" class="side-modal fixed inset-0 z-[70] hidden">
    <div data-modal-overlay onclick="closeModal('manageFamilyModal')"
        class="absolute inset-0 bg-gray-900/60 dark:bg-black/80"></div>
    <div data-modal-panel data-side="right"
        class="panel-transition absolute top-0 right-0 h-full w-full max-w-2xl bg-white dark:bg-gray-800
             shadow-2xl transform translate-x-full flex flex-col">
      <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
        <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Manage Family</h3>
        <button onclick="closeModal('manageFamilyModal')"
            class="p-2 rounded-full text-gray-400 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="flex flex-col h-full">
        <div class="border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
          <nav class="-mb-px flex space-x-6 px-6" aria-label="Tabs">
            <button data-tab="family-members-panel"
                    class="tab-btn-family whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600 dark:text-blue-400">
              Family Members
            </button>
            <button data-tab="add-child-panel"
                    class="tab-btn-family whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200">
              Add Child
            </button>
            <button data-tab="add-parent-panel"
                    class="tab-btn-family whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200">
              Add Co-Parent
            </button>
            <button data-tab="account-panel"
                    class="tab-btn-family whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200">
              My Account
            </button>
          </nav>
        </div>
        <div class="flex-grow overflow-y-auto custom-scrollbar">
          <div id="family-members-panel" class="tab-panel-family p-6">
            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-2">Parents & Guardians</h4>
            <div class="space-y-4 mb-6">
              {% set parents = family_members|selectattr("role", "equalto", "parent")|list %}
              {% if parents %}
                {% for member in parents %}
                  <div class="modal-content-item flex items-center justify-between p-4 bg-white dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-lg">
                    <div class="flex items-center space-x-4">
                      <div class="w-10 h-10 rounded-full bg-green-200 dark:bg-green-900 flex items-center justify-center font-bold text-green-700 dark:text-green-300 text-lg">
                        {{ member.username[0]|upper }}
                      </div>
                      <div>
                        <p class="font-semibold text-gray-800 dark:text-gray-100">{{ member.username }} {% if member._id == current_user.id %}(You){% endif %}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Role: Parent</p>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% endif %}
            </div>
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-100">Children</h4>
              <button onclick="openFamJamModal()" class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-secondary-600 rounded-lg hover:bg-secondary-700 transition group">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.538.921l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.783.57-1.838-.197-1.538-.921l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" clip-rule="evenodd" />
                </svg>
                Generate FamJam Plan
              </button>
            </div>
            <div class="space-y-4">
              {% set children = family_members|selectattr("role", "equalto", "child")|list %}
              {% if children %}
                {% for member in children %}
                <div class="modal-content-item flex items-center justify-between p-4 bg-white dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-lg hover:shadow-md hover:border-blue-400 dark:hover:border-blue-500 transition-all">
                  <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 rounded-full bg-blue-200 dark:bg-blue-900 flex items-center justify-center font-bold text-blue-700 dark:text-blue-300 text-lg">
                      {{ member.username[0]|upper }}
                    </div>
                    <div>
                      <p class="font-semibold text-gray-800 dark:text-gray-100">{{ member.username }}</p>
                      <p class="text-sm text-gray-500 dark:text-gray-300">Points: {{ member.points }}</p>
                    </div>
                  </div>
                  <div class="flex space-x-2">
                    <button onclick="openModal('edit-child-modal'); openEditModal('{{ member._id }}', '{{ member.username }}')" class="p-2 text-gray-500 dark:text-gray-300 bg-gray-100 dark:bg-gray-600 rounded-full hover:bg-gray-200 dark:hover:bg-gray-500 transition" title="Edit Child">
                      <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                        <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                      </svg>
                    </button>
                    <button onclick="openResetChildPasswordModal('{{ member._id }}', '{{ member.username }}')" class="p-2 text-gray-500 dark:text-gray-300 bg-gray-100 dark:bg-gray-600 rounded-full hover:bg-gray-200 dark:hover:bg-gray-500 transition" title="Reset Password">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" />
                      </svg>
                    </button>
                    <a href="{{ url_for('remove_child', child_id=member._id) }}" onclick="return confirm('Are you sure you want to remove {{ member.username }}? This will delete their account and all their tasks.')" class="p-2 text-red-500 bg-red-100 dark:bg-red-900/50 rounded-full hover:bg-red-200 dark:hover:bg-red-800 transition" title="Remove Child">
                      <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                      </svg>
                    </a>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <div class="modal-content-item text-center py-8 text-gray-500 dark:text-gray-300 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg">
                  No children have been added yet.
                </div>
              {% endif %}
            </div>
          </div>
  
          <div id="add-child-panel" class="tab-panel-family p-6 hidden">
            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb=1">Add a Child Account</h4>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
              Quickly create a new account for your child. They can log in immediately with these details.
            </p>
            <form method="POST" action="{{ url_for('create_child_direct') }}" class="space-y-4">
              <div>
                <label for="child-username" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Child's Username</label>
                <input type="text" name="username" id="child-username" required class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition"/>
              </div>
              <div>
                <label for="child-password" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Temporary Password</label>
                <input type="password" name="password" id="child-password" required minlength="6" class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition"/>
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Min 6 characters. They can change this later.</p>
              </div>
              <div class="pt-2">
                <button type="submit" class="w-full py-3 px-4 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 shadow-lg">
                  Create Child Account
                </button>
              </div>
            </form>
          </div>
  
          <div id="add-parent-panel" class="tab-panel-family p-6 hidden">
            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-1">Add a Co-Parent</h4>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
              Create an account for another parent or guardian.
            </p>
            <form method="POST" action="{{ url_for('create_another_parent') }}" class="space-y-4">
              <div>
                <label for="parent-username" class="block text-sm font-medium text-gray-700 dark:text-gray-200">New Parent's Username</label>
                <input type="text" name="username" id="parent-username" required class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition"/>
              </div>
              <div>
                <label for="parent-email" class="block text-sm font-medium text-gray-700 dark:text-gray-200">New Parent's Email</label>
                <input type="email" name="email" id="parent-email" required class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition"/>
              </div>
              <div>
                <label for="parent-password" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Temporary Password</label>
                <input type="password" name="password" id="parent-password" required minlength="8" class="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition"/>
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Min 8 characters. They can change this later.</p>
              </div>
              <div class="pt-2">
                <button type="submit" class="w-full py-3 px-4 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105 shadow-lg">
                  Create Co-Parent Account
                </button>
              </div>
            </form>
          </div>
  
          <div id="account-panel" class="tab-panel-family p-6 hidden">
            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-1">My Account Settings</h4>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
              Manage your own login credentials.
            </p>
            <button onclick="openModal('change-parent-password-modal')"
                    class="modal-content-item w-full text-left flex items-center gap-3 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition group">
              <span
                class="p-2 bg-yellow-100 dark:bg-yellow-900 rounded-lg text-yellow-600 dark:text-yellow-300 group-hover:scale-110 transition-transform">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round"
                        d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.629 5.858a6 6 0 01-8.23-8.23A6 6 0 0115 7z" />
                  <path stroke-linecap="round" stroke-linejoin="round"
                        d="M15 7a2 2 0 00-2-2m0 0a2 2 0 00-2 2m2 2a2 2 0 002 2m-2 2a2 2 0 00-2 2" />
                </svg>
              </span>
              <div>
                <p class="font-semibold text-gray-800 dark:text-gray-100">Change My Password</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Update your login credentials.</p>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  
  <div id="famjam-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 dark:bg-black dark:bg-opacity-80 z-[80] hidden flex items-center justify-center p-4">
    <div class="relative p-6 border w-full max-w-2xl shadow-2xl rounded-2xl bg-white dark:bg-gray-800 dark:text-gray-100 modal-content flex flex-col" style="max-height: 90vh;">
      <div class="flex-shrink-0">
        <button onclick="closeModal('famjam-modal')" class="absolute top-4 right-4 text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-gray-200 text-3xl">&times;</button>
        <h3 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100">Generate a FamJam Plan</h3>
      </div>
      <div id="famjam-start">
        <p class="text-gray-600 dark:text-gray-300 mb-4">
          Let AI help you create a balanced, recurring chore plan for the next quarter. Describe a goal for your family (e.g., "keeping the kitchen tidy," "learning responsibility," etc.) or leave it blank for a general plan.
        </p>
        <div class="space-y-4">
          <textarea id="famjam-goal-input" class="w-full p-2 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600" rows="3" placeholder="e.g., focus on teamwork and keeping common areas clean..."></textarea>
          <button onclick="generateFamJamPlan()" class="w-full py-3 px-4 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 shadow-lg">
            Generate Plan with AI
          </button>
        </div>
      </div>
      <div id="famjam-loading" class="hidden text-center py-10">
        <svg class="animate-spin h-10 w-10 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-lg font-semibold text-gray-700 dark:text-gray-200">Generating your plan...</p>
        <p class="text-sm text-gray-500 dark:text-gray-400">This can take a moment.</p>
      </div>
      <div id="famjam-review" class="hidden flex flex-col flex-grow min-h-0">
        <div class="mb-4 flex-shrink-0">
          <label class="text-sm font-semibold">Plan Name:</label>
          <input id="famjam-plan-name-input" type="text" class="w-full mt-1 p-2 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 font-bold">
          <p class="text-xs text-gray-500 mt-1">Plan Period: <span id="famjam-date-range"></span></p>
        </div>
        <div id="famjam-plan-content" class="space-y-3 overflow-y-auto custom-scrollbar flex-grow pr-2">
        </div>
        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 flex-shrink-0 flex items-center justify-between">
          <button onclick="addChoreToPlan()" class="px-4 py-2 text-sm font-semibold text-blue-600 bg-blue-100 dark:bg-blue-900 dark:text-blue-200 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition">
            + Add Chore
          </button>
          <button id="famjam-accept-btn" class="px-6 py-2 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 transition shadow">
            Accept & Apply Plan
          </button>
        </div>
      </div>
      <div id="famjam-applying" class="hidden text-center py-10">
        <p class="text-lg font-semibold">Applying plan and scheduling chores...</p>
      </div>
      <div id="famjam-success" class="hidden text-center py-10">
        <p id="famjam-success-message" class="text-lg font-semibold text-green-600">Plan applied!</p>
      </div>
      <div id="famjam-error" class="hidden text-center py-10">
        <p class="text-lg font-semibold text-red-600">Oops, something went wrong!</p>
        <p id="famjam-error-message" class="mt-2 text-gray-600 dark:text-gray-300 bg-red-50 dark:bg-red-900/50 p-3 rounded-md"></p>
        <button onclick="openFamJamModal()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Try Again</button>
      </div>
    </div>
  </div>
  <script>
    // --- ROLE-AWARE & GLOBAL VARIABLES ---
    const USER_ROLE = '{{ current_user.role }}';
    {% if current_user.role == 'child' and parent is defined %}
    const PARENT_USERNAME = '{{ parent.username }}';
    {% else %}
    const PARENT_USERNAME = null;
    {% endif %}
    
    {% if current_user.is_authenticated %}
    const currentUserId = '{{ current_user.id }}';
    {% else %}
    const currentUserId = null;
    {% endif %}
    
    {% if current_user.is_authenticated %}
    const FAMILY_MEMBERS = {{ family_members|default([])|tojson }};
    {% else %}
    const FAMILY_MEMBERS = [];
    {% endif %}
    
    // --- MODAL & UI HELPER FUNCTIONS ---
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        modal.classList.remove('hidden');
    
        requestAnimationFrame(() => {
          modal.classList.add('is-open');
          const items = modal.querySelectorAll('.modal-content-item');
          items.forEach((item, index) => {
              item.style.animationDelay = `${150 + index * 100}ms`;
          });
    
          // If the personal modal is being opened, fetch the messages for the current user.
          if (modalId === 'personalStuffModal') {
              const messagesPanel = document.getElementById('messages-panel');
              if (messagesPanel && !messagesPanel.hasAttribute('data-loaded')) {
                  fetchAndDisplayMessages();
              }
          }
        });
    }
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        modal.classList.remove('is-open');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 600);
    }
    function openEditModal(childId, username) {
        document.getElementById('edit-child-id').value = childId;
        document.getElementById('edit-username').value = username;
        document.getElementById('edit-password').value = '';
        document.getElementById('edit-child-form').action = `/child/edit/${childId}`;
    }
    function openResetChildPasswordModal(childId, childUsername) {
        document.getElementById('reset-child-username').innerText = childUsername;
        const form = document.getElementById('reset-child-password-form');
        form.action = `/child/reset-password/${childId}`;
        form.reset(); // Clear password field from previous use
        openModal('reset-child-password-modal');
    }
    function openEditTaskModal(taskJsonString) {
        const task = JSON.parse(taskJsonString);
        const form = document.getElementById('edit-task-form');
        form.action = `/event/edit/${task._id}`;
        document.getElementById('edit-task-name').value = task.name;
        document.getElementById('edit-task-description').value = task.description || '';
        document.getElementById('edit-task-points').value = task.points;
        document.getElementById('edit-task-due-date').value = task.due_date.substring(0, 10);
        document.getElementById('edit-task-assigned-to').value = task.assigned_to;
        openModal('edit-task-modal');
    }
    /**
     * Converts a UTC date string into a user-friendly "time ago" format.
     */
    function timeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);
    
        if (seconds < 60) return "Just now";
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}m ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;
        const days = Math.floor(hours / 24);
        return `${days}d ago`;
    }
    
    // --- MESSAGING FUNCTIONS ---
    async function handleMessageSubmit(form) {
        const formData = new FormData(form);
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
    
        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData
            });
            if (!response.ok) throw new Error('Network response was not ok.');
            fetchAndDisplayMessages();
            form.reset();
            const textarea = form.querySelector('textarea');
            if (textarea) textarea.style.height = 'auto';
            // Hide the compose area if it's the main compose form
            if (form.id === 'parent-compose-form') {
                document.getElementById('compose-message-form-container')?.classList.add('hidden');
            }
        } catch (error) {
            console.error('Error sending message:', error);
            alert('Could not send message. Please try again.');
        } finally {
            submitButton.disabled = false;
        }
    }
    
    /**
     * Fetches, groups, and renders all conversations for the current user.
     */
    async function fetchAndDisplayMessages() {
        const container = document.getElementById('conversation-accordion-container');
        const messagesPanel = document.getElementById('messages-panel');
        if (!container || !messagesPanel) return;
    
        container.innerHTML = `<div class="text-center text-gray-500 dark:text-gray-400 p-8">Loading...</div>`;
        try {
            const response = await fetch('/api/messages');
            if (!response.ok) throw new Error('Failed to fetch messages.');
    
            const messages = await response.json();
            messagesPanel.setAttribute('data-loaded', 'true');
            container.innerHTML = '';
            if (messages.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 dark:text-gray-400 p-8">No messages yet.</div>`;
                return;
            }
    
            const currentUserId = '{{ current_user.id }}';
            const conversations = {};
            const userMap = {};
    
            // Gather basic mapping from each message's sender to username
            messages.forEach(msg => {
                if (msg.sender_id && msg.sender_username) {
                    userMap[msg.sender_id.$oid] = msg.sender_username;
                }
            });
            // Ensure we know our own username
            userMap[currentUserId] = '{{ current_user.username }}';
    
            // If this is a parent, we also have a full FAMILY_MEMBERS list to fill userMap
            if (typeof FAMILY_MEMBERS !== 'undefined' && FAMILY_MEMBERS.length > 0) {
                FAMILY_MEMBERS.forEach(member => {
                    if (!userMap[member._id]) {
                        userMap[member._id] = member.username;
                    }
                });
            }
            // If user is child, ensure we can see the parent's username:
            {% if current_user.role == 'child' and parent %}
            if (!userMap["{{ parent._id }}"]) {
                userMap["{{ parent._id }}"] = "{{ parent.username }}";
            }
            {% endif %}
    
            messages.forEach(msg => {
                const senderId = msg.sender_id.$oid;
                const recipientId = msg.recipient_id ? msg.recipient_id.$oid : null;
    
                // Partner is the "other person" in the conversation
                const partnerId = senderId === currentUserId ? recipientId : senderId;
                if (!partnerId) return;
    
                if (!conversations[partnerId]) {
                    conversations[partnerId] = {
                        username: userMap[partnerId] || (USER_ROLE === 'child' && PARENT_USERNAME ? PARENT_USERNAME : 'Family Member'),
                        messages: [],
                        hasUnread: false
                    };
                }
                conversations[partnerId].messages.push(msg);
    
                // hasUnread if the message is not read, and was not sent by the current user
                if (!msg.is_read && senderId !== currentUserId) {
                    conversations[partnerId].hasUnread = true;
                }
            });
    
            Object.keys(conversations).forEach(partnerId => {
                const convo = conversations[partnerId];
                convo.messages.sort((a, b) => new Date(a.sent_at.$date) - new Date(b.sent_at.$date));
    
                const replyFormAction = "{{ url_for('send_message') }}";
                // Everyone sets hidden input for the partner's ID
                const recipientInput = `<input type="hidden" name="recipient_id" value="${partnerId}">`;
                const placeholder = `Reply to ${convo.username}...`;
    
                const accordionItem = document.createElement('div');
                accordionItem.className = 'border border-gray-200 dark:border-gray-700 rounded-lg';
                accordionItem.innerHTML = `
                    <h2>
                        <button type="button" class="flex items-center justify-between w-full p-4 font-medium text-left text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700/50 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition">
                            <span>Conversation with ${convo.username}</span>
                            <div class="flex items-center gap-2">
                                ${convo.hasUnread ? '<span class="px-2 py-0.5 text-xs font-semibold text-blue-800 bg-blue-100 dark:bg-blue-900 dark:text-blue-200 rounded-full">New</span>' : ''}
                                <svg class="w-3 h-3 rotate-180 shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                            </div>
                        </button>
                    </h2>
                    <div class="hidden p-4 border-t border-gray-200 dark:border-gray-700">
                        <div class="space-y-4 max-h-72 overflow-y-auto custom-scrollbar pr-2 mb-4">
                            ${convo.messages.map(msg => {
                                const isSentByCurrentUser = msg.sender_id.$oid === currentUserId;
                                return `
                                <div class="flex ${isSentByCurrentUser ? 'justify-end' : 'justify-start'}">
                                    <div class="p-3 rounded-lg max-w-sm shadow ${isSentByCurrentUser ? 'bg-blue-500 text-white' : 'bg-white dark:bg-gray-600 text-gray-800 dark:text-gray-100'}">
                                        <p class="text-sm break-words">${msg.message_content}</p>
                                        <p class="text-xs mt-1 ${isSentByCurrentUser ? 'text-blue-100 text-right' : 'text-gray-500 dark:text-gray-400 text-left'}">${timeAgo(msg.sent_at.$date)}</p>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                        <form method="POST" action="${replyFormAction}" class="reply-form flex gap-2 items-start">
                            ${recipientInput}
                            <textarea name="message_content" rows="1" required class="flex-grow p-2 bg-white dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500 transition text-sm" placeholder="${placeholder}" oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';"></textarea>
                            <button type="submit" class="p-2 w-10 h-10 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition flex-shrink-0 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                            </button>
                        </form>
                    </div>`;
    
                container.appendChild(accordionItem);
            });
    
            // Accordion toggles
            container.querySelectorAll('button[type="button"]').forEach(button => {
                button.addEventListener('click', () => {
                    const content = button.parentElement.nextElementSibling;
                    const icon = button.querySelector('svg');
                    content.classList.toggle('hidden');
                    icon.classList.toggle('rotate-180');
                    if (!content.classList.contains('hidden')) {
                        const chatBox = content.querySelector('.max-h-72');
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                });
            });
    
            // If user is child, open the single conversation automatically, if only one
            if (USER_ROLE === 'child') {
                const singleAccordionBtn = container.querySelector('button[type="button"]');
                if (singleAccordionBtn) {
                    singleAccordionBtn.click();
                    singleAccordionBtn.querySelector('svg').classList.remove('rotate-180');
                }
            }
    
            // Mark unread messages as read
            const unreadMessageIds = messages
              .filter(m => !m.is_read && m.sender_id.$oid !== currentUserId)
              .map(m => m._id.$oid);
            if (unreadMessageIds.length > 0) {
                await fetch('/api/message/mark-read', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message_ids: unreadMessageIds
                    }),
                });
                document.getElementById('modal-message-badge')?.classList.add('hidden');
                document.querySelector('button[title="My Personal Space"] span')?.classList.add('hidden');
            }
    
        } catch (error) {
            console.error("Error fetching/displaying messages:", error);
            container.innerHTML = `<div class="text-center text-red-500 p-8">Error: Could not display messages.</div>`;
        }
    }
    
    // --- MAIN SCRIPT EXECUTION ---
    document.addEventListener("DOMContentLoaded", function() {
        // --- Basic UI Setup ---
        const mobileMenuButton = document.getElementById("mobile-menu-button");
        if (mobileMenuButton) {
            mobileMenuButton.addEventListener("click", () => openModal('mobileMenu'));
        }
        const familyModal = document.getElementById('manageFamilyModal');
        if (familyModal) {
            const tabButtonsFamily = familyModal.querySelectorAll('.tab-btn-family');
            const tabPanelsFamily = familyModal.querySelectorAll('.tab-panel-family');
    
            tabButtonsFamily.forEach(button => {
                button.addEventListener('click', () => {
                    // Deactivate all buttons
                    tabButtonsFamily.forEach(btn => {
                        btn.classList.remove('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
                        btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'dark:hover:text-gray-200');
                    });
                    // Activate the clicked button
                    button.classList.add('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
                    button.classList.remove('border-transparent', 'text-gray-500');
    
                    // Hide all panels
                    const targetPanelId = button.getAttribute('data-tab');
                    tabPanelsFamily.forEach(panel => {
                        panel.classList.toggle('hidden', panel.id !== targetPanelId);
                    });
                });
            });
        }
    
        const container = document.getElementById('particle-container');
        if (container) {
            const numParticles = 20;
            const pastelColors = ['rgba(255,182,193,0.5)', 'rgba(173,216,230,0.5)', 'rgba(240,230,140,0.5)', 'rgba(144,238,144,0.5)', 'rgba(221,160,221,0.5)'];
            for (let i = 0; i < numParticles; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                const size = Math.random() * 10 + 10;
                p.style.cssText = `width:${size}px; height:${size}px; left:${Math.random()*100}%; top:${Math.random()*100}%; animation-duration:${Math.random()*20+20}s; background-color:${pastelColors[Math.floor(Math.random()*pastelColors.length)]};`;
                container.appendChild(p);
            }
        }
    
        // --- Dark Mode ---
        const darkModeToggle = document.getElementById("darkModeToggle");
        const themeIconSun = document.getElementById("themeIconSun");
        const themeIconMoon = document.getElementById("themeIconMoon");
        const themeIconText = document.getElementById("themeIconText");
    
        let storedTheme = localStorage.getItem("theme") || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
        let inDarkMode = (storedTheme === 'dark');
    
        function updateThemeUI() {
            if (inDarkMode) {
                document.documentElement.classList.add("dark");
                themeIconSun.classList.remove('hidden');
                themeIconMoon.classList.add('hidden');
                if (themeIconText) themeIconText.innerText = 'Light Mode';
            } else {
                document.documentElement.classList.remove("dark");
                themeIconSun.classList.add('hidden');
                themeIconMoon.classList.remove('hidden');
                if (themeIconText) themeIconText.innerText = 'Dark Mode';
            }
        }
        updateThemeUI();
        if (darkModeToggle) {
            darkModeToggle.addEventListener("click", () => {
                inDarkMode = !inDarkMode;
                localStorage.setItem("theme", inDarkMode ? "dark" : "light");
                updateThemeUI();
            });
        }
    
        // --- Personal Space Modal Logic ---
        const personalStuffModal = document.getElementById('personalStuffModal');
        if (personalStuffModal) {
            const tabButtons = personalStuffModal.querySelectorAll('.tab-btn');
            const tabPanels = personalStuffModal.querySelectorAll('.tab-panel');
    
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => {
                        btn.classList.remove('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
                        btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'dark:hover:text-gray-200');
                    });
                    button.classList.add('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
                    button.classList.remove('border-transparent', 'text-gray-500');
    
                    const targetPanelId = button.getAttribute('data-tab');
                    tabPanels.forEach(panel => {
                        panel.classList.toggle('hidden', panel.id !== targetPanelId);
                    });
    
                    if (targetPanelId === 'messages-panel' && !document.getElementById('messages-panel').hasAttribute('data-loaded')) {
                        fetchAndDisplayMessages();
                    }
                });
            });
    
            // Compose logic for everyone
            const composeBtn = document.getElementById('compose-message-btn');
            const cancelBtn = document.getElementById('cancel-compose-btn');
            const composeContainer = document.getElementById('compose-message-form-container');
            const composeForm = document.getElementById('parent-compose-form');
    
            if (composeBtn && composeContainer && cancelBtn) {
                const toggleCompose = () => composeContainer.classList.toggle('hidden');
                composeBtn.addEventListener('click', toggleCompose);
                cancelBtn.addEventListener('click', toggleCompose);
            }
            if (composeForm) {
                composeForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    handleMessageSubmit(composeForm);
                });
            }
    
            const conversationContainer = document.getElementById('conversation-accordion-container');
            if (conversationContainer) {
                conversationContainer.addEventListener('submit', (e) => {
                    if (e.target.matches('.reply-form')) {
                        e.preventDefault();
                        handleMessageSubmit(e.target);
                    }
                });
            }
        }
    
        // Invite link copy
        const copyButton = document.getElementById('copy-button');
        if (copyButton) {
            copyButton.addEventListener('click', function() {
                const urlInput = document.getElementById('invite-url-input');
                navigator.clipboard.writeText(urlInput.value).then(() => {
                    document.getElementById('copy-icon').classList.add('hidden');
                    document.getElementById('check-icon').classList.remove('hidden');
                    setTimeout(() => {
                        document.getElementById('copy-icon').classList.remove('hidden');
                        document.getElementById('check-icon').classList.add('hidden');
                    }, 2000);
                });
            });
        }
    
        // Username suggestion
        const suggestBtn = document.getElementById('suggest-username-btn');
        if (suggestBtn) {
            const usernameInput = document.getElementById('username');
            const suggestionsContainer = document.getElementById('username-suggestions');
            const isParentRegistration = '{{ page }}' === 'register_parent';
    
            suggestBtn.addEventListener('click', async () => {
                const originalBtnText = suggestBtn.innerHTML;
                suggestBtn.innerHTML = 'Thinking...';
                suggestBtn.disabled = true;
                suggestionsContainer.innerHTML = '';
    
                const nameSeed = isParentRegistration ? usernameInput.value.trim() : '';
                try {
                    const response = await fetch('/api/suggest-username', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: nameSeed
                        })
                    });
                    if (!response.ok) throw new Error('Could not get suggestions.');
                    const data = await response.json();
                    if (data.suggestions && data.suggestions.length > 0) {
                        data.suggestions.forEach(suggestion => {
                            const suggBtn = document.createElement('button');
                            suggBtn.type = 'button';
                            suggBtn.textContent = suggestion;
                            suggBtn.className = 'px-3 py-1 text-sm text-blue-700 bg-blue-100 rounded-full hover:bg-blue-200 dark:bg-blue-900 dark:text-blue-200 dark:hover:bg-blue-800 transition-colors';
                            suggBtn.onclick = () => {
                                usernameInput.value = suggestion;
                                suggestionsContainer.innerHTML = '';
                            };
                            suggestionsContainer.appendChild(suggBtn);
                        });
                    } else {
                        suggestionsContainer.innerHTML = '<p class="text-sm text-gray-500">No suggestions available. Try typing a name first!</p>';
                    }
                } catch (error) {
                    console.error('Error fetching username suggestions:', error);
                    suggestionsContainer.innerHTML = '<p class="text-sm text-red-500">Could not load suggestions right now.</p>';
                } finally {
                    suggestBtn.innerHTML = originalBtnText;
                    suggestBtn.disabled = false;
                }
            });
        }
    
        // Calendar page
        if (document.getElementById('calendar')) {
            const calendarModal = document.getElementById('event-details-modal');
            const closeModalBtn = document.getElementById('modal-close-btn');
            const applyFiltersBtn = document.getElementById('apply-filters');
            const calendarEl = document.getElementById('calendar');

            closeModalBtn.onclick = () => calendarModal.classList.add('hidden');
            calendarModal.addEventListener('click', (e) => {
                if (e.target === calendarModal) {
                    calendarModal.classList.add('hidden');
                }
            });

            const getEventSourceUrl = () => {
                const params = new URLSearchParams({
                    search: document.getElementById('filter-search').value,
                    member: document.getElementById('filter-member').value,
                    type: document.getElementById('filter-type').value
                });
                return `/api/events?${params.toString()}`;
            };

            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,listWeek'
                },
                events: getEventSourceUrl(),
                eventClassNames: function(arg) {
                    if (arg.event.extendedProps.status === 'approved') {
                        return ['event-strikethrough'];
                    }
                    return [];
                },
                eventClick: function(info) {
                    const eProps = info.event.extendedProps;
                    document.getElementById('modal-title').innerText = info.event.title;
                    document.getElementById('modal-description').innerText = eProps.description || 'No description provided.';
                    document.getElementById('modal-assignee').innerHTML = `<strong>Assigned to:</strong> ${eProps.assignee_name}`;
                    document.getElementById('modal-points').innerHTML = `<strong>Points:</strong> ${eProps.points}`;
                    document.getElementById('modal-extra-info').innerHTML = `<strong>Type:</strong> ${eProps.type.charAt(0).toUpperCase() + eProps.type.slice(1)}`;

                    const statusColors = {
                        assigned: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300',
                        completed: 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-300',
                        approved: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300'
                    };
                    const statusText = eProps.status.charAt(0).toUpperCase() + eProps.status.slice(1);
                    document.getElementById('modal-status').innerHTML = `<strong>Status:</strong> <span class="px-2 py-0.5 ml-1 rounded-full text-xs font-semibold ${statusColors[eProps.status]}">${statusText}</span>`;

                    const actionsContainer = document.getElementById('modal-actions');
                    actionsContainer.innerHTML = ''; 

                    if (USER_ROLE === 'parent') {
                        if (eProps.status === 'completed') {
                            actionsContainer.innerHTML += `<a href="/event/approve/${eProps._id}" class="px-4 py-2 text-sm font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600 transition">Approve</a>`;
                        }
                    } else if (USER_ROLE === 'child' && eProps.assigned_to === currentUserId) {
                        if (eProps.type === 'chore' && eProps.status === 'assigned') {
                            actionsContainer.innerHTML += `<a href="/event/complete/${eProps._id}" class="px-4 py-2 text-sm font-semibold text-white bg-blue-500 rounded-lg hover:bg-blue-600 transition">Mark as Done</a>`;
                        } else if (eProps.type === 'habit' && eProps.can_checkin) {
                            actionsContainer.innerHTML += `<a href="/event/habit/checkin/${eProps._id}" class="px-4 py-2 text-sm font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600 transition">Check-in Today</a>`;
                        }
                    }

                    calendarModal.classList.remove('hidden');
                    setTimeout(() => {
                        calendarModal.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }, 100);
                },
                height: 'auto',
                progressiveEventRendering: true
            });
            calendar.render();

            applyFiltersBtn.addEventListener('click', () => {
                calendar.removeAllEventSources();
                calendar.addEventSource(getEventSourceUrl());
            });
        }
    });

    // Function to control the visibility of different states within the AI rewards modal
    function setSuggestRewardsModalState(state) {
        const states = ['start', 'loading', 'results'];
        states.forEach(s => {
            const el = document.getElementById(`suggest-rewards-${s}`);
            if (el) el.classList.add('hidden');
        });
        const activeEl = document.getElementById(`suggest-rewards-${state}`);
        if (activeEl) activeEl.classList.remove('hidden');
    }

    // Function called by the "Add to Store" buttons on suggested rewards
    async function addSuggestedReward(button, name, cost) {
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = 'Adding...';

        try {
            const response = await fetch("{{ url_for('add_store_reward') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'name': name,
                    'cost': cost
                })
            });

            if (!response.ok) {
                throw new Error('Failed to add the reward to the store.');
            }
            
            button.innerHTML = 'Added!';
            button.classList.remove('bg-green-600', 'hover:bg-green-700');
            button.classList.add('bg-gray-500', 'cursor-not-allowed');

        } catch (error) {
            console.error('Error adding suggested reward:', error);
            button.innerHTML = 'Error';
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 2000);
        }
    }
    
    // --- JINJA-DEPENDENT SCRIPT BLOCKS ---
    {% if page == 'family_dashboard' and stats is defined %}
    if (document.getElementById('weeklyCompletionChart')) {
        const weeklyCtx = document.getElementById('weeklyCompletionChart').getContext('2d');
        const weeklyData = {{ stats.weekly_completion_data | tojson }};
        const gradient = weeklyCtx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
        gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
        new Chart(weeklyCtx, {
            type: 'line',
            data: {
                labels: weeklyData.labels,
                datasets: [{
                    label: 'Tasks Completed',
                    data: weeklyData.data,
                    backgroundColor: gradient,
                    borderColor: '#3b82f6',
                    borderWidth: 2,
                    pointBackgroundColor: '#3b82f6',
                    pointRadius: 4,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        },
                        grid: {
                            drawBorder: false
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
    {% endif %}

    {% if page == 'dashboard_parent' %}
        // Logic for the "Approve All" button
        const approveAllBtn = document.getElementById('approve-all-btn');
        if (approveAllBtn) {
            approveAllBtn.addEventListener('click', async () => {
                const pendingItems = document.querySelectorAll('.pending-event-item');
                const eventIds = Array.from(pendingItems).map(item => item.dataset.eventId);

                if (eventIds.length === 0) {
                    alert("No items to approve.");
                    return;
                }
                approveAllBtn.disabled = true;
                approveAllBtn.textContent = 'Approving...';

                try {
                    const response = await fetch('/event/bulk_approve', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ event_ids: eventIds })
                    });
                    if (!response.ok) {
                        throw new Error('Approval request failed.');
                    }
                    window.location.reload();
                } catch (error) {
                    console.error('Bulk approval error:', error);
                    alert('An error occurred while approving tasks. Please try again.');
                    approveAllBtn.disabled = false;
                    approveAllBtn.textContent = 'Approve All';
                }
            });
        }
        
        // Logic for the "Suggest Rewards with AI" feature
        const suggestRewardsBtn = document.getElementById('suggest-rewards-btn');
        if (suggestRewardsBtn) {
            suggestRewardsBtn.addEventListener('click', () => {
                setSuggestRewardsModalState('start');
                openModal('suggest-rewards-modal');
            });
        }

        const generateSuggestionsBtn = document.getElementById('generate-suggestions-btn');
        if(generateSuggestionsBtn) {
            generateSuggestionsBtn.addEventListener('click', async () => {
                setSuggestRewardsModalState('loading');
                const theme = document.getElementById('reward-theme-input').value.trim();
                const suggestionsContainer = document.getElementById('suggestions-container');
                suggestionsContainer.innerHTML = '';

                try {
                    const response = await fetch('/api/reward/suggest', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ theme: theme })
                    });
                    if (!response.ok) {
                        throw new Error('Could not fetch suggestions from the AI service.');
                    }
                    const data = await response.json();
                    if (data.suggested_rewards && data.suggested_rewards.length > 0) {
                        data.suggested_rewards.forEach(reward => {
                            const rewardEl = document.createElement('div');
                            rewardEl.className = 'p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg flex justify-between items-center';
                            const sanitizedName = reward.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            rewardEl.innerHTML = `
                                <div>
                                    <p class="font-semibold text-gray-800 dark:text-gray-100">${reward.name}</p>
                                    <p class="text-sm text-secondary-600 dark:text-secondary-400 font-bold">${reward.cost} pts</p>
                                </div>
                                <button onclick="addSuggestedReward(this, '${sanitizedName}', ${reward.cost})" class="px-3 py-1.5 text-xs font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 transition">
                                    Add to Store
                                </button>
                            `;
                            suggestionsContainer.appendChild(rewardEl);
                        });
                    } else {
                        suggestionsContainer.innerHTML = '<p class="text-center text-gray-500">The AI could not generate suggestions. Please try again with a different theme.</p>';
                    }
                    setSuggestRewardsModalState('results');
                } catch (error) {
                    console.error("Error generating reward suggestions:", error);
                    setSuggestRewardsModalState('start');
                    alert(error.message);
                }
            });
        }

        // ✨ NEW: Logic for the "View Child's Day" Modal
        const familyMembersPanel = document.getElementById('family-members-panel');
        if (familyMembersPanel) {
            familyMembersPanel.addEventListener('click', e => {
                const viewButton = e.target.closest('.view-child-day-btn');
                if (viewButton) {
                    const childId = viewButton.dataset.childId;
                    const childName = viewButton.dataset.childName;
                    openChildDayView(childId, childName);
                }
            });
        }

        async function openChildDayView(childId, childName) {
            const modal = document.getElementById('child-day-modal');
            const titleEl = document.getElementById('child-day-modal-title');
            const contentEl = document.getElementById('child-day-modal-content');

            titleEl.textContent = `Viewing ${childName}'s Day`;
            contentEl.innerHTML = `
                <div class="text-center py-10">
                    <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-4 text-gray-500 dark:text-gray-400">Fetching tasks...</p>
                </div>`;
            openModal('child-day-modal');

            try {
                const response = await fetch(`/api/child-day/${childId}`);
                if (!response.ok) {
                    throw new Error('Could not fetch child data.');
                }
                const data = await response.json();
                renderChildTasks(contentEl, data);
            } catch (error) {
                console.error("Error fetching child's day:", error);
                contentEl.innerHTML = `<p class="text-center text-red-500 dark:text-red-400">${error.message}</p>`;
            }
        }

        function renderChildTasks(container, data) {
            let overdueHtml = `
                <h3 class="text-xl font-bold mb-4 flex items-center gap-3 text-gray-900 dark:text-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 9.586V6z" clip-rule="evenodd" /></svg>
                    Overdue
                </h3>
                <div class="space-y-3">`;

            if (data.overdue_events && data.overdue_events.length > 0) {
                data.overdue_events.forEach(event => {
                    const dueDate = new Date(event.due_date.$date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    overdueHtml += `
                        <div class="p-3 bg-red-50 dark:bg-red-900/20 rounded-lg flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-gray-800 dark:text-gray-100">${event.name}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Due: ${dueDate}</p>
                            </div>
                            <span class="px-2.5 py-0.5 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">Assigned</span>
                        </div>`;
                });
            } else {
                overdueHtml += `<p class="text-center py-4 text-gray-500 dark:text-gray-300">No overdue chores!</p>`;
            }
            overdueHtml += `</div>`;


            let todayHtml = `
                <h3 class="text-2xl font-bold mt-8 mb-4 flex items-center gap-3 text-gray-900 dark:text-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                    Today's Focus
                </h3>
                <div class="space-y-4">`;

            if (data.todays_events && data.todays_events.length > 0) {
                data.todays_events.forEach(event => {
                    const pointsHtml = `<div class="mt-2 text-sm font-bold text-purple-600 dark:text-purple-300 bg-purple-100 dark:bg-purple-900 px-2 py-0.5 rounded-full inline-block">+${event.points} pts</div>`;
                    let statusHtml = '';
                    
                    if (event.type === 'chore') {
                        if (event.status === 'assigned') statusHtml = `<span class="px-3 py-1 text-sm font-semibold text-yellow-800 bg-yellow-100 dark:bg-yellow-900 dark:text-yellow-300 rounded-full">Assigned</span>`;
                        else if (event.status === 'completed') statusHtml = `<span class="px-3 py-1 text-sm font-semibold text-indigo-800 bg-indigo-100 dark:bg-indigo-900 dark:text-indigo-300 rounded-full">Awaiting Approval</span>`;
                        else if (event.status === 'approved') statusHtml = `<span class="px-3 py-1 text-sm font-semibold text-green-800 bg-green-100 dark:bg-green-900 dark:text-green-300 rounded-full">Approved!</span>`;

                        todayHtml += `
                            <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg flex justify-between items-center">
                                <div>
                                    <h4 class="font-bold text-lg text-gray-800 dark:text-gray-100">${event.name}</h4>
                                    ${pointsHtml}
                                </div>
                                ${statusHtml}
                            </div>`;

                    } else if (event.type === 'habit') {
                        const streakHtml = `<span class="font-semibold text-orange-600 dark:text-orange-300 bg-orange-100 dark:bg-orange-900 px-2 py-0.5 rounded-full flex items-center gap-1">Streak: ${event.streak || 0}</span>`;
                        if (event.can_checkin) statusHtml = `<span class="px-3 py-1 text-sm font-semibold text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 rounded-full">Pending Check-in</span>`;
                        else statusHtml = `<span class="px-3 py-1 text-sm font-semibold text-green-800 bg-green-100 dark:bg-green-900 dark:text-green-300 rounded-full">Done for Today!</span>`;

                        todayHtml += `
                            <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg flex justify-between items-center">
                                <div>
                                    <h4 class="font-bold text-lg text-gray-800 dark:text-gray-100">${event.name}</h4>
                                     <div class="flex items-center gap-2 mt-2 text-sm">
                                        ${pointsHtml.replace('mt-2', '')} ${streakHtml}
                                     </div>
                                </div>
                                ${statusHtml}
                            </div>`;
                    }
                });
            } else {
                todayHtml += `<p class="text-center py-8 text-gray-500 dark:text-gray-300">Nothing scheduled for today. Great job!</p>`;
            }
            todayHtml += `</div>`;

            container.innerHTML = overdueHtml + todayHtml;
        }
    {% endif %}
    
    {% if current_user.is_authenticated and current_user.role == 'parent' %}
    let famJamPlanData = null;
    function setFamJamModalState(state) {
        const states = ['start', 'loading', 'review', 'applying', 'success', 'error'];
        states.forEach(s => document.getElementById(`famjam-${s}`)?.classList.add('hidden'));
        if (state) document.getElementById(`famjam-${state}`)?.classList.remove('hidden');
    }
    function openFamJamModal() {
        openModal('famjam-modal');
        document.getElementById('famjam-goal-input').value = '';
        document.getElementById('famjam-plan-content').innerHTML = '';
        setFamJamModalState('start');
    }
    async function generateFamJamPlan() {
        let goal = document.getElementById('famjam-goal-input').value.trim() || 'general family teamwork and responsibility';
        setFamJamModalState('loading');
        try {
            const response = await fetch('/api/famjam/suggest', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    goal: goal
                })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Failed to generate plan.');
            famJamPlanData = data;
            displayFamJamPlan(data, goal);
        } catch (e) {
            document.getElementById('famjam-error-message').textContent = e.message;
            setFamJamModalState('error');
        }
    }
    function gatherFamJamEdits() {
        if (document.getElementById('famjam-plan-name-input').value) {
            famJamPlanData.plan_name = document.getElementById('famjam-plan-name-input').value;
        }
        const container = document.getElementById('famjam-plan-content');
        const choreDivs = container.querySelectorAll('.famjam-chore-item');
        famJamPlanData.suggested_chores = Array.from(choreDivs).map(div => {
            const assignedToValue = div.querySelector('.famjam-chore-assigned-to').value;
            return {
                name: div.querySelector('.famjam-chore-name').value,
                description: div.querySelector('.famjam-chore-desc').value,
                points: parseInt(div.querySelector('.famjam-chore-points').value) || 50,
                recurrence: div.querySelector('.famjam-chore-recurrence').value,
                assigned_to: assignedToValue === '' ? null : assignedToValue
            };
        });
    }
    function removeChoreFromPlan(buttonEl) {
        buttonEl.closest('.famjam-chore-item').remove();
    }
    function addChoreToPlan() {
        if (!famJamPlanData) return;
        if (!famJamPlanData.suggested_chores) famJamPlanData.suggested_chores = [];
        const newChore = {
            name: 'New Chore',
            description: '',
            points: 50,
            recurrence: 'weekly',
            assigned_to: ''
        };
        const container = document.getElementById('famjam-plan-content');
        const newChoreEl = createChoreElement(newChore, famJamPlanData.suggested_chores.length);
        container.appendChild(newChoreEl);
        setTimeout(() => {
            newChoreEl.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
            newChoreEl.classList.add('bg-yellow-100', 'dark:bg-yellow-900/50');
            setTimeout(() => newChoreEl.classList.remove('bg-yellow-100', 'dark:bg-yellow-900/50'), 1500);
        }, 100);
    }
    function createChoreElement(chore, index) {
        const children = (typeof FAMILY_MEMBERS !== "undefined") ? FAMILY_MEMBERS.filter(m => m.role === 'child') : [];
        let assignedToId = chore.assigned_to;
        if (!assignedToId && children.length > 0) {
            assignedToId = '';
        }
        const el = document.createElement('div');
        el.className = 'famjam-chore-item p-3 bg-white dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-600 transition-colors duration-500';
        el.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <div>
                    <label class="text-xs font-semibold text-gray-600 dark:text-gray-300">Name</label>
                    <input type="text" class="famjam-chore-name w-full mt-1 px-2 py-1 rounded text-sm border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" value="${chore.name || ''}">
                </div>
                <div>
                    <label class="text-xs font-semibold text-gray-600 dark:text-gray-300">Points</label>
                    <input type="number" class="famjam-chore-points w-full mt-1 px-2 py-1 rounded text-sm border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" value="${chore.points || 50}">
                </div>
            </div>
            <div class="mt-2">
                <label class="text-xs font-semibold text-gray-600 dark:text-gray-300">Description</label>
                <textarea class="famjam-chore-desc w-full mt-1 px-2 py-1 rounded text-sm border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" rows="2">${chore.description || ''}</textarea>
            </div>
            <div class="mt-2 grid grid-cols-2 gap-2">
                <div>
                    <label class="text-xs font-semibold text-gray-600 dark:text-gray-300">Recurrence</label>
                    <select class="famjam-chore-recurrence w-full mt-1 px-2 py-1 rounded text-sm border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
                        <option value="daily" ${chore.recurrence === 'daily' ? 'selected' : ''}>Daily</option>
                        <option value="weekly" ${chore.recurrence === 'weekly' ? 'selected' : ''}>Weekly</option>
                        <option value="monthly" ${chore.recurrence === 'monthly' ? 'selected' : ''}>Monthly</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-semibold text-gray-600 dark:text-gray-300">Assigned To</label>
                    <select class="famjam-chore-assigned-to w-full mt-1 px-2 py-1 rounded text-sm border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
                        <option value="" ${assignedToId === '' ? 'selected' : ''}>-- Auto (Round Robin) --</option>
                        <option value="__ALL__" ${assignedToId === '__ALL__' ? 'selected' : ''}>All Children</option>
                        ${children.map(m => `<option value="${m._id}" ${assignedToId === m._id ? 'selected' : ''}>${m.username}</option>`).join('')}
                    </select>
                </div>
            </div>
            <div class="flex justify-end mt-3">
                <button type="button" class="px-3 py-1 text-sm font-medium bg-red-100 text-red-700 rounded hover:bg-red-200 dark:bg-red-900/50 dark:text-red-300 dark:hover:bg-red-900 transition" onclick="removeChoreFromPlan(this)">Remove</button>
            </div>`;
        return el;
    }
    function displayFamJamPlan(plan, goal) {
        const container = document.getElementById('famjam-plan-content');
        container.innerHTML = '';
        document.getElementById('famjam-plan-name-input').value = plan.plan_name;
        document.getElementById('famjam-date-range').textContent = `${plan.start_date_str} to ${plan.end_date_str}`;
    
        const goalEl = document.createElement('div');
        goalEl.className = 'mb-4 p-3 bg-blue-50 dark:bg-blue-900/50 border-l-4 border-blue-400 rounded-r-lg';
        goalEl.innerHTML = `<p class="text-sm text-gray-600 dark:text-gray-300">Generated for goal:</p><p class="font-semibold text-blue-800 dark:text-blue-200">${goal}</p>`;
        container.appendChild(goalEl);
    
        if (plan.suggested_chores && plan.suggested_chores.length > 0) {
            plan.suggested_chores.forEach((chore, index) => container.appendChild(createChoreElement(chore, index)));
        } else {
            container.innerHTML += '<p class="text-center text-gray-500 dark:text-gray-300">The AI did not suggest any chores. You can try regenerating.</p>';
        }
        setFamJamModalState('review');
    }
    async function applyFamJamPlan() {
        gatherFamJamEdits();
        setFamJamModalState('applying');
        try {
            const r = await fetch("{{url_for('apply_famjam_plan')}}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(famJamPlanData)
            });
            const d = await r.json();
            if (!r.ok) throw new Error(d.error || 'Failed to apply the plan.');
            document.getElementById('famjam-success-message').textContent = d.message;
            setFamJamModalState('success');
            setTimeout(() => {
                closeModal('famjam-modal');
                window.location.reload();
            }, 3000);
        } catch (e) {
            document.getElementById('famjam-error-message').textContent = e.message;
            setFamJamModalState('error');
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        const acceptBtn = document.getElementById('famjam-accept-btn');
        if (acceptBtn) acceptBtn.addEventListener('click', applyFamJamPlan);
    });
    {% endif %}
    
    {% if page in ['mood_dashboard_personal', 'mood_dashboard_family'] %}
    document.addEventListener('DOMContentLoaded', () => {
        let personalMoodChart, familyDailyChart, familyDistChart;
        if (document.getElementById('mood-grid')) {
            const moodGrid = document.getElementById('mood-grid'),
                  moodDateInput = document.getElementById('mood-date'),
                  consultAIBtn = document.getElementById('consult-ai-btn'),
                  aiResponseContent = document.getElementById('ai-response-content'),
                  MOOD_CONFIG = {{mood_config.moods | tojson}},
                  PERIODS = ['Morning', 'Afternoon', 'Evening'],
                  formatDate = d => d.toISOString().split('T')[0];
    
            moodDateInput.value = formatDate(new Date);
    
            const renderMoodGrid = () => {
                moodGrid.innerHTML = '';
                const chosenDate = moodDateInput.value;
                PERIODS.forEach(period => {
                    const cell = document.createElement('div');
                    cell.className = 'mood-grid-cell p-4 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer hover:shadow-lg';
                    cell.dataset.period = period;
                    cell.innerHTML = `
                        <h4 class="font-bold text-lg text-center text-gray-800 dark:text-gray-100">${period}</h4>
                        <div class="mood-selector mt-4 grid grid-cols-4 gap-2">
                            ${MOOD_CONFIG.map(m => `<button data-emoji="${m.emoji}" title="${m.desc}" class="text-3xl p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition">${m.emoji}</button>`).join('')}
                        </div>
                        <textarea class="mt-4 w-full p-2 bg-white dark:bg-gray-600 rounded-md border border-gray-300 dark:border-gray-500 text-sm" rows="2" placeholder="Add a note (optional)..."></textarea>
                        <button class="save-mood-btn mt-2 w-full py-2 px-4 text-sm font-semibold text-white bg-blue-500 rounded-lg hover:bg-blue-600 transition">Save Mood</button>`;
                    moodGrid.appendChild(cell);
                    fetchMoodForCell(cell, chosenDate, period);
                });
            };
            const fetchMoodForCell = async (cell, dateStr, period) => {
        const res = await fetch(`/api/mood/personal?date=${dateStr}&period=${period}`);
        if (res.ok) {
          const data = await res.json();
          if (data && data.mood_emoji) {
            cell.querySelector('textarea').value = data.note || '';
            const sele = cell.querySelector(`button[data-emoji="${data.mood_emoji}"]`);
            if (sele) {
              sele.classList.add('bg-blue-200', 'dark:bg-blue-800', 'ring-2', 'ring-blue-500');
            }
          }
        }
      };
            moodGrid.addEventListener('click', async e => {
                const cell = e.target.closest('.mood-grid-cell');
                if (!cell) return;
                if (e.target.closest('.mood-selector button')) {
                    const btn = e.target.closest('.mood-selector button');
                    cell.querySelectorAll('.mood-selector button').forEach(b => b.classList.remove('bg-blue-200', 'dark:bg-blue-800', 'ring-2', 'ring-blue-500'));
                    btn.classList.add('bg-blue-200', 'dark:bg-blue-800', 'ring-2', 'ring-blue-500');
                }
                if (e.target.classList.contains('save-mood-btn')) {
                    const selectedEmojiBtn = cell.querySelector('.mood-selector button.bg-blue-200');
                    if (!selectedEmojiBtn) return alert('Please select a mood first.');
                    const payload = {
                        date: moodDateInput.value,
                        period: cell.dataset.period,
                        emoji: selectedEmojiBtn.dataset.emoji,
                        note: cell.querySelector('textarea').value
                    };
                    const r = await fetch('/api/mood/log', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    if (r.ok) {
                        e.target.textContent = 'Saved!';
                        setTimeout(() => e.target.textContent = 'Save Mood', 2000);
                        updatePersonalMoodChart();
                    } else {
                        alert('Failed to save mood.');
                    }
                }
            });
            moodDateInput.addEventListener('change', renderMoodGrid);
    
            const updatePersonalMoodChart = async () => {
                const r = await fetch('/api/mood/personal');
                const d = await r.json();
                if (personalMoodChart) personalMoodChart.destroy();
                const c = document.getElementById('personalMoodChart').getContext('2d');
                personalMoodChart = new Chart(c, {
                    type: 'line',
                    data: {
                        labels: d.labels,
                        datasets: [{
                            label: 'My Mood Score',
                            data: d.data,
                            borderColor: '#ec4899',
                            backgroundColor: 'rgba(236, 72, 153, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 4,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            };
            renderMoodGrid();
            updatePersonalMoodChart();
    
            consultAIBtn.addEventListener('click', async () => {
                aiResponseContent.innerHTML = '<p>Consulting the AI... Please wait.</p>';
                openModal('ai-modal');
                try {
                    const res = await fetch('/api/consult-ai', {
                        method: 'POST'
                    });
                    const data = await res.json();
                    aiResponseContent.innerHTML = res.ok ? marked.parse(data.ai_response) : `<p class="text-red-500">Error: ${data.error}</p>`;
                } catch (e) {
                    aiResponseContent.innerHTML = `<p class="text-red-500">Error: Could not connect to the AI service.</p>`;
                }
            });
        }
    
        if (document.getElementById('familyDailyAverageChart')) {
            const fetchFamilyData = async () => {
                const res = await fetch('/api/mood/family');
                const data = await res.json();
                if (familyDailyChart) familyDailyChart.destroy();
                if (familyDistChart) familyDistChart.destroy();
                const c = document.getElementById('familyDailyAverageChart').getContext('2d');
                familyDailyChart = new Chart(c, {
                    type: 'line',
                    data: {
                        labels: data.daily_average.labels,
                        datasets: [{
                            label: 'Daily Avg Mood',
                            data: data.daily_average.data,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 4
                            }
                        }
                    }
                });
                const a = document.getElementById('familyDistributionChart').getContext('2d');
                familyDistChart = new Chart(a, {
                    type: 'doughnut',
                    data: {
                        labels: data.distribution.labels,
                        datasets: [{
                            data: data.distribution.data,
                            backgroundColor: data.distribution.colors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            };
            fetchFamilyData();
        }
    });
    {% endif %}
</script>
</body>
</html>