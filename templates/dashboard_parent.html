{% extends "base.html" %}

{% block title %}Parent Dashboard - FAMJAM{% endblock %}

{% block content %}
<div class="space-y-8">

  {# FamJam Plan Management Card #}
  <section role="region" aria-labelledby="plan-heading" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl">
    <h2 id="plan-heading" class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100">FamJam Plan Management</h2>
    <p class="text-gray-600 dark:text-gray-300 mb-6">
      View your active plan, edit tasks, or generate a brand new AI-powered plan for the upcoming quarter.
    </p>
    <div class="flex flex-col sm:flex-row gap-4">
      <a href="{{ url_for('manage_plan') }}" class="flex-1 text-center px-6 py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition shadow-md hover:shadow-lg">
        Manage Active Plan
      </a>
      <button onclick="openFamJamModal()" class="flex-1 px-6 py-3 font-semibold text-white bg-secondary-500 rounded-lg hover:bg-secondary-600 transition shadow-md hover:shadow-lg">
        Generate New AI Plan
      </button>
      <button onclick="openCalendarModal()" class="flex-1 px-6 py-3 font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition shadow-md hover:shadow-lg flex items-center justify-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
        View Calendar
      </button>
    </div>
  </section>

  {# --- NEW: Mobile Tab Navigation --- #}
  <div class="sm:hidden mb-4 border-b border-gray-200 dark:border-gray-700">
    <nav class="flex -mb-px" aria-label="Tabs">
      <button id="tab-actions-btn" class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm border-blue-500 text-blue-600 dark:text-blue-400" aria-current="page">
        Actions
      </button>
      <button id="tab-family-btn" class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-600">
        Family Overview
      </button>
    </nav>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    {# Left Column: Family Overview (HIDDEN on mobile by default) #}
    <main id="tab-family-content" class="lg:col-span-2 space-y-6 hidden sm:block">
      <h2 id="family-overview-heading" class="text-3xl font-bold text-gray-900 dark:text-gray-100">Family Overview</h2>
      
      {% if child_dashboard_data %}
        {% for child in child_dashboard_data %}
        <section role="region" aria-labelledby="child-heading-{{ child._id }}" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl hover:shadow-lg transition-shadow">
          <div class="flex flex-col sm:flex-row justify-between sm:items-start gap-4">
            <div>
              <h3 id="child-heading-{{ child._id }}" class="text-2xl font-bold text-gray-800 dark:text-gray-100">{{ child.username }}</h3>
              <p class="text-lg font-semibold text-blue-600 dark:text-blue-400">{{ child.points }} points</p>
              {# Display Current Cash Balance #}
              <p class="text-lg font-semibold text-green-600 dark:text-green-400 mt-1">
                  Balance: ${{ "%.2f"|format(child.cash_balance|default(0.0)) }} üí∞
              </p>

              {# --- Mood Status Block for Child --- #}
              <div class="mt-4">
                <h4 id="mood-log-heading-{{ child._id }}" class="text-sm font-semibold text-gray-700 dark:text-gray-300">Today's Mood Log</h4>
                <div class="flex items-center gap-2 mt-2 flex-wrap" role="group" aria-labelledby="mood-log-heading-{{ child._id }}">
                  {% set periods = ['Morning', 'Afternoon', 'Evening'] %}
                  {% for period in periods %}
                    {% if period in child.today_moods_logged %}
                      {# Logged #}
                      <span class="flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200" title="Logged for {{ period }}">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg>
                        {{ period }}
                      </span>
                    {% else %}
                      {# Not Logged #}
                      <span class="flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300" title="Not logged for {{ period }}">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" /></svg>
                        {{ period }}
                      </span>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
              {# --- END Child Mood Status Block --- #}

              {# --- Academic Info Block for Child --- #}
              {% if child.academic_info %}
              <div class="mt-4">
                <h4 id="academic-heading-{{ child._id }}" class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">School Info üìö</h4>
                <div class="space-y-1 text-sm text-gray-600 dark:text-gray-400">
                  {% if child.academic_info.current_grade %}
                    <p><span class="font-medium">Grade:</span> {{ child.academic_info.current_grade }}</p>
                  {% endif %}
                  {% if child.academic_info.school_name %}
                    <p><span class="font-medium">School:</span> {{ child.academic_info.school_name }}</p>
                  {% endif %}
                  {% if child.academic_info.classes and child.academic_info.classes|length > 0 %}
                    <div class="mt-2">
                      <p class="font-medium mb-1">Classes:</p>
                      <ul class="list-disc list-inside space-y-0.5 ml-2">
                        {% for class_info in child.academic_info.classes %}
                        <li>
                          {{ class_info.name }}
                          {% if class_info.teacher_email %}
                            <span class="text-xs text-gray-500 dark:text-gray-500">({{ class_info.teacher_email }})</span>
                          {% endif %}
                        </li>
                        {% endfor %}
                      </ul>
                    </div>
                  {% endif %}
                </div>
              </div>
              {% endif %}
              {# --- END Academic Info Block --- #}

            </div>
            {# Pass data attributes directly to the button #}
            <button onclick="openChildDayView('{{ child._id }}', '{{ child.username }}')"
                    class="view-child-day-btn w-full sm:w-auto px-4 py-2 text-sm font-semibold text-white bg-blue-500 rounded-lg hover:bg-blue-600 transition">
              View Day's Tasks
            </button>
          </div>

          {# --- Child Controls: Cash & Points --- #}
          <fieldset class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
            <legend class="text-base font-semibold text-gray-800 dark:text-gray-100 mb-4">Parent Controls</legend>
            <div class="flex flex-wrap items-end gap-4">
              {# Form to Update Cash Balance #}
              <form action="{{ url_for('update_cash_balance', child_id=child._id) }}" method="POST" class="flex items-end gap-2 flex-grow sm:flex-grow-0">
                  <div>
                      <label for="cash_balance_{{ child._id }}" class="block text-xs font-medium text-gray-500 dark:text-gray-400">Update Balance ($)</label>
                      <input type="number" step="0.01" min="0" name="new_balance" id="cash_balance_{{ child._id }}"
                             placeholder="{{ "%.2f"|format(child.cash_balance|default(0.0)) }}"
                             required
                             class="mt-1 block w-full px-3 py-1.5 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                             style="min-width: 100px;">
                  </div>
                  <button type="submit"
                          class="px-4 py-1.5 text-sm font-semibold text-white bg-green-600 rounded-md hover:bg-green-700 transition focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-green-500 h-[36px]">
                      Set
                  </button>
              </form>

              {# Form to Reset Points #}
              <form action="{{ url_for('reset_child_points', child_id=child._id) }}" method="POST" class="flex items-end"
                    onsubmit="return confirm('Are you sure you want to reset {{ child.username }}\'s current points to 0? This cannot be undone.');">
                  <div>
                      <label for="reset_points_{{ child._id }}" class="block text-xs font-medium text-gray-500 dark:text-gray-400">Reset Points</label>
                      <button type="submit" id="reset_points_{{ child._id }}"
                              class="mt-1 px-4 py-1.5 text-sm font-semibold text-white bg-red-600 rounded-md hover:bg-red-700 transition focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-red-500 h-[36px]">
                          Reset POINTS
                      </button>
                  </div>
              </form>

              {# Form to Forgive Missed Tasks #}
              <form action="{{ url_for('forgive_child_missed_tasks', child_id=child._id) }}" method="POST" class="flex items-end"
                    onsubmit="return confirm('Are you sure you want to forgive all of {{ child.username }}\'s missed tasks? This clears their penalty count but does NOT restore points.');">
                  <div>
                      <label for="forgive_missed_{{ child._id }}" class="block text-xs font-medium text-gray-500 dark:text-gray-400">Forgive Tasks</label>
                      <button type="submit" id="forgive_missed_{{ child._id }}"
                              class="mt-1 px-4 py-1.5 text-sm font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 transition focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-500 h-[36px]">
                          Forgive MISSED
                      </button>
                  </div>
              </form>
            </div>
          </fieldset>
          {# --- End Child Controls --- #}


          <div class="mt-6 space-y-6">
            {# ... Today's Progress ... #}
             <div aria-labelledby="progress-heading-{{ child._id }}">
              <div class="flex justify-between mb-1 items-center">
                <h4 id="progress-heading-{{ child._id }}" class="text-base font-medium text-gray-700 dark:text-gray-200">Today's Progress</h4>
                <span class="text-sm font-medium text-gray-700 dark:text-gray-200">{{ child.today.completed }}/{{ child.today.total }} Done</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700"
                   role="progressbar" aria-valuenow="{{ child.today.progress }}" aria-valuemin="0" aria-valuemax="100" aria-labelledby="progress-heading-{{ child._id }}">
                <div class="bg-green-500 h-2.5 rounded-full transition-all duration-500" style="width: {{ child.today.progress }}%"></div>
              </div>
              <div class="mt-2 flex items-center justify-end gap-3 text-xs">
                {% if child.today.overdue > 0 %}
                <span class="px-2 py-0.5 rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300 font-medium">{{ child.today.overdue }} Overdue</span>
                {% endif %}
                {% if child.today.missed > 0 %}
                <span class="px-2 py-0.5 rounded-full bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-300 font-medium">{{ child.today.missed }} Missed Today</span>
                {% endif %}
              </div>
            </div>

            {# ... Weekly Stats ... #}
             <div>
               <h4 id="weekly-stats-heading-{{ child._id }}" class="text-base font-medium text-gray-700 dark:text-gray-200 mb-3">Weekly Stats</h4>
               <ul class="grid grid-cols-2 gap-4 text-center" role="group" aria-labelledby="weekly-stats-heading-{{ child._id }}">
                 <li class="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                   <p class="text-sm text-gray-500 dark:text-gray-400">Tasks This Week</p>
                   <p class="text-xl font-bold text-gray-800 dark:text-gray-100">{{ child.week.total_tasks }}</p>
                 </li>
                 <li class="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                   <p class="text-sm text-gray-500 dark:text-gray-400">Potential Points</p>
                   <p class="text-xl font-bold text-green-600 dark:text-green-400">{{ child.week.potential_points }}</p>
                 </li>
                 <li class="p-3 bg-red-50 dark:bg-red-900/30 rounded-lg">
                   <p class="text-sm text-red-700 dark:text-red-300">Missed This Week</p>
                   <p class="text-xl font-bold text-red-600 dark:text-red-400">{{ child.week.missed_count }}</p>
                 </li>
                 <li class="p-3 bg-orange-50 dark:bg-orange-900/30 rounded-lg">
                   <p class="text-sm text-orange-700 dark:text-orange-300">Penalty Incurred</p>
                   <p class="text-xl font-bold text-orange-600 dark:text-orange-400">
                     {% if child.week.penalty_incurred > 0 %}-{% endif %}{{ child.week.penalty_incurred }} pts
                   </p>
                 </li>
               </ul>
             </div>
          </div>
        </section>
        {% endfor %} {# End of child loop #}
      {% else %}
        <div class="text-center py-12 bg-white dark:bg-gray-800 rounded-2xl shadow-xl border-2 border-dashed border-gray-300 dark:border-gray-600">
          <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /> </svg>
          <h3 class="mt-2 text-xl font-semibold text-gray-700 dark:text-gray-200">No Children Found</h3>
          <p class="text-gray-500 dark:text-gray-400 mt-1">Add a child via the 'Manage Family' button to start assigning tasks!</p>
        </div>
      {% endif %}
    </main>

    {# Right Column: Mood Logger, Quick Add, Approvals, Rewards (SHOWN on mobile by default) #}
    <aside id="tab-actions-content" class="lg:col-span-1 space-y-6" role="complementary">

      {# --- NEW: Personal Mood Logger --- #}
      <section role="region" aria-labelledby="mood-heading" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl collapse-section">
        <button onclick="toggleSection(this)" class="w-full flex justify-between items-center mb-4 focus:outline-none">
          <h3 id="mood-heading" class="text-xl font-bold text-gray-900 dark:text-gray-100">How are you feeling today? üòä</h3>
          <svg class="w-5 h-5 text-gray-500 dark:text-gray-400 transition-transform section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        <div class="section-content">
        <div id="mood-logger" class="space-y-4">
          {% set periods = ['Morning', 'Afternoon', 'Evening'] %}
          {% for period in periods %}
          <div class="mood-period-section" data-period="{{ period }}">
            <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">{{ period }}</h4>
            <div class="flex justify-around items-center gap-2">
              {% for mood in MOOD_CONFIG.moods %}
              <button
                class="mood-button flex-1 p-2 rounded-lg text-3xl transition-all duration-150 ease-in-out border-2 border-transparent hover:scale-110 focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800"
                data-emoji="{{ mood.emoji }}"
                title="{{ mood.desc }}"
                style="--mood-color: {{ mood.color }}; background-color: var(--mood-color-light, #f3f4f6); --mood-color-light: {{ mood.color }}1A;"
                onmouseover="this.style.backgroundColor = 'var(--mood-color, #e5e7eb)';"
                onmouseout="if (!this.classList.contains('selected-mood')) this.style.backgroundColor = 'var(--mood-color-light, #f3f4f6)';"
                >
                {{ mood.emoji }}
              </button>
              {% endfor %}
            </div>
            {# --- NEW: OPTIONAL NOTE --- #}
            <div class="mt-2.5">
              <label for="mood-note-{{ period }}" class="sr-only">Optional note for {{ period }}</label>
              <input type="text" id="mood-note-{{ period }}" name="mood-note-{{ period }}"
                     placeholder="Add a quick note... (optional)"
                     class="mood-note-input w-full text-sm px-3 py-1.5 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 transition"
                     data-period="{{ period }}">
            </div>
            <p class="text-xs text-center mt-2 text-gray-500 dark:text-gray-400 status-text"></p> {# Status text area #}
          </div>
          {% endfor %}
        </div>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-4">Click an emoji to log your mood. You can also add an optional note.</p>
        <a href="{{ url_for('mood_dashboard_personal') }}" class="block text-center mt-4 text-sm font-medium text-blue-600 dark:text-blue-400 hover:underline">
          View Mood History &rarr;
        </a>
        </div>
      </section>
      {# --- END: Personal Mood Logger --- #}

      {# Quick Add Task Form #}
      <section role="region" aria-labelledby="quick-add-heading" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl collapse-section">
        <button onclick="toggleSection(this)" class="w-full flex justify-between items-center mb-4 focus:outline-none">
          <h3 id="quick-add-heading" class="text-xl font-bold text-gray-900 dark:text-gray-100">Assign a New Task</h3>
          <svg class="w-5 h-5 text-gray-500 dark:text-gray-400 transition-transform section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        <div class="section-content">
        <form method="POST" action="{{ url_for('create_event') }}" class="space-y-4">
          <div>
            <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Task Name</label>
            <input type="text" name="name" id="name" placeholder="e.g. Clean your room" class="mt-1 block w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" required />
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="type" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Type</label>
              <select name="type" id="type" class="mt-1 block w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                <option value="chore">Chore</option>
                <option value="habit">Habit</option>
              </select>
            </div>
            <div>
              <label for="points" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Points</label>
              <input type="number" name="points" id="points" min="1" placeholder="50" class="mt-1 block w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" required />
            </div>
          </div>
          <div>
            <label for="assigned_to" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Assign To</label>
            <select name="assigned_to" id="assigned_to" class="mt-1 block w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" required>
              <option value="">Select a child...</option>
              <option value="__ALL__">All Children</option>
              <option value="__ROUND_ROBIN__">Round Robin (Auto)</option>
              {% for member in family_members if member.role == 'child' %}
              <option value="{{ member._id }}">{{ member.username }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="recurrence" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Repeats</label>
              <select name="recurrence" id="recurrence" class="mt-1 block w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                <option value="none">Never (One-time)</option>
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
              </select>
            </div>
            <div>
              <label for="due_date" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Due Date</label>
              <input type="date" name="due_date" id="due_date" class="mt-1 block w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" required />
            </div>
          </div>
          <button type="submit" class="w-full mt-4 py-2.5 px-6 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition shadow hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-800">
            Add Task
          </button>
        </form>
        </div>
      </section>

      {# Pending Approvals Card #}
      <section role="region" aria-labelledby="approvals-heading" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl collapse-section">
        <button onclick="toggleSection(this)" class="w-full flex justify-between items-center mb-4 focus:outline-none">
          <h3 id="approvals-heading" class="text-xl font-bold text-gray-900 dark:text-gray-100">Pending Approvals ({{ pending_events|length }})</h3>
          <div class="flex items-center gap-2">
            {% if pending_events %}
            <button id="approve-all-btn" onclick="event.stopPropagation()" class="px-3 py-1 text-xs font-semibold text-white bg-green-600 rounded-full hover:bg-green-700 transition focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-green-500">
              Approve All
            </button>
            {% endif %}
            <svg class="w-5 h-5 text-gray-500 dark:text-gray-400 transition-transform section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </div>
        </button>
        <div class="section-content">
        <div id="pending-approvals-container">
          {% if pending_events %}
          <ul class="space-y-3 max-h-60 overflow-y-auto custom-scrollbar pr-2"> {# Adjusted spacing #}
            {% for event in pending_events %}
            <li data-event-id="{{ event._id }}" class="pending-event-item flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg hover:shadow-md transition-shadow">
              <div>
                <p class="font-semibold text-gray-800 dark:text-gray-100">{{ event.name }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">
                  by <span class="font-medium">{{ member_map.get(event.assigned_to|string, 'Unknown') }}</span>
                  <span class="font-bold text-green-600 dark:text-green-400 ml-2">{{ event.points }} pts</span>
                </p>
              </div>
              <a href="{{ url_for('approve_event', event_id=event._id) }}" class="p-2 text-white bg-green-500 rounded-full hover:bg-green-600 transition-transform transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-green-500" title="Approve this task">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
              </a>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="text-center py-8 text-gray-500 dark:text-gray-400">No tasks are pending approval.</p>
          {% endif %}
        </div>
        </div>
      </section>

       {# Pending Excuse Requests Card #}
      <section role="region" aria-labelledby="excuses-heading" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl collapse-section">
        <button onclick="toggleSection(this)" class="w-full flex justify-between items-center mb-4 focus:outline-none">
          <h3 id="excuses-heading" class="text-xl font-bold text-gray-900 dark:text-gray-100">Pending Excuse Requests ({{ pending_excuses|length }})</h3>
          <svg class="w-5 h-5 text-gray-500 dark:text-gray-400 transition-transform section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        <div class="section-content">
        <div class="space-y-3 max-h-60 overflow-y-auto custom-scrollbar pr-2">
          {% if pending_excuses %}
            <ul class="space-y-3">
            {% for excuse in pending_excuses %}
              <li class="p-4 bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-lg">
                <div class="flex flex-col gap-3">
                  <div>
                    <p class="font-semibold text-gray-800 dark:text-gray-100">{{ excuse.task_name }}</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                      Requested by <span class="font-medium">{{ excuse.child_username }}</span>
                      <span class="font-bold text-orange-600 dark:text-orange-400 ml-2">{{ excuse.task_points }} pts</span>
                      {% if excuse.requested_at_pretty %}
                        <span class="text-gray-400 dark:text-gray-500 ml-2">‚Ä¢ {{ excuse.requested_at_pretty }}</span>
                      {% endif %}
                    </p>
                  </div>
                  <div class="bg-white dark:bg-gray-700/50 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                    <p class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Explanation:</p>
                    <p class="text-sm text-gray-700 dark:text-gray-300">{{ excuse.explanation }}</p>
                  </div>
                  <form action="{{ url_for('approve_excuse', excuse_id=excuse._id) }}" method="POST" class="flex items-center gap-2 flex-shrink-0">
                    <button type="submit" class="flex-1 px-3 py-2 text-sm font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600 transition focus:outline-none focus:ring-2 focus:ring-green-500">Approve & Forgive</button>
                  </form>
                  <form action="{{ url_for('deny_excuse', excuse_id=excuse._id) }}" method="POST" class="flex items-center gap-2 flex-shrink-0">
                    <button type="submit" class="flex-1 px-3 py-2 text-sm font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500 transition focus:outline-none focus:ring-2 focus:ring-gray-400">Deny</button>
                  </form>
                </div>
              </li>
            {% endfor %}
            </ul>
          {% else %}
            <p class="text-center py-8 text-gray-500 dark:text-gray-300">No excuse requests are pending.</p>
          {% endif %}
        </div>
        </div>
      </section>

       {# Pending Reward Requests Card #}
      <section role="region" aria-labelledby="rewards-heading" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl collapse-section">
        <button onclick="toggleSection(this)" class="w-full flex justify-between items-center mb-4 focus:outline-none">
          <h3 id="rewards-heading" class="text-xl font-bold text-gray-900 dark:text-gray-100">Pending Reward Requests</h3>
          <svg class="w-5 h-5 text-gray-500 dark:text-gray-400 transition-transform section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        <div class="section-content">
        <div class="space-y-3 max-h-60 overflow-y-auto custom-scrollbar pr-2">
          {% if pending_rewards %}
            <ul class="space-y-3">
            {% for req in pending_rewards %}
              <li class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-2">
                  <div>
                    <p class="font-semibold text-gray-800 dark:text-gray-100">{{ req.reward_name }}</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                      Requested by <span class="font-medium">{{ req.username }}</span>
                      <span class="font-bold text-yellow-600 dark:text-yellow-400 ml-2">{{ req.cost }} pts</span>
                    </p>
                  </div>
                  {# Ensure this form submits correctly #}
                  <form action="{{ url_for('resolve_reward_request', request_id=req._id) }}" method="POST" class="flex items-center gap-2 mt-3 sm:mt-0 flex-shrink-0">
                    <button type="submit" name="action" value="approve" class="px-3 py-1 text-xs font-semibold text-white bg-green-500 rounded-full hover:bg-green-600 transition focus:outline-none focus:ring-1 focus:ring-green-500">Approve</button>
                    <button type="submit" name="action" value="deny" class="px-3 py-1 text-xs font-semibold text-gray-700 bg-gray-200 rounded-full hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500 transition focus:outline-none focus:ring-1 focus:ring-gray-400">Deny</button>
                  </form>
                </div>
              </li>
            {% endfor %}
            </ul>
          {% else %}
            <p class="text-center py-8 text-gray-500 dark:text-gray-300">No reward requests are pending.</p>
          {% endif %}
        </div>
        </div>
      </section>
    </aside>
  </div>

  {# Family Timers #}
  <section role="region" aria-labelledby="timers-heading" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl hover:shadow-lg transition-shadow collapse-section">
    <button onclick="toggleSection(this)" class="w-full flex justify-between items-center mb-4 focus:outline-none">
      <h2 id="timers-heading" class="text-2xl font-bold text-gray-900 dark:text-gray-100">Family Timers ‚è≥</h2>
      <svg class="w-5 h-5 text-gray-500 dark:text-gray-400 transition-transform section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
      </svg>
    </button>
    <div class="section-content">
    <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">
      Everyone can create a timer to count down to a special day or event.
    </p>
    {# Add Timer Form #}
    <form method="POST" action="{{ url_for('create_timer') }}" class="flex flex-col md:flex-row gap-3 mb-6 p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-700/30">
      <div class="flex-grow">
        <label for="timer-name" class="sr-only">Timer Name</label>
        <input type="text" name="name" id="timer-name" placeholder="Timer Name (e.g. 'Vacation Day!')"
               class="w-full px-4 py-2 bg-white dark:bg-gray-700 dark:text-gray-100
                      border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" required>
      </div>
      <div>
        <label for="timer-end-date" class="sr-only">End Date</label>
        <input type="date" name="end_date" id="timer-end-date"
               class="w-full px-4 py-2 bg-white dark:bg-gray-700 dark:text-gray-100
                      border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" required
               min="{{ now.strftime('%Y-%m-%d') }}"> {# Prevent selecting past dates #}
      </div>
      <button type="submit"
              class="px-5 py-2.5 text-white bg-blue-600 hover:bg-blue-700 rounded-lg
                     transition font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-800 flex-shrink-0">
        Add Timer
      </button>
    </form>
    {# Timer Tabs #}
    <div class="border-b border-gray-200 dark:border-gray-700 mb-4">
      <nav class="-mb-px flex space-x-6" aria-label="Timer Tabs">
        <button data-timer-tab="active-timers" class="timer-tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600 dark:text-blue-400">
          Active Timers
        </button>
        <button data-timer-tab="expired-timers" class="timer-tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-600">
          Expired Timers
          {% if unseen_expired_count > 0 %}
            <span class="ml-2 py-0.5 px-2 rounded-full text-xs font-medium bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-200">
              {{ unseen_expired_count }}
            </span>
          {% endif %}
        </button>
      </nav>
    </div>
    
    {# Active Timers Panel #}
    <div id="active-timers-panel" class="timer-tab-panel">
      <div class="max-h-72 overflow-y-auto custom-scrollbar pr-2">
        {% if active_timers %}
          <ul class="space-y-3">
          {% for timer in active_timers|sort(attribute='end_datetime') %}
          <li class="flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50
                       border border-gray-200 dark:border-gray-600 rounded-lg
                       hover:shadow-md transition-shadow gap-2">
            <div>
              <p class="font-semibold text-gray-800 dark:text-gray-100">
                {{ timer.name }}
              </p>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                Created by {{ timer.creator_name }} &bull; Ends on <strong>{{ timer.end_date }}</strong>
              </p>
            </div>
            <div class="flex items-center gap-2 mt-2 sm:mt-0">
               <span class="text-sm font-bold bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-200 px-3 py-1 rounded-full whitespace-nowrap">
                 {{ timer.time_left }}
               </span>
               {% if timer.creator_id == current_user.id or current_user.role == 'parent' %}
                  <a href="{{ url_for('delete_timer', timer_id=timer._id) }}"
                     onclick="return confirm('Delete this timer?')"
                     class="p-1.5 text-red-500 bg-red-100 dark:bg-red-900/50 rounded-full hover:bg-red-200 dark:hover:bg-red-800 transition" title="Delete Timer">
                      <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                   </a>
               {% endif %}
            </div>
          </li>
          {% endfor %}
          </ul>
        {% else %}
          <p class="text-center py-6 text-gray-500 dark:text-gray-300">
            No active timers. Add one above!
          </p>
        {% endif %}
      </div>
    </div>
    
    {# Expired Timers Panel #}
    <div id="expired-timers-panel" class="timer-tab-panel hidden">
      <div class="max-h-72 overflow-y-auto custom-scrollbar pr-2">
        {% if expired_timers %}
          <ul class="space-y-3">
          {% for timer in expired_timers|sort(attribute='end_datetime', reverse=True) %}
          <li class="flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50
                       border border-gray-200 dark:border-gray-600 rounded-lg
                       hover:shadow-md transition-shadow gap-2
                       {% if not timer.seen %}ring-2 ring-red-300 dark:ring-red-700{% endif %}"
              data-timer-id="{{ timer._id }}"
              data-seen="{{ 'true' if timer.seen else 'false' }}">
            <div>
              <p class="font-semibold text-gray-800 dark:text-gray-100">
                {{ timer.name }}
              </p>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                Created by {{ timer.creator_name }} &bull; Ended on <strong>{{ timer.end_date }}</strong>
              </p>
            </div>
            <div class="flex items-center gap-2 mt-2 sm:mt-0">
               <span class="text-sm font-bold bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-200 px-3 py-1 rounded-full whitespace-nowrap">
                 {{ timer.time_left }}
               </span>
               {% if timer.creator_id == current_user.id or current_user.role == 'parent' %}
                  <a href="{{ url_for('delete_timer', timer_id=timer._id) }}"
                     onclick="return confirm('Delete this timer?')"
                     class="p-1.5 text-red-500 bg-red-100 dark:bg-red-900/50 rounded-full hover:bg-red-200 dark:hover:bg-red-800 transition" title="Delete Timer">
                      <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                   </a>
               {% endif %}
            </div>
          </li>
          {% endfor %}
          </ul>
        {% else %}
          <p class="text-center py-6 text-gray-500 dark:text-gray-300">
            No expired timers.
          </p>
        {% endif %}
      </div>
    </div>
    </div>
  </section>

  {# Reward Store Management Card #}
  <section role="region" aria-labelledby="store-heading" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl collapse-section">
    <button onclick="toggleSection(this)" class="w-full flex justify-between items-center mb-4 focus:outline-none">
      <div class="flex items-center gap-4">
        <h2 id="store-heading" class="text-2xl font-bold text-gray-900 dark:text-gray-100">Manage Reward Store</h2>
      </div>
      <svg class="w-5 h-5 text-gray-500 dark:text-gray-400 transition-transform section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
      </svg>
    </button>
    <div class="section-content">
    <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
      <div></div>
      <button id="suggest-rewards-btn" class="flex-shrink-0 w-full md:w-auto flex items-center justify-center gap-2 px-5 py-2.5 text-sm font-semibold text-white bg-secondary-500 rounded-lg hover:bg-secondary-600 transition shadow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary-500 dark:focus:ring-offset-gray-800">
        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.538.921l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.783.57-1.838-.197-1.538-.921l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
        Get Reward Ideas with AI
      </button>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      {# Add New Reward Form #}
      <div class="lg:col-span-1">
        <form action="{{ url_for('add_store_reward') }}" method="POST" class="space-y-4 p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-700/30">
          <h4 class="font-semibold text-gray-800 dark:text-gray-100">Add a New Reward</h4>
            <div>
              <label for="reward-name" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Reward Name</label>
              <input type="text" name="name" id="reward-name" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500 transition">
            </div>
            <div>
              <label for="reward-cost" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Point Cost</label>
              <input type="number" name="cost" id="reward-cost" min="1" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500 transition">
            </div>
            <button type="submit" class="w-full py-2.5 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 dark:focus:ring-offset-gray-800">Add to Store</button>
        </form>
      </div>
      {# Available Rewards List #}
      <div class="lg:col-span-2">
        <h4 class="font-semibold mb-4 text-gray-800 dark:text-gray-100">Available Rewards</h4>
          <div class="max-h-96 overflow-y-auto custom-scrollbar pr-2">
            {% if available_rewards %}
              <ul class="space-y-3">
              {% for reward in available_rewards|sort(attribute='cost') %} {# Sort by cost #}
                <li class="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg flex justify-between items-center">
                  <div>
                    <p class="font-semibold text-gray-800 dark:text-gray-100">{{ reward.name }}</p>
                    <p class="text-sm text-secondary-600 dark:text-secondary-400 font-bold">{{ reward.cost }} pts</p>
                  </div>
                   {# Ensure delete confirmation works #}
                  <a href="{{ url_for('delete_store_reward', reward_id=reward._id) }}" onclick="return confirm('Are you sure you want to delete this reward [{{ reward.name }}] from the store?')" class="p-2 text-red-500 bg-red-100 dark:bg-red-900/50 rounded-full hover:bg-red-200 dark:hover:bg-red-800 transition focus:outline-none focus:ring-1 focus:ring-red-400" title="Delete Reward">
                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002 2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                  </a>
                </li>
              {% endfor %}
              </ul>
            {% else %}
              <p class="text-center py-8 text-gray-500 dark:text-gray-300">Your reward store is empty. Add a reward using the form!</p>
            {% endif %}
          </div>
      </div>
    </div>
  </section>

  {# Rules Management Card #}
  <section role="region" aria-labelledby="rules-heading" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl collapse-section">
    <button onclick="toggleSection(this)" class="w-full flex justify-between items-center mb-4 focus:outline-none">
      <div>
        <h2 id="rules-heading" class="text-2xl font-bold text-gray-900 dark:text-gray-100">Manage Family Rules</h2>
        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
          Create clear rules with consequences. Essential for neurodivergent support. (Maximum 10 rules)
        </p>
      </div>
      <svg class="w-5 h-5 text-gray-500 dark:text-gray-400 transition-transform section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
      </svg>
    </button>
    <div class="section-content">
    <div class="mb-6 flex flex-col md:flex-row justify-between md:items-center gap-4">
      <div></div>
      <button id="suggest-rules-btn" class="flex-shrink-0 w-full md:w-auto flex items-center justify-center gap-2 px-5 py-2.5 text-sm font-semibold text-white bg-secondary-500 rounded-lg hover:bg-secondary-600 transition shadow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary-500 dark:focus:ring-offset-gray-800">
        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.538.921l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.783.57-1.838-.197-1.538-.921l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
        Get Rule Ideas with AI
      </button>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      {# Add New Rule Form #}
      <div class="lg:col-span-1">
        <form action="{{ url_for('add_rule') }}" method="POST" class="space-y-4 p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-700/30">
          <h4 class="font-semibold text-gray-800 dark:text-gray-100">Add a New Rule</h4>
          <div>
            <label for="rule-name" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Rule Name</label>
            <input type="text" name="name" id="rule-name" required 
                   placeholder="e.g. No screens after 8pm"
                   class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500 transition">
          </div>
          <div>
            <label for="rule-consequence" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Consequence</label>
            <textarea name="consequence" id="rule-consequence" rows="3" required 
                      placeholder="e.g. Lose 30 minutes of screen time tomorrow"
                      class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500 transition"></textarea>
          </div>
          <button type="submit" 
                  class="w-full py-2.5 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-800 disabled:bg-gray-400 disabled:cursor-not-allowed"
                  {% if family_rules|length >= 10 %}disabled title="Maximum of 10 rules reached"{% endif %}>
            {% if family_rules|length >= 10 %}
              Maximum Reached (10/10)
            {% else %}
              Add Rule ({{ family_rules|length }}/10)
            {% endif %}
          </button>
        </form>
      </div>
      {# Rules List #}
      <div class="lg:col-span-2">
        <h4 class="font-semibold mb-4 text-gray-800 dark:text-gray-100">Family Rules</h4>
        <div class="max-h-96 overflow-y-auto custom-scrollbar pr-2">
          {% if family_rules %}
            <ul class="space-y-3">
            {% for rule in family_rules %}
              <li class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600 rule-item" data-rule-id="{{ rule._id }}" data-rule-name="{{ rule.name|escape }}" data-rule-consequence="{{ rule.consequence|escape }}">
                <div class="flex justify-between items-start gap-4">
                  <div class="flex-grow">
                    <p class="font-semibold text-gray-800 dark:text-gray-100 mb-2">{{ rule.name }}</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                      <span class="font-medium">Consequence:</span> {{ rule.consequence }}
                    </p>
                    {# AI Example Section #}
                    <div class="mt-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                      <div class="flex items-center gap-2 mb-2">
                        <svg class="w-4 h-4 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                        <span class="text-xs font-semibold text-blue-600 dark:text-blue-400">Example for kids:</span>
                        <button onclick="loadRuleExample(this)" class="ml-auto text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition flex items-center gap-1">
                          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                          </svg>
                          Refresh
                        </button>
                      </div>
                      <div class="rule-example-content text-sm text-gray-700 dark:text-gray-300">
                        <div class="flex items-center gap-2 py-2">
                          <svg class="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                          </svg>
                          <span class="text-xs text-gray-500 dark:text-gray-400">Generating example...</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="flex items-center gap-2 flex-shrink-0">
                    <button onclick="openEditRuleModal('{{ rule._id }}', '{{ rule.name|escape }}', '{{ rule.consequence|escape }}')" 
                            class="p-2 text-blue-500 bg-blue-100 dark:bg-blue-900/50 rounded-full hover:bg-blue-200 dark:hover:bg-blue-800 transition focus:outline-none focus:ring-1 focus:ring-blue-400" 
                            title="Edit Rule">
                      <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                    </button>
                    <a href="{{ url_for('delete_rule', rule_id=rule._id) }}" 
                       onclick="return confirm('Are you sure you want to delete the rule: {{ rule.name|escape }}?')" 
                       class="p-2 text-red-500 bg-red-100 dark:bg-red-900/50 rounded-full hover:bg-red-200 dark:hover:bg-red-800 transition focus:outline-none focus:ring-1 focus:ring-red-400" 
                       title="Delete Rule">
                      <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002 2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                    </a>
                  </div>
                </div>
              </li>
            {% endfor %}
            </ul>
          {% else %}
            <p class="text-center py-8 text-gray-500 dark:text-gray-300">No rules have been created yet. Add a rule using the form!</p>
          {% endif %}
        </div>
      </div>
    </div>
    </div>
  </section>

  {# Edit Rule Modal #}
  <div id="edit-rule-modal" class="fixed inset-0 z-[80] flex items-center justify-center bg-black bg-opacity-60 hidden p-4 backdrop-blur-sm">
    <div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-lg mx-auto">
      <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100">Edit Rule</h3>
        <button onclick="closeModal('edit-rule-modal')" class="p-2 rounded-full text-gray-400 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="edit-rule-form" method="POST" action="">
        <div class="p-6 space-y-4">
          <div>
            <label for="edit-rule-name" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Rule Name</label>
            <input type="text" name="name" id="edit-rule-name" required 
                   class="mt-1 block w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500 transition">
          </div>
          <div>
            <label for="edit-rule-consequence" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Consequence</label>
            <textarea name="consequence" id="edit-rule-consequence" rows="3" required 
                      class="mt-1 block w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500 transition"></textarea>
          </div>
        </div>
        <div class="px-6 pb-6 pt-2 text-right">
          <button type="button" onclick="closeModal('edit-rule-modal')" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-600 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-500 transition mr-2">Cancel</button>
          <button type="submit" class="px-6 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-500">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  {# Suggest Rules Modal #}
  <div id="suggest-rules-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 dark:bg-black dark:bg-opacity-80 z-[80] hidden flex items-center justify-center p-4">
    <div class="relative p-6 border w-full max-w-lg shadow-2xl rounded-2xl bg-white dark:bg-gray-800 dark:text-gray-100 modal-content flex flex-col" style="max-height: 90vh;">
      <div class="flex-shrink-0">
        <button onclick="closeModal('suggest-rules-modal')" class="absolute top-4 right-4 text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-gray-200 text-3xl" aria-label="Close modal">&times;</button>
        <h3 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100">AI Rule Ideas</h3>
      </div>
      <div id="suggest-rules-start">
        <p class="text-gray-600 dark:text-gray-300 mb-4">
          Tell the AI a theme for rule ideas (e.g., "screen time", "bedtime", "homework", "respect") or leave it blank for general suggestions.
        </p>
        <div class="space-y-4">
          <label for="rule-theme-input" class="sr-only">Rule Theme</label>
          <input type="text" id="rule-theme-input" class="w-full p-2 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Optional: Enter a theme...">
          <button id="generate-rule-suggestions-btn" class="w-full py-3 px-4 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-800">
            Get Suggestions
          </button>
        </div>
      </div>
      <div id="suggest-rules-loading" class="hidden text-center py-10" role="status">
        <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-gray-700 dark:text-gray-200">Generating ideas...</p>
      </div>
      <div id="suggest-rules-results" class="hidden flex flex-col flex-grow min-h-0">
        <h4 class="text-lg font-semibold mb-3 flex-shrink-0 text-gray-800 dark:text-gray-100">Suggested Rules:</h4>
        <div id="rule-suggestions-container" class="space-y-3 overflow-y-auto custom-scrollbar flex-grow pr-2 pb-2">
           {# Suggestions loaded here by JS #}
        </div>
        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 flex-shrink-0 flex justify-between">
          <button onclick="setSuggestRulesModalState('start')" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-600 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-500 transition">
            &larr; Back
          </button>
          <button onclick="closeModal('suggest-rules-modal'); window.location.reload();" class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition">
            Done
          </button>
        </div>
      </div>
    </div>
  </div>

  {# Modals specific to this page #}
  {# Suggest Rewards Modal #}
  <div id="suggest-rewards-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 dark:bg-black dark:bg-opacity-80 z-[80] hidden flex items-center justify-center p-4">
    <div class="relative p-6 border w-full max-w-lg shadow-2xl rounded-2xl bg-white dark:bg-gray-800 dark:text-gray-100 modal-content flex flex-col" style="max-height: 90vh;">
      <div class="flex-shrink-0">
        <button onclick="closeModal('suggest-rewards-modal')" class="absolute top-4 right-4 text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-gray-200 text-3xl" aria-label="Close modal">&times;</button>
        <h3 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100">AI Reward Ideas</h3>
      </div>
      <div id="suggest-rewards-start">
        <p class="text-gray-600 dark:text-gray-300 mb-4">
          Tell the AI a theme for reward ideas (e.g., "outdoor activities", "screen time", "family fun") or leave it blank for general suggestions.
        </p>
        <div class="space-y-4">
          <label for="reward-theme-input" class="sr-only">Reward Theme</label>
          <input type="text" id="reward-theme-input" class="w-full p-2 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Optional: Enter a theme...">
          <button id="generate-suggestions-btn" class="w-full py-3 px-4 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-800">
            Get Suggestions
          </button>
        </div>
      </div>
      <div id="suggest-rewards-loading" class="hidden text-center py-10" role="status">
        <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-gray-700 dark:text-gray-200">Generating ideas...</p>
      </div>
      <div id="suggest-rewards-results" class="hidden flex flex-col flex-grow min-h-0">
        <h4 class="text-lg font-semibold mb-3 flex-shrink-0 text-gray-800 dark:text-gray-100">Suggested Rewards:</h4>
        <div id="suggestions-container" class="space-y-3 overflow-y-auto custom-scrollbar flex-grow pr-2 pb-2">
           {# Suggestions loaded here by JS #}
        </div>
        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 flex-shrink-0 flex justify-between">
          <button onclick="setSuggestRewardsModalState('start')" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-600 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-500 transition">
            &larr; Back
          </button>
          {# Reloads the page to show newly added rewards in the main list #}
          <button onclick="closeModal('suggest-rewards-modal'); window.location.reload();" class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition">
            Done
          </button>
        </div>
      </div>
    </div>
  </div>

  {# Child Day View Modal #}
  <div id="child-day-modal" class="fixed inset-0 z-[80] flex items-center justify-center bg-black bg-opacity-60 hidden p-4">
    <div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-2xl mx-auto flex flex-col" style="max-height: 90vh;">
      <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
        <h3 id="child-day-modal-title" class="text-2xl font-bold text-gray-900 dark:text-gray-100">Child's Day View</h3>
        <button onclick="closeModal('child-day-modal')" class="p-2 rounded-full text-gray-400 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition" aria-label="Close modal">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div id="child-day-modal-content" class="p-6 overflow-y-auto custom-scrollbar">
          {# Content loaded dynamically by JS #}
          <div class="text-center py-10 text-gray-500 dark:text-gray-400" role="status">Loading tasks...</div>
      </div>
    </div>
  </div>

</div> {# End main space-y-8 container #}
{% endblock %}


{% block scripts %}
<script>
    // --- Collapsible Sections Logic - Define toggleSection BEFORE DOMContentLoaded ---
    window.toggleSection = function(button) {
        if (!button) {
            console.warn('toggleSection called without button');
            return;
        }
        
        const section = button.closest('.collapse-section');
        if (!section) {
            console.warn('toggleSection: button is not inside a .collapse-section', button);
            return;
        }
        
        // Try multiple ways to find the content
        let content = section.querySelector('.section-content');
        if (!content) {
            // Fallback: look for direct child div after button
            if (button.nextElementSibling && button.nextElementSibling.classList.contains('section-content')) {
                content = button.nextElementSibling;
            }
        }
        
        if (!content) {
            console.warn('toggleSection: Could not find .section-content in section', section, 'Children:', Array.from(section.children).map(c => c.tagName + '.' + c.className));
            return;
        }
        
        const icon = button.querySelector('.section-icon');
        if (!icon) {
            console.warn('toggleSection: Could not find .section-icon in button', button, 'Children:', Array.from(button.children).map(c => c.tagName + '.' + c.className));
            return;
        }
        
        // Check if collapsed by checking class, max-height, or computed style
        const isCollapsed = content.classList.contains('collapsed') || 
                           content.style.maxHeight === '0px' ||
                           (content.style.maxHeight === '' && content.classList.contains('collapsed')) ||
                           (content.style.maxHeight === '' && window.getComputedStyle(content).maxHeight === '0px');
        
        if (isCollapsed) {
            // Expand section
            // First, remove collapsed class and clear inline maxHeight to get accurate scrollHeight
            content.classList.remove('collapsed');
            content.style.maxHeight = '';
            // Force a reflow to ensure content is measured correctly
            void content.offsetHeight;
            const targetHeight = content.scrollHeight;
            // Set the target height for animation
            if (targetHeight > 0) {
                content.style.maxHeight = targetHeight + 'px';
            } else {
                // If still 0, try setting to auto temporarily to measure
                content.style.maxHeight = 'auto';
                void content.offsetHeight;
                const actualHeight = content.scrollHeight || 1000; // Fallback to 1000px if still 0
                content.style.maxHeight = '0px';
                void content.offsetHeight;
                content.style.maxHeight = actualHeight + 'px';
            }
            icon.style.transform = 'rotate(180deg)';
            // Remove max-height after transition to allow content to grow dynamically
            setTimeout(() => {
                if (!content.classList.contains('collapsed')) {
                    content.style.maxHeight = '';
                }
            }, 350);
        } else {
            // Collapse section
            const currentHeight = content.scrollHeight;
            content.style.maxHeight = currentHeight + 'px';
            // Force reflow to ensure transition works
            void content.offsetHeight;
            content.style.maxHeight = '0px';
            content.classList.add('collapsed');
            icon.style.transform = 'rotate(0deg)';
        }
    };

document.addEventListener('DOMContentLoaded', () => {

    // --- Mood Logger Logic ---
    const moodLogger = document.getElementById('mood-logger');
    const moodConfig = {{ MOOD_CONFIG.moods|tojson }}; // Get config from backend

    const getTodayDateString = () => {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    const fetchTodaysMoods = async () => {
        const todayStr = getTodayDateString();
        const periods = ['Morning', 'Afternoon', 'Evening'];
        for (const period of periods) {
            try {
                const response = await fetch(`/api/mood/personal?date=${todayStr}&period=${period}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.mood_emoji) {
                        updateMoodUI(period, data.mood_emoji, "Logged"); // Don't show success msg on load
                        // NEW: Populate note
                        const noteInput = moodLogger.querySelector(`#mood-note-${period}`);
                        if (noteInput && data.note) {
                            noteInput.value = data.note;
                        }
                    }
                } else {
                    console.warn(`Could not fetch mood for ${period}: ${response.status}`);
                }
            } catch (error) {
                console.error(`Error fetching mood for ${period}:`, error);
            }
        }
    };

    const updateMoodUI = (period, selectedEmoji, message = "Logged!", isError = false) => {
        const periodSection = moodLogger.querySelector(`.mood-period-section[data-period="${period}"]`);
        if (!periodSection) return;

        const buttons = periodSection.querySelectorAll('.mood-button');
        buttons.forEach(button => {
            const emoji = button.dataset.emoji;
            button.classList.remove('selected-mood');
            button.style.border = '2px solid transparent';
            button.style.backgroundColor = `var(--mood-color-light, #f3f4f6)`; // Reset background
            if (emoji === selectedEmoji) {
                button.classList.add('selected-mood');
                button.style.backgroundColor = `var(--mood-color, #e5e7eb)`; // Set solid background
                button.style.borderColor = 'var(--mood-color, #9ca3af)';
            }
        });

        // Update status text
        const statusEl = periodSection.querySelector('.status-text');
        if(statusEl) {
            statusEl.textContent = message;
            statusEl.className = `text-xs text-center mt-2 ${isError ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}`;
            // Clear status after a few seconds unless it's an error or just "Logged" on load
             if (!isError && message !== "Logged") {
                setTimeout(() => { if (statusEl.textContent === message) statusEl.textContent = ''; }, 2500);
            }
        }
    };


    // MODIFIED: Added note and successMessage parameters
    const logMood = async (period, emoji, note = null, successMessage = "Mood logged! ‚úÖ") => {
        const todayStr = getTodayDateString();
        
        // If note isn't passed directly (from blur event), get it from the input
        const noteToSave = note !== null ? note : (moodLogger.querySelector(`#mood-note-${period}`)?.value || '');

        try {
            const response = await fetch('/api/mood/log', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    date: todayStr,
                    period: period,
                    emoji: emoji,
                    note: noteToSave // Use the resolved note
                })
            });
            if (response.ok) {
                const data = await response.json();
                if (data.status === 'success') {
                    updateMoodUI(period, emoji, successMessage); // Use the custom success message
                } else {
                    throw new Error(data.message || 'Failed to log mood.');
                }
            } else {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `Server error: ${response.status}`);
            }
        } catch (error) {
            console.error('Error logging mood:', error);
            updateMoodUI(period, null, `Error: ${error.message}`, true); // Show error in UI
        }
    };

    if (moodLogger) {
        // Emoji click listener
        moodLogger.addEventListener('click', (event) => {
            const button = event.target.closest('.mood-button');
            if (button) {
                const periodSection = button.closest('.mood-period-section');
                const period = periodSection.dataset.period;
                const emoji = button.dataset.emoji;
                
                // Get note from input when emoji is clicked
                const note = periodSection.querySelector('.mood-note-input')?.value || '';

                // Visually provide instant feedback before API call
                updateMoodUI(period, emoji, "Saving..."); // Show saving state briefly

                logMood(period, emoji, note, "Mood logged! ‚úÖ"); // Pass the note
            }
        });

        // NEW: Note input blur listener
        moodLogger.addEventListener('blur', (event) => {
            const input = event.target.closest('.mood-note-input');
            if (input) {
                const period = input.dataset.period;
                const periodSection = input.closest('.mood-period-section');
                const selectedButton = periodSection.querySelector('.mood-button.selected-mood');
                
                // Only save the note if an emoji is *already* selected
                if (selectedButton) {
                    const emoji = selectedButton.dataset.emoji;
                    const note = input.value;
                    
                    const statusEl = periodSection.querySelector('.status-text');
                    if(statusEl) {
                        statusEl.textContent = "Saving note...";
                        statusEl.className = 'text-xs text-center mt-2 text-gray-500 dark:text-gray-400'; // Neutral saving text
                    }
                    
                    // Call logMood with the note and a specific success message
                    logMood(period, emoji, note, "Note saved! ‚úÖ"); 
                }
            }
        }, true); // Use capture phase

        // Fetch moods when the page loads
        fetchTodaysMoods();
    }
    // --- END Mood Logger Logic ---

    // --- NEW: Mobile Tab Logic for Parent Dashboard ---
    const actionsBtn = document.getElementById('tab-actions-btn');
    const familyBtn = document.getElementById('tab-family-btn');
    const actionsContent = document.getElementById('tab-actions-content');
    const familyContent = document.getElementById('tab-family-content');

    if (actionsBtn && familyBtn && actionsContent && familyContent) {
        actionsBtn.addEventListener('click', () => {
            // Show Actions
            actionsContent.classList.remove('hidden');
            familyContent.classList.add('hidden');
            // Style Actions button
            actionsBtn.classList.add('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
            actionsBtn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'dark:text-gray-400', 'dark:hover:text-gray-300', 'dark:hover:border-gray-600');
            actionsBtn.setAttribute('aria-current', 'page');
            // Style Family button
            familyBtn.classList.remove('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
            familyBtn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'dark:text-gray-400', 'dark:hover:text-gray-300', 'dark:hover:border-gray-600');
            familyBtn.removeAttribute('aria-current');
        });

        familyBtn.addEventListener('click', () => {
            // Show Family
            familyContent.classList.remove('hidden');
            actionsContent.classList.add('hidden');
            // Style Family button
            familyBtn.classList.add('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
            familyBtn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'dark:text-gray-400', 'dark:hover:text-gray-300', 'dark:hover:border-gray-600');
            familyBtn.setAttribute('aria-current', 'page');
            // Style Actions button
            actionsBtn.classList.remove('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
            actionsBtn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'dark:text-gray-400', 'dark:hover:text-gray-300', 'dark:hover:border-gray-600');
            actionsBtn.removeAttribute('aria-current');
        });
    }
    // --- END Mobile Tab Logic ---

    // --- Timer Tab Logic ---
    const timerTabButtons = document.querySelectorAll('.timer-tab-btn');
    const timerTabPanels = document.querySelectorAll('.timer-tab-panel');
    
    if (timerTabButtons.length > 0 && timerTabPanels.length > 0) {
        timerTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.getAttribute('data-timer-tab');
                
                // Hide all panels
                timerTabPanels.forEach(panel => panel.classList.add('hidden'));
                
                // Show target panel
                const targetPanel = document.getElementById(`${targetTab}-panel`);
                if (targetPanel) {
                    targetPanel.classList.remove('hidden');
                }
                
                // Update button styles
                timerTabButtons.forEach(btn => {
                    btn.classList.remove('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
                    btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'dark:text-gray-400', 'dark:hover:text-gray-300', 'dark:hover:border-gray-600');
                });
                
                button.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'dark:text-gray-400', 'dark:hover:text-gray-300', 'dark:hover:border-gray-600');
                button.classList.add('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
                
                // Mark expired timers as seen when viewing expired tab
                if (targetTab === 'expired-timers') {
                    const expiredTimersPanel = document.getElementById('expired-timers-panel');
                    if (expiredTimersPanel) {
                        const unseenTimers = expiredTimersPanel.querySelectorAll('li[data-seen="false"]');
                        if (unseenTimers.length > 0) {
                            const timerIds = Array.from(unseenTimers).map(li => li.getAttribute('data-timer-id'));
                            
                            fetch('{{ url_for("mark_timers_seen") }}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ timer_ids: timerIds })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // Remove the red ring from unseen timers
                                    unseenTimers.forEach(li => {
                                        li.classList.remove('ring-2', 'ring-red-300', 'dark:ring-red-700');
                                        li.setAttribute('data-seen', 'true');
                                    });
                                    
                                    // Update badge count
                                    const badge = button.querySelector('span');
                                    if (badge) {
                                        const currentCount = parseInt(badge.textContent) || 0;
                                        const newCount = Math.max(0, currentCount - data.count);
                                        if (newCount > 0) {
                                            badge.textContent = newCount;
                                        } else {
                                            badge.remove();
                                        }
                                    }
                                }
                            })
                            .catch(error => console.error('Error marking timers as seen:', error));
                        }
                    }
                }
            });
        });
    }
    // --- END Timer Tab Logic ---

    // --- Child Day View Modal Logic ---
    window.openChildDayView = async (childId, childName) => {
        const modal = document.getElementById('child-day-modal');
        const titleEl = document.getElementById('child-day-modal-title');
        const contentEl = document.getElementById('child-day-modal-content');

        if (!modal || !titleEl || !contentEl) {
            console.error("Child day view modal elements not found.");
            return;
        }

        // Set loading state and open modal
        titleEl.textContent = `${childName}'s Tasks for Today`;
        contentEl.innerHTML = `
            <div class="flex justify-center items-center py-10" role="status">
              <svg class="animate-spin h-6 w-6 text-blue-500 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"> <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle> <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path> </svg>
              <span>Loading tasks...</span>
            </div>`;
        openModal('child-day-modal');

        try {
            const response = await fetch(`/api/child-day/${childId}`);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || `Failed to load tasks (Status: ${response.status})`);
            }
            const data = await response.json();

            // Build the HTML to render
            let html = '';

            // 1. Overdue Events
            if (data.overdue_events && data.overdue_events.length > 0) {
                html += '<h4 class="text-lg font-bold text-red-600 dark:text-red-400 mb-2">Overdue Tasks</h4>';
                html += '<ul class="space-y-2 mb-6">';
                data.overdue_events.forEach(task => {
                    html += `
                        <li class="p-3 bg-red-50 dark:bg-red-900/30 rounded-lg flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-gray-800 dark:text-gray-100">${task.name}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                    Was due: ${new Date(task.due_date).toLocaleDateString()}
                                    <span class="font-bold text-red-600 dark:text-red-400 ml-2">${task.points} pts</span>
                                </p>
                            </div>
                            <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300">Overdue</span>
                        </li>
                    `;
                });
                html += '</ul>';
            }

            // 2. Today's Events
            html += '<h4 class="text-lg font-bold text-gray-800 dark:text-gray-100 mb-2">Today\'s Tasks</h4>';
            if (data.todays_events && data.todays_events.length > 0) {
                html += '<ul class="space-y-2">';
                data.todays_events.forEach(task => {
                    let statusHtml = '';
                    let bgColor = 'bg-gray-50 dark:bg-gray-700/50'; // Default

                    switch(task.status) {
                        case 'assigned':
                            if(task.type === 'habit') {
                                statusHtml = task.can_checkin ?
                                    '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">Pending Check-in</span>' :
                                    '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">Done Today</span>';
                                bgColor = task.can_checkin ? 'bg-blue-50 dark:bg-blue-900/30' : 'bg-green-50 dark:bg-green-900/30';
                            } else {
                                statusHtml = '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-gray-200">Assigned</span>';
                            }
                            break;
                        case 'completed':
                            statusHtml = '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300">Pending Approval</span>';
                            bgColor = 'bg-purple-50 dark:bg-purple-900/30';
                            break;
                        case 'approved':
                            statusHtml = '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">Approved</span>';
                            bgColor = 'bg-green-50 dark:bg-green-900/30';
                            break;
                        case 'missed':
                            statusHtml = '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-300">Missed</span>';
                            bgColor = 'bg-orange-50 dark:bg-orange-900/30';
                            break;
                        case 'forgiven':
                             statusHtml = '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-200">Forgiven</span>';
                             bgColor = 'bg-gray-100 dark:bg-gray-700/50';
                             break;
                    }

                    html += `
                        <li class="p-3 ${bgColor} rounded-lg flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-gray-800 dark:text-gray-100">${task.name}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                    Type: ${task.type === 'habit' ? 'Habit' : 'Chore'}
                                    <span class="font-bold text-blue-600 dark:text-blue-400 ml-2">${task.points} pts</span>
                                    ${task.type === 'habit' ? `<span class="ml-2 font-medium text-purple-600 dark:text-purple-400">üî• ${task.streak || 0}</span>` : ''}
                                </p>
                            </div>
                            <div class="flex-shrink-0 ml-2">
                                ${statusHtml}
                            </div>
                        </li>
                    `;
                });
                html += '</ul>';
            } else {
                 html += '<p class="text-center py-8 text-gray-500 dark:text-gray-400">No tasks scheduled for today.</p>';
            }

            contentEl.innerHTML = html;

        } catch (error) {
            console.error("Error fetching child day view:", error);
            contentEl.innerHTML = `<p class="text-center text-red-500 dark:text-red-400 py-10">Error: ${error.message}</p>`;
        }
    };
    // --- END Child Day View ---


    // --- Approve All Button Logic ---
    const approveAllBtn = document.getElementById('approve-all-btn');
    if (approveAllBtn) {
        approveAllBtn.addEventListener('click', async () => {
            const pendingItems = document.querySelectorAll('.pending-event-item');
            const eventIds = Array.from(pendingItems).map(item => item.dataset.eventId).filter(id => id); // Filter out potential undefined ids

            if (eventIds.length === 0) {
                console.log("No items to approve.");
                return;
            }
            approveAllBtn.disabled = true;
            approveAllBtn.textContent = 'Approving...';

            try {
                const response = await fetch('/event/bulk_approve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ event_ids: eventIds })
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Approval request failed.');
                }
                
                // Dynamically update UI
                pendingItems.forEach(item => item.remove());
                const countHeader = approveAllBtn.previousElementSibling; // h3
                 if (countHeader && countHeader.textContent.includes('Pending Approvals')) {
                    countHeader.textContent = 'Pending Approvals (0)';
                 }
                approveAllBtn.remove(); // Remove the button itself
                 document.getElementById('pending-approvals-container').innerHTML = '<p class="text-center py-8 text-gray-500 dark:text-gray-400">All tasks approved!</p>';

                // Add a success message banner
                 const mainContent = document.querySelector('main > div.fade-in'); // Target the .fade-in wrapper
                 if(mainContent) {
                    const successBanner = document.createElement('div');
                    successBanner.className = 'p-4 mb-6 text-sm rounded-lg shadow-md bg-green-100 text-green-800 border border-green-200 dark:bg-green-900/50 dark:text-green-300 dark:border-green-700';
                    successBanner.textContent = 'All pending tasks approved!';
                    successBanner.role = 'alert';
                    mainContent.insertBefore(successBanner, mainContent.firstChild);
                    setTimeout(() => successBanner.remove(), 3000);
                 }


            } catch (error) {
                console.error('Bulk approval error:', error);
                approveAllBtn.textContent = 'Error!';
                approveAllBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                setTimeout(() => {
                    approveAllBtn.disabled = false;
                    approveAllBtn.textContent = 'Approve All';
                    approveAllBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                }, 3000);
            }
        });
    }

    // --- AI Reward Suggestion Logic ---
    const suggestRewardsBtn = document.getElementById('suggest-rewards-btn');
    if (suggestRewardsBtn) {
        suggestRewardsBtn.addEventListener('click', () => {
             document.getElementById('reward-theme-input').value = '';
             setSuggestRewardsModalState('start');
             openModal('suggest-rewards-modal');
        });
    }

    const generateSuggestionsBtn = document.getElementById('generate-suggestions-btn');
    if(generateSuggestionsBtn) {
        const handleGenerateSuggestions = async () => {
            setSuggestRewardsModalState('loading');
            const themeInput = document.getElementById('reward-theme-input');
            const theme = themeInput ? themeInput.value.trim() : '';
            const suggestionsContainer = document.getElementById('suggestions-container');
            if (!suggestionsContainer) return;
            suggestionsContainer.innerHTML = '';

            try {
                const response = await fetch('/api/reward/suggest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ theme: theme || null })
                });
                 if (!response.ok) {
                     const errorData = await response.json().catch(() => ({}));
                     throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                 }
                const data = await response.json();

                if (data.suggested_rewards && data.suggested_rewards.length > 0) {
                    data.suggested_rewards.forEach(reward => {
                        if (!reward.name || typeof reward.cost !== 'number') {
                             console.warn("Skipping invalid reward suggestion:", reward);
                             return;
                        }
                        const rewardEl = document.createElement('div');
                        rewardEl.className = 'p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg flex justify-between items-center gap-2';
                        const sanitizedName = String(reward.name).replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        rewardEl.innerHTML = `
                            <div class="min-w-0">
                                <p class="font-semibold text-gray-800 dark:text-gray-100 truncate" title="${sanitizedName}">${reward.name}</p>
                                <p class="text-sm text-secondary-600 dark:text-secondary-400 font-bold">${reward.cost} pts</p>
                            </div>
                            <button onclick="addSuggestedReward(this, '${sanitizedName}', ${reward.cost})" class="flex-shrink-0 px-3 py-1.5 text-xs font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 transition focus:outline-none focus:ring-1 focus:ring-green-400">
                                Add to Store
                            </button>
                        `;
                        suggestionsContainer.appendChild(rewardEl);
                    });
                } else {
                    suggestionsContainer.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-4">The AI could not generate suggestions based on that theme. Try being more general or specific.</p>';
                }
                setSuggestRewardsModalState('results');
            } catch (error) {
                console.error("Error generating reward suggestions:", error);
                 const errorContainer = document.getElementById('suggest-rewards-start');
                 if (errorContainer) {
                      errorContainer.innerHTML = `
                      <p class="text-red-500 dark:text-red-400 p-4 bg-red-100 dark:bg-red-900/50 rounded-md mb-4">Error: ${error.message}</p>
                      <label for="reward-theme-input-retry" class="sr-only">Reward Theme</label>
                      <input type="text" id="reward-theme-input-retry" class="w-full p-2 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Optional: Enter a theme..." value="${theme}">
                      <button id="generate-suggestions-btn-retry" class="mt-4 w-full py-3 px-4 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition">Try Again</button>`;
                      
                      // Re-add event listener and theme input id
                      document.getElementById('reward-theme-input-retry').id = 'reward-theme-input';
                      const retryBtn = document.getElementById('generate-suggestions-btn-retry');
                      if(retryBtn) {
                          retryBtn.id = 'generate-suggestions-btn';
                          retryBtn.addEventListener('click', handleGenerateSuggestions);
                      }
                     setSuggestRewardsModalState('start');
                 } else {
                      closeModal('suggest-rewards-modal');
                 }
            }
        };
        generateSuggestionsBtn.addEventListener('click', handleGenerateSuggestions);
    } 

    window.setSuggestRewardsModalState = function(state) {
      const states = ['start', 'loading', 'results'];
      states.forEach(s => {
          const el = document.getElementById(`suggest-rewards-${s}`);
          if (el) el.classList.add('hidden');
      });
      const activeEl = document.getElementById(`suggest-rewards-${state}`);
      if (activeEl) activeEl.classList.remove('hidden');
    }

    // --- Edit Rule Modal Logic ---
    window.openEditRuleModal = function(ruleId, ruleName, ruleConsequence) {
        const form = document.getElementById('edit-rule-form');
        if (!form) {
            console.error("edit-rule-form not found on this page.");
            return;
        }
        form.action = `/rule/edit/${ruleId}`;
        const nameInput = document.getElementById('edit-rule-name');
        const consequenceInput = document.getElementById('edit-rule-consequence');
        
        if (nameInput) nameInput.value = ruleName || '';
        if (consequenceInput) consequenceInput.value = ruleConsequence || '';
        
        openModal('edit-rule-modal');
    };
    // --- END Edit Rule Modal Logic ---

    // --- AI Rule Suggestion Logic ---
    const suggestRulesBtn = document.getElementById('suggest-rules-btn');
    if (suggestRulesBtn) {
        suggestRulesBtn.addEventListener('click', () => {
             document.getElementById('rule-theme-input').value = '';
             setSuggestRulesModalState('start');
             openModal('suggest-rules-modal');
        });
    }

    const generateRuleSuggestionsBtn = document.getElementById('generate-rule-suggestions-btn');
    if(generateRuleSuggestionsBtn) {
        const handleGenerateRuleSuggestions = async () => {
            setSuggestRulesModalState('loading');
            const themeInput = document.getElementById('rule-theme-input');
            const theme = themeInput ? themeInput.value.trim() : '';
            const suggestionsContainer = document.getElementById('rule-suggestions-container');
            if (!suggestionsContainer) return;
            suggestionsContainer.innerHTML = '';

            try {
                const response = await fetch('/api/rule/suggest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ theme: theme || null })
                });
                 if (!response.ok) {
                     const errorData = await response.json().catch(() => ({}));
                     throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                 }
                const data = await response.json();

                if (data.suggested_rules && data.suggested_rules.length > 0) {
                    data.suggested_rules.forEach(rule => {
                        if (!rule.name || !rule.consequence) {
                             console.warn("Skipping invalid rule suggestion:", rule);
                             return;
                        }
                        const ruleEl = document.createElement('div');
                        ruleEl.className = 'p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600';
                        const sanitizedName = String(rule.name).replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        const sanitizedConsequence = String(rule.consequence).replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        ruleEl.innerHTML = `
                            <div class="mb-3">
                                <p class="font-semibold text-gray-800 dark:text-gray-100 mb-1">${rule.name}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">
                                    <span class="font-medium text-red-600 dark:text-red-400">Consequence:</span> 
                                    <span class="ml-1">${rule.consequence}</span>
                                </p>
                            </div>
                            <button onclick="addSuggestedRule(this, '${sanitizedName}', '${sanitizedConsequence}')" class="w-full px-3 py-2 text-xs font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 transition focus:outline-none focus:ring-1 focus:ring-green-400">
                                Add Rule
                            </button>
                        `;
                        suggestionsContainer.appendChild(ruleEl);
                    });
                } else {
                    suggestionsContainer.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-4">The AI could not generate suggestions based on that theme. Try being more general or specific.</p>';
                }
                setSuggestRulesModalState('results');
            } catch (error) {
                console.error("Error generating rule suggestions:", error);
                 const errorContainer = document.getElementById('suggest-rules-start');
                 if (errorContainer) {
                      errorContainer.innerHTML = `
                      <p class="text-red-500 dark:text-red-400 p-4 bg-red-100 dark:bg-red-900/50 rounded-md mb-4">Error: ${error.message}</p>
                      <label for="rule-theme-input-retry" class="sr-only">Rule Theme</label>
                      <input type="text" id="rule-theme-input-retry" class="w-full p-2 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Optional: Enter a theme..." value="${theme}">
                      <button id="generate-rule-suggestions-btn-retry" class="mt-4 w-full py-3 px-4 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition">Try Again</button>`;
                      
                      // Re-add event listener and theme input id
                      document.getElementById('rule-theme-input-retry').id = 'rule-theme-input';
                      const retryBtn = document.getElementById('generate-rule-suggestions-btn-retry');
                      if(retryBtn) {
                          retryBtn.id = 'generate-rule-suggestions-btn';
                          retryBtn.addEventListener('click', handleGenerateRuleSuggestions);
                      }
                     setSuggestRulesModalState('start');
                 } else {
                      closeModal('suggest-rules-modal');
                 }
            }
        };
        generateRuleSuggestionsBtn.addEventListener('click', handleGenerateRuleSuggestions);
    } 

    window.setSuggestRulesModalState = function(state) {
      const states = ['start', 'loading', 'results'];
      states.forEach(s => {
          const el = document.getElementById(`suggest-rules-${s}`);
          if (el) el.classList.add('hidden');
      });
      const activeEl = document.getElementById(`suggest-rules-${state}`);
      if (activeEl) activeEl.classList.remove('hidden');
    }

    window.addSuggestedRule = async function(button, name, consequence) {
      const originalText = button.innerHTML;
      button.disabled = true;
      button.innerHTML = 'Adding...';

      try {
          const response = await fetch("{{ url_for('add_rule') }}", {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/x-www-form-urlencoded', 
              },
              body: new URLSearchParams({ 
                  'name': name,
                  'consequence': consequence
              })
          });

          if (!response.ok) {
               let errorMessage = 'Failed to add the rule.';
               try {
                   const errorData = await response.json();
                   errorMessage = errorData.error || errorMessage;
               } catch (e) {
                   const text = await response.text();
                   if (text.includes("already exists") || text.includes("Maximum")) {
                       errorMessage = "Maximum of 10 rules allowed or rule already exists.";
                   }
               }
               throw new Error(errorMessage);
          }

          button.innerHTML = 'Added!';
          button.classList.remove('bg-green-600', 'hover:bg-green-700');
          button.classList.add('bg-gray-400', 'cursor-not-allowed', 'dark:bg-gray-600');

      } catch (error) {
          console.error('Error adding suggested rule:', error);
          button.innerHTML = 'Error';
           button.classList.remove('bg-green-600', 'hover:bg-green-700');
           button.classList.add('bg-red-600', 'hover:bg-red-700');
          setTimeout(() => {
              button.innerHTML = originalText;
               button.classList.remove('bg-red-600', 'hover:bg-red-700');
               button.classList.add('bg-green-600', 'hover:bg-green-700');
              button.disabled = false;
          }, 2500);
      }
    }
    // --- END AI Rule Suggestion Logic ---

    window.addSuggestedReward = async function(button, name, cost) {
      const originalText = button.innerHTML;
      button.disabled = true;
      button.innerHTML = 'Adding...';

      try {
          const response = await fetch("{{ url_for('add_store_reward') }}", {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/x-www-form-urlencoded', 
              },
              body: new URLSearchParams({ 
                  'name': name,
                  'cost': cost
              })
          });

          if (!response.ok) {
               let errorMessage = 'Failed to add the reward.';
               try {
                   const errorData = await response.json();
                   errorMessage = errorData.error || errorMessage;
               } catch (e) {
                   const text = await response.text();
                   if (text.includes("already exists")) {
                       errorMessage = "This reward might already exist.";
                   }
               }
               throw new Error(errorMessage);
          }

          button.innerHTML = 'Added!';
          button.classList.remove('bg-green-600', 'hover:bg-green-700');
          button.classList.add('bg-gray-400', 'cursor-not-allowed', 'dark:bg-gray-600');

      } catch (error) {
          console.error('Error adding suggested reward:', error);
          button.innerHTML = 'Error';
           button.classList.remove('bg-green-600', 'hover:bg-green-700');
           button.classList.add('bg-red-600', 'hover:bg-red-700');
          setTimeout(() => {
              button.innerHTML = originalText;
               button.classList.remove('bg-red-600', 'hover:bg-red-700');
               button.classList.add('bg-green-600', 'hover:bg-green-700');
              button.disabled = false;
          }, 2500);
      }
    }


    // --- Collapsible Sections Logic - Initialize all sections (toggleSection is defined above) ---
    // Initialize all sections as collapsed by default (except first one)
    document.querySelectorAll('.collapse-section').forEach((section, index) => {
        // Try multiple ways to find the content
        let content = section.querySelector('.section-content');
        if (!content) {
            // Fallback: look for direct child div after button
            const button = section.querySelector('button[onclick*="toggleSection"]');
            if (button && button.nextElementSibling && button.nextElementSibling.classList.contains('section-content')) {
                content = button.nextElementSibling;
            }
        }
        
        if (!content) {
            console.warn('No .section-content found in collapse-section', section, 'Children:', Array.from(section.children).map(c => c.tagName + '.' + c.className));
            return;
        }
        
        const button = section.querySelector('button[onclick*="toggleSection"]');
        if (!button) {
            console.warn('No toggle button found in collapse-section', section);
            return;
        }
        
        const icon = button.querySelector('.section-icon');
        if (!icon) {
            console.warn('No .section-icon found in toggle button', button, 'Children:', Array.from(button.children).map(c => c.tagName + '.' + c.className));
            return;
        }
        
        if (index > 0) {
            // Keep first section (mood logger) open, collapse others
            content.style.maxHeight = '0px';
            content.classList.add('collapsed');
            icon.style.transform = 'rotate(0deg)';
        } else {
            // First section is open
            content.style.maxHeight = 'none';
            content.classList.remove('collapsed');
            icon.style.transform = 'rotate(180deg)';
        }
    });
    // --- END Collapsible Sections Logic ---

    // --- AI Rule Examples Logic ---
    async function loadRuleExample(button) {
        const ruleItem = button.closest('.rule-item');
        if (!ruleItem) return;
        
        const ruleName = ruleItem.dataset.ruleName;
        const ruleConsequence = ruleItem.dataset.ruleConsequence;
        const exampleContent = ruleItem.querySelector('.rule-example-content');
        
        if (!ruleName || !ruleConsequence || !exampleContent) return;
        
        // Show loading state
        exampleContent.innerHTML = `
            <div class="flex items-center gap-2 py-2">
                <svg class="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-xs text-gray-500 dark:text-gray-400">Generating example...</span>
            </div>
        `;
        
        try {
            const response = await fetch('/api/rule/example', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    rule_name: ruleName,
                    consequence: ruleConsequence
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || 'Failed to generate example');
            }
            
            const data = await response.json();
            
            if (data.example) {
                exampleContent.innerHTML = `
                    <p class="text-sm leading-relaxed text-gray-700 dark:text-gray-300 italic">"${data.example}"</p>
                `;
            } else {
                throw new Error('No example in response');
            }
        } catch (error) {
            console.error('Error loading rule example:', error);
            exampleContent.innerHTML = `
                <p class="text-xs text-red-500 dark:text-red-400">Could not load example. Please try again.</p>
            `;
        }
    }
    
    // Auto-load examples for all rules when page loads (staggered to avoid overwhelming API)
    const ruleItems = document.querySelectorAll('.rule-item');
    ruleItems.forEach((ruleItem, index) => {
        setTimeout(() => {
            const refreshButton = ruleItem.querySelector('button[onclick="loadRuleExample(this)"]');
            if (refreshButton) {
                loadRuleExample(refreshButton);
            }
        }, index * 200); // 200ms delay between each request
    });
    
    // Make loadRuleExample available globally for the onclick handler
    window.loadRuleExample = loadRuleExample;
    // --- END AI Rule Examples Logic ---

}); // End DOMContentLoaded
</script>
{% endblock %}