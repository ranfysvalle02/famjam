{% extends "base.html" %}

{% block title %}My Day - FAMJAM{% endblock %}

{% block content %}
<div class="space-y-8">

  {# Welcome Banner & Points #}
  <section role="banner" class="relative bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl shadow-xl p-8 text-white overflow-hidden" style="min-height: 15rem;">
    <div class="relative z-10">
      <h1 class="text-4xl font-bold">Welcome, {{ current_user.username }}! üëã</h1>
      <p class="mt-2 text-lg text-blue-100 dark:text-blue-200">Here's what's on your plate for today.</p>
    </div>
    <div class="absolute top-0 right-0 z-10 p-6 text-right space-y-2">
      {# Points Display #}
      <div>
          <p class="text-sm font-medium text-blue-100 dark:text-blue-200">My Points ‚ú®</p>
          <p class="text-4xl font-extrabold tracking-tight">{{ current_user.points }}</p>
      </div>
      {# Cash Balance Display #}
      <div>
          <p class="text-sm font-medium text-green-100 dark:text-green-200">My Balance üí∞</p>
          <p class="text-4xl font-extrabold tracking-tight">${{ "%.2f"|format(current_user.cash_balance|default(0.0)) }}</p>
      </div>
  </div>
    {# Decorative elements #}
    <div class="absolute -bottom-12 -right-12 w-48 h-48 bg-white/10 rounded-full opacity-50" aria-hidden="true"></div>
    <div class="absolute -bottom-4 -left-16 w-32 h-32 bg-white/10 rounded-full opacity-50" aria-hidden="true"></div>
  </section>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

    {# Left/Main Column: Progress, Today's Focus #}
    <main class="lg:col-span-2 space-y-8">

      {# Today's Progress Bar #}
      {% set total_tasks = todays_events|length %}
      {% set completed_tasks = todays_events|selectattr('status', 'in', ['completed', 'approved'])|list|length + todays_events|selectattr('type', 'equalto', 'habit')|rejectattr('can_checkin')|list|length %}
      {% set progress_percent = (completed_tasks / total_tasks * 100)|round|int if total_tasks > 0 else 100 %}
      <section role="region" aria-labelledby="progress-heading" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl">
        <div class="flex justify-between items-center mb-3">
             <h3 id="progress-heading" class="font-bold text-xl text-gray-900 dark:text-gray-100">Today's Progress</h3>
             <span class="font-semibold text-gray-700 dark:text-gray-200">{{ completed_tasks }}/{{ total_tasks }} Done</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-4 dark:bg-gray-700 overflow-hidden"
             role="progressbar" aria-valuenow="{{ progress_percent }}" aria-valuemin="0" aria-valuemax="100" aria-labelledby="progress-heading">
          <div class="bg-green-500 h-4 rounded-full transition-all duration-500 ease-out" style="width: {{ progress_percent }}%"></div>
        </div>
      </section>

      {# Today's Focus List #}
      <section role="region" aria-labelledby="focus-heading" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl">
        <h2 id="focus-heading" class="text-2xl font-bold mb-6 flex items-center gap-3 text-gray-900 dark:text-gray-100">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
          Today's Focus
        </h2>
        <div class="space-y-4">
          {% if todays_events %}
            <ul class="space-y-4">
            {% for event in todays_events %}
              {# Chore Card #}
              {% if event.type == 'chore' %}
              <li class="p-4 bg-gray-50 dark:bg-gray-700/50 border-l-4 rounded-r-lg flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4
              {% if event.status == 'approved' or event.status == 'completed' %} border-green-500
              {% elif event.status == 'missed' %} border-red-500
              {% elif event.status == 'forgiven' %} border-gray-400 dark:border-gray-500
              {% else %} border-blue-500 {% endif %}">
                <div class="flex items-start gap-4 flex-1">
                  <div class="text-purple-500 mt-1 flex-shrink-0" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg></div>
                  <div class="flex-1 min-w-0">
                     <h3 class="font-bold text-lg text-gray-800 dark:text-gray-100 break-words {% if event.status == 'approved' or event.status == 'missed' or event.status == 'forgiven' %}line-through opacity-70{% endif %}">{{ event.name }}</h3>
                     {% if event.description %}
                     <p class="text-sm text-gray-600 dark:text-gray-300 mt-1 break-words {% if event.status == 'approved' or event.status == 'missed' or event.status == 'forgiven' %}line-through opacity-70{% endif %}">{{ event.description }}</p>
                     {% endif %}
                     <div class="mt-2 text-sm font-bold text-purple-600 dark:text-purple-300 bg-purple-100 dark:bg-purple-900 px-2 py-0.5 rounded-full inline-block {% if event.status == 'approved' or event.status == 'missed' or event.status == 'forgiven' %}opacity-70{% endif %}">+{{ event.points }} pts</div>
                  </div>
                </div>
                <div class="w-full sm:w-auto flex justify-end flex-shrink-0">
                  {% if event.status == 'assigned' %}
                    <a href="{{ url_for('complete_event', event_id=event._id) }}" class="w-full sm:w-auto flex justify-center items-center gap-2 px-5 py-2.5 text-sm font-semibold text-white bg-blue-500 rounded-lg hover:bg-blue-600 transition shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-800">Mark as Done</a>
                  {% elif event.status == 'completed' %}
                    <span class="flex items-center justify-center gap-2 w-full sm:w-auto px-5 py-2.5 text-sm font-semibold text-indigo-800 dark:text-indigo-300 bg-indigo-100 dark:bg-indigo-900 rounded-lg cursor-default">Awaiting Approval</span>
                  {% elif event.status == 'approved' %}
                    <span class="flex items-center justify-center gap-2 w-full sm:w-auto px-5 py-2.5 text-sm font-semibold text-green-800 dark:text-green-300 bg-green-100 dark:bg-green-900 rounded-lg cursor-default">Approved! ‚úÖ</span>
                  {% elif event.status == 'missed' %}
                    <span class="flex items-center justify-center gap-2 w-full sm:w-auto px-5 py-2.5 text-sm font-semibold text-red-800 dark:text-red-300 bg-red-100 dark:bg-red-900 rounded-lg cursor-default">Missed ‚ùå</span>
                   {% elif event.status == 'forgiven' %}
                    <span class="flex items-center justify-center gap-2 w-full sm:w-auto px-5 py-2.5 text-sm font-semibold text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 rounded-lg cursor-default">Forgiven üòå</span>
                  {% endif %}
                </div>
              </li>
              {# Habit Card #}
              {% elif event.type == 'habit' %}
              <li class="p-4 bg-gray-50 dark:bg-gray-700/50 border-l-4 rounded-r-lg flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4
              {% if event.status == 'missed' %} border-red-500
              {% elif event.status == 'forgiven' %} border-gray-400 dark:border-gray-500
              {% elif event.can_checkin %} border-blue-500
              {% else %} border-green-500 {% endif %}">
                <div class="flex items-start gap-4 flex-1">
                   <div class="text-pink-500 mt-1 flex-shrink-0" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg></div>
                   <div class="flex-1 min-w-0">
                      <h3 class="font-bold text-lg text-gray-800 dark:text-gray-100 break-words {% if event.status == 'missed' or event.status == 'forgiven' %}line-through opacity-70{% endif %}">{{ event.name }}</h3>
                      {% if event.description %}
                      <p class="text-sm text-gray-600 dark:text-gray-300 mt-1 break-words {% if event.status == 'missed' or event.status == 'forgiven' %}line-through opacity-70{% endif %}">{{ event.description }}</p>
                      {% endif %}
                      <div class="flex items-center gap-3 mt-2 text-sm {% if event.status == 'missed' or event.status == 'forgiven' %}opacity-70{% endif %}">
                        <span class="font-bold text-green-600 dark:text-green-300 bg-green-100 dark:bg-green-900 px-2 py-0.5 rounded-full">+{{ event.points }} pts</span>
                        <span class="font-semibold text-orange-600 dark:text-orange-300 bg-orange-100 dark:bg-orange-900 px-2 py-0.5 rounded-full flex items-center gap-1">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.934l-6.75 12.25a1 1 0 001.64.905l1.852 -1.069a1 1 0 011.23.372l3.22 4.705a1 1 0 001.64-.905l-1.852 -1.069a1 1 0 01-.001-1.422l6.75 -12.25a1 1 0 00-.385-1.45z" clip-rule="evenodd"/></svg>
                          Streak: {{ event.streak|default(0) }}
                        </span>
                      </div>
                   </div>
                </div>
                <div class="w-full sm:w-auto flex justify-end flex-shrink-0">
                   {% if event.status == 'missed' %}
                    <span class="w-full sm:w-auto flex justify-center items-center gap-2 px-5 py-2.5 text-sm font-semibold text-red-800 dark:text-red-300 bg-red-100 dark:bg-red-900 rounded-lg cursor-default">Missed ‚ùå</span>
                   {% elif event.status == 'forgiven' %}
                    <span class="flex items-center justify-center gap-2 w-full sm:w-auto px-5 py-2.5 text-sm font-semibold text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 rounded-lg cursor-default">Forgiven üòå</span>
                   {% elif event.can_checkin %}
                    <a href="{{ url_for('checkin_habit', event_id=event._id) }}" class="w-full sm:w-auto flex justify-center items-center gap-2 px-5 py-2.5 text-sm font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600 transition shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 dark:focus:ring-offset-gray-800">Check-in Today üëç</a>
                   {% else %}
                    <span class="w-full sm:w-auto flex justify-center items-center gap-2 px-5 py-2.5 text-sm font-semibold text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 rounded-lg cursor-default">Done for Today! üéâ</span>
                   {% endif %}
                </div>
              </li>
              {% endif %}
            {% endfor %}
            </ul>
          {% else %}
            <div class="text-center py-12 bg-gray-50 dark:bg-gray-700/30 rounded-lg border border-gray-200 dark:border-gray-600">
               <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-10 w-10 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"> <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /> </svg>
              <p class="mt-2 text-gray-600 dark:text-gray-300 font-medium">Nothing scheduled for today. Great job!</p>
              <p class="text-sm text-gray-500 dark:text-gray-400">Enjoy your free time!</p>
            </div>
          {% endif %}
        </div>
      </section>
    </main>

    {# Right Column: Mood Logger, Reward Store, Challenges #}
    <aside class="lg:col-span-1 space-y-8" role="complementary">

      {# --- NEW: Personal Mood Logger --- #}
      <section role="region" aria-labelledby="mood-heading" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl">
        <h3 id="mood-heading" class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">How are you feeling today? üòä</h3>
        <div id="mood-logger" class="space-y-4">
          {% set periods = ['Morning', 'Afternoon', 'Evening'] %}
          {% for period in periods %}
          <div class="mood-period-section" data-period="{{ period }}">
            <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">{{ period }}</h4>
            <div class="flex justify-around items-center gap-2">
              {% for mood in MOOD_CONFIG.moods %}
              <button
                class="mood-button flex-1 p-2 rounded-lg text-3xl transition-all duration-150 ease-in-out border-2 border-transparent hover:scale-110 focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800"
                data-emoji="{{ mood.emoji }}"
                title="{{ mood.desc }}"
                style="--mood-color: {{ mood.color }}; background-color: var(--mood-color-light, #f3f4f6); --mood-color-light: {{ mood.color }}1A;"
                onmouseover="this.style.backgroundColor = 'var(--mood-color, #e5e7eb)';"
                onmouseout="if (!this.classList.contains('selected-mood')) this.style.backgroundColor = 'var(--mood-color-light, #f3f4f6)';"
                >
                {{ mood.emoji }}
              </button>
              {% endfor %}
            </div>
            {# --- NEW: OPTIONAL NOTE --- #}
            <div class="mt-2.5">
              <label for="mood-note-{{ period }}" class="sr-only">Optional note for {{ period }}</label>
              <input type="text" id="mood-note-{{ period }}" name="mood-note-{{ period }}"
                     placeholder="Add a quick note... (optional)"
                     class="mood-note-input w-full text-sm px-3 py-1.5 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 transition"
                     data-period="{{ period }}">
            </div>
             <p class="text-xs text-center mt-2 text-gray-500 dark:text-gray-400 status-text"></p> {# Status text area #}
          </div>
          {% endfor %}
        </div>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-4">Click an emoji to log your mood. You can also add an optional note.</p>
         <a href="{{ url_for('mood_dashboard_personal') }}" class="block text-center mt-4 text-sm font-medium text-blue-600 dark:text-blue-400 hover:underline">
           View Mood History &rarr;
         </a>
      </section>
      {# --- END: Personal Mood Logger --- #}


      {# Reward Store Card #}
      <section role="region" aria-labelledby="store-heading" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl">
        <h3 id="store-heading" class="text-xl font-bold mb-4 text-gray-900 dark:text-gray-100">Reward Store üéÅ</h3>
        <div class="max-h-96 overflow-y-auto custom-scrollbar pr-2">
          {% if available_rewards %}
            <ul class="space-y-3">
            {% for reward in available_rewards|sort(attribute='cost') %} {# Sort by cost #}
              <li class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <div class="flex flex-col sm:flex-row justify-between items-start gap-2">
                  <div class="flex-grow">
                    <p class="font-semibold text-gray-800 dark:text-gray-100">{{ reward.name }}</p>
                    <p class="text-sm text-yellow-600 dark:text-yellow-400 font-bold">{{ reward.cost }} pts</p>
                  </div>
                  <form action="{{ url_for('request_reward') }}" method="POST" class="w-full sm:w-auto">
                    <input type="hidden" name="reward_id" value="{{ reward._id }}">
                    <button type="submit"
                            class="w-full sm:w-auto px-4 py-2 text-sm font-semibold text-white bg-secondary-500 rounded-lg hover:bg-secondary-600 transition disabled:bg-gray-400 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-secondary-500"
                            {% if current_user.points < reward.cost %}disabled title="Not enough points"{% endif %}>
                      Redeem
                    </button>
                  </form>
                </div>
              </li>
            {% endfor %}
            </ul>
          {% else %}
            <p class="text-sm text-center py-4 text-gray-500 dark:text-gray-300">Your parents haven't added any rewards yet.</p>
          {% endif %}
        </div>
        {# Reward History Section #}
        <hr class="my-6 border-gray-200 dark:border-gray-700">
        <h4 class="text-lg font-bold mb-4 text-gray-900 dark:text-gray-100">My Reward History</h4>
        <div class="max-h-60 overflow-y-auto custom-scrollbar pr-2">
          {% if rewards %}
            <ul class="space-y-3">
            {% for reward in rewards|sort(attribute='_id', reverse=true) %} {# Show newest first #}
            <li class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
              <div>
                <p class="text-sm font-semibold pr-2 text-gray-800 dark:text-gray-100">{{ reward.reward_name }} ({{ reward.cost }} pts)</p>
                {% if reward.resolved_at_pretty %}<p class="text-xs text-gray-500 dark:text-gray-400">Resolved {{ reward.resolved_at_pretty }}</p>{% endif %}
              </div>
              <span class="flex-shrink-0 px-2.5 py-0.5 text-xs font-medium rounded-full
              {% if reward.status == 'pending' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300{% endif %}
              {% if reward.status == 'approved' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300{% endif %}
              {% if reward.status == 'denied' %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300{% endif %}">
              {{ reward.status|capitalize }}</span>
            </li>
            {% endfor %}
            </ul>
          {% else %}
            <p class="text-sm text-center py-4 text-gray-500 dark:text-gray-300">No reward history yet.</p>
          {% endif %}
        </div>
      </section>

      {# Family Challenges Card #}
       <section role="region" aria-labelledby="challenges-heading" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl">
         <h3 id="challenges-heading" class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">Family Challenges üèÜ</h3>
         <div class="max-h-96 overflow-y-auto custom-scrollbar pr-2">
           {% if challenges %}
             <ul class="space-y-3">
             {% for c in challenges %}
             <li class="p-4 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg">
               <div class="flex flex-col sm:flex-row justify-between items-start gap-2">
                 <div>
                   <p class="font-semibold text-gray-800 dark:text-gray-100">{{ c.title }}</p>
                   <p class="text-sm text-yellow-600 dark:text-yellow-400 font-semibold">{{ c.points }} pts</p>
                 </div>
                 {# Action Buttons #}
                 <div class="flex-shrink-0 w-full sm:w-auto">
                     {% if c.status == 'open' %}
                         <a href="{{ url_for('claim_challenge', challenge_id=c._id) }}" class="block sm:inline-block w-full text-center px-4 py-2 text-sm font-semibold bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition focus:outline-none focus:ring-1 focus:ring-blue-500">Claim</a>
                     {% elif c.status == 'in_progress' and c.claimed_by_id|string == current_user.id %}
                         <a href="{{ url_for('complete_challenge', challenge_id=c._id) }}" class="block sm:inline-block w-full text-center px-4 py-2 text-sm font-semibold bg-green-500 text-white rounded-lg hover:bg-green-600 transition focus:outline-none focus:ring-1 focus:ring-green-500">Mark Complete</a>
                     {% elif c.status == 'in_progress' %}
                          <span class="block sm:inline-block w-full text-center px-4 py-2 text-sm font-semibold bg-gray-300 text-gray-600 dark:bg-gray-600 dark:text-gray-300 rounded-lg cursor-not-allowed">Claimed</span>
                     {% elif c.status == 'completed' %}
                          <span class="block sm:inline-block w-full text-center px-4 py-2 text-sm font-semibold bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300 rounded-lg cursor-default">Completed</span>
                     {% endif %}
                 </div>
               </div>
               <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">{{ c.description }}</p>
               <p class="text-xs mt-3 text-gray-400 dark:text-gray-500">
                   Status: <span class="font-medium">{{ c.status|capitalize }}</span>
                   {% if c.claimer_username %}
                       &middot; Claimed by {{ c.claimer_username }}
                       {% if c.status == 'completed' and c.completed_at_pretty %} &middot; Completed {{ c.completed_at_pretty }} {% endif %}
                   {% endif %}
               </p>
             </li>
             {% endfor %}
             </ul>
           {% else %}
             <p class="text-center text-gray-500 dark:text-gray-300 py-6">No active challenges right now.</p>
           {% endif %}
         </div>
       </section>

    </aside>
  </div>

  {# Family Timers #}
  <section role="region" aria-labelledby="timers-heading" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl hover:shadow-lg transition-shadow">
    <h2 id="timers-heading" class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100">Family Timers ‚è≥</h2>
    <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">
      Everyone can create a timer to count down to a special day or event.
    </p>
    {# Add Timer Form #}
    <form method="POST" action="{{ url_for('create_timer') }}" class="flex flex-col md:flex-row gap-3 mb-6 p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-700/30">
      <div class="flex-grow">
        <label for="timer-name" class="sr-only">Timer Name</label>
        <input type="text" name="name" id="timer-name" placeholder="Timer Name (e.g. 'Vacation Day!')"
               class="w-full px-4 py-2 bg-white dark:bg-gray-700 dark:text-gray-100
                      border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" required>
      </div>
      <div>
        <label for="timer-end-date" class="sr-only">End Date</label>
        <input type="date" name="end_date" id="timer-end-date"
               class="w-full px-4 py-2 bg-white dark:bg-gray-700 dark:text-gray-100
                      border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" required
               min="{{ now.strftime('%Y-%m-%d') }}"> {# Prevent selecting past dates #}
      </div>
      <button type="submit"
              class="px-5 py-2.5 text-white bg-blue-600 hover:bg-blue-700 rounded-lg
                     transition font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-800 flex-shrink-0">
        Add Timer
      </button>
    </form>
    {# List of Timers #}
    <div class="max-h-72 overflow-y-auto custom-scrollbar pr-2">
      {% if timers %}
        <ul class="space-y-3">
        {% for timer in timers|sort(attribute='end_datetime') %} {# Sort by end date #}
        <li class="flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50
                     border border-gray-200 dark:border-gray-600 rounded-lg
                     hover:shadow-md transition-shadow gap-2">
          <div>
            <p class="font-semibold text-gray-800 dark:text-gray-100">
              {{ timer.name }}
            </p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
              Created by {{ timer.creator_name }} &bull; Ends on <strong>{{ timer.end_date }}</strong>
            </p>
          </div>
          <div class="flex items-center gap-2 mt-2 sm:mt-0">
             <span class="text-sm font-bold bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-200 px-3 py-1 rounded-full whitespace-nowrap">
               {{ timer.time_left }}
             </span>
             {# Add delete button, maybe only for creator or parents #}
             {% if timer.creator_id == current_user.id or current_user.role == 'parent' %}
                <a href="{{ url_for('delete_timer', timer_id=timer._id) }}"
                   onclick="return confirm('Delete this timer?')"
                   class="p-1.5 text-red-500 bg-red-100 dark:bg-red-900/50 rounded-full hover:bg-red-200 dark:hover:bg-red-800 transition" title="Delete Timer">
                    <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                 </a>
             {% endif %}
          </div>
        </li>
        {% endfor %}
        </ul>
      {% else %}
        <p class="text-center py-6 text-gray-500 dark:text-gray-300">
          No timers have been created yet. Add one above!
        </p>
      {% endif %}
    </div>
  </section>

</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- Mood Logger Logic ---
    const moodLogger = document.getElementById('mood-logger');
    const moodConfig = {{ MOOD_CONFIG.moods|tojson }}; // Get config from backend

    const getTodayDateString = () => {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    const fetchTodaysMoods = async () => {
        const todayStr = getTodayDateString();
        const periods = ['Morning', 'Afternoon', 'Evening'];
        for (const period of periods) {
            try {
                const response = await fetch(`/api/mood/personal?date=${todayStr}&period=${period}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.mood_emoji) {
                        updateMoodUI(period, data.mood_emoji, "Logged"); // Don't show success msg on load
                        // NEW: Populate note
                        const noteInput = moodLogger.querySelector(`#mood-note-${period}`);
                        if (noteInput && data.note) {
                            noteInput.value = data.note;
                        }
                    }
                } else {
                    console.warn(`Could not fetch mood for ${period}: ${response.status}`);
                }
            } catch (error) {
                console.error(`Error fetching mood for ${period}:`, error);
            }
        }
    };

     const updateMoodUI = (period, selectedEmoji, message = "Logged!", isError = false) => {
        const periodSection = moodLogger.querySelector(`.mood-period-section[data-period="${period}"]`);
        if (!periodSection) return;

        const buttons = periodSection.querySelectorAll('.mood-button');
        buttons.forEach(button => {
            const emoji = button.dataset.emoji;
            button.classList.remove('selected-mood');
            button.style.border = '2px solid transparent';
            button.style.backgroundColor = `var(--mood-color-light, #f3f4f6)`; // Reset background
            if (emoji === selectedEmoji) {
                button.classList.add('selected-mood');
                button.style.backgroundColor = `var(--mood-color, #e5e7eb)`; // Set solid background
                button.style.borderColor = 'var(--mood-color, #9ca3af)';
            }
        });

        // Update status text only if a message is provided (avoid clearing on initial load)
        const statusEl = periodSection.querySelector('.status-text');
         if(statusEl && message) {
            statusEl.textContent = message;
            statusEl.className = `text-xs text-center mt-2 ${isError ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}`;
            // Clear status after a few seconds unless it's an error or just "Logged" on load
             if (!isError && message !== "Logged") {
                setTimeout(() => { if (statusEl.textContent === message) statusEl.textContent = ''; }, 2500);
            }
        }
    };


    // MODIFIED: Added note and successMessage parameters
    const logMood = async (period, emoji, note = null, successMessage = "Mood logged! ‚úÖ") => {
        const todayStr = getTodayDateString();
        
        // If note isn't passed directly (from blur event), get it from the input
        const noteToSave = note !== null ? note : (moodLogger.querySelector(`#mood-note-${period}`)?.value || '');

        try {
            const response = await fetch('/api/mood/log', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    date: todayStr,
                    period: period,
                    emoji: emoji,
                    note: noteToSave // Use the resolved note
                })
            });
            if (response.ok) {
                const data = await response.json();
                if (data.status === 'success') {
                    updateMoodUI(period, emoji, successMessage); // Use the custom success message
                } else {
                    throw new Error(data.message || 'Failed to log mood.');
                }
            } else {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `Server error: ${response.status}`);
            }
        } catch (error) {
            console.error('Error logging mood:', error);
            updateMoodUI(period, null, `Error: ${error.message}`, true); // Show error in UI
        }
    };

    if (moodLogger) {
        // Emoji click listener
        moodLogger.addEventListener('click', (event) => {
            const button = event.target.closest('.mood-button');
            if (button) {
                const periodSection = button.closest('.mood-period-section');
                const period = periodSection.dataset.period;
                const emoji = button.dataset.emoji;
                
                // Get note from input when emoji is clicked
                const note = periodSection.querySelector('.mood-note-input')?.value || '';

                // Visually provide instant feedback before API call
                updateMoodUI(period, emoji, "Saving..."); // Show saving state briefly

                logMood(period, emoji, note, "Mood logged! ‚úÖ"); // Pass the note
            }
        });

        // NEW: Note input blur listener
        moodLogger.addEventListener('blur', (event) => {
            const input = event.target.closest('.mood-note-input');
            if (input) {
                const period = input.dataset.period;
                const periodSection = input.closest('.mood-period-section');
                const selectedButton = periodSection.querySelector('.mood-button.selected-mood');
                
                // Only save the note if an emoji is *already* selected
                if (selectedButton) {
                    const emoji = selectedButton.dataset.emoji;
                    const note = input.value;
                    
                    const statusEl = periodSection.querySelector('.status-text');
                    if(statusEl) {
                        statusEl.textContent = "Saving note...";
                        statusEl.className = 'text-xs text-center mt-2 text-gray-500 dark:text-gray-400'; // Neutral saving text
                    }
                    
                    // Call logMood with the note and a specific success message
                    logMood(period, emoji, note, "Note saved! ‚úÖ"); 
                }
            }
        }, true); // Use capture phase

        // Fetch moods when the page loads
        fetchTodaysMoods();
    }
    // --- END Mood Logger Logic ---

}); // End DOMContentLoaded
</script>
{% endblock %}